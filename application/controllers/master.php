<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class Master extends CI_Controller
{

    /**
     * Index Page for this controller.
     *
     * Maps to the following URL
     *        http://example.com/index.php/welcome
     *    - or -
     *        http://example.com/index.php/welcome/index
     *    - or -
     * Since this controller is set as the default controller in
     * config/routes.php, it's displayed at http://example.com/
     *
     * So any other public methods not prefixed with an underscore will
     * map to /index.php/welcome/<method_name>
     * @see https://codeigniter.com/user_guide/general/urls.html
     */
    protected $data;

    public function __construct()
    {
        parent::__construct();
        $this->load->helper('utility_helper');
        $this->load->helper('cookie');
        $this->load->library('WAY2SMSClient', "sms");
        no_cache();

        $this->load->model('master_db');
        $this->load->model('home_db');
        $this->data['detail'] = '';
        $cookie = get_cookie('bl_CBMSAdmin');

        if (!$this->session->userdata('BMSAdmin') && $cookie == "") {
            redirect('dutylogin', 'refresh');
        } else {
            if ($this->session->userdata('BMSAdmin')) {
                $det = $this->home_db->getdetails($this->session->userdata('BMSAdmin'));
            } else if ($cookie != "") {
                $det = $this->home_db->getdetails($cookie);
            }
            $this->data['detail'] = $det;
        }
        //echo "dsafdsfsdafdfas".$this->data['detail'];

        $this->data['header'] = $this->load->view('header', NULL, TRUE);
        $this->data['left'] = $this->load->view('left', $this->data, TRUE);
        $this->data['jsfile'] = $this->load->view('jsfile', NULL, TRUE);
        $this->data['popcss'] = $this->load->view('popcss', NULL, TRUE);


    }

    public function index()
    {
        $this->load->view('welcome_message');
    }


    public function prof_csv()
    {
        $this->data['type'] = 'csv';
        $this->data["eid"] = $this->input->get("id");
        $this->load->view('prof_add', $this->data);
    }

    public function prof()
    {
        $this->data["eid"] = $this->input->get("id");
        $this->load->view('prof', $this->data);
    }

    public function prof_table()
    {
        $db = array(
            'page' => $this->input->post('page'),
            'rp' => $this->input->post('rp'),
            'sortname' => $this->input->post('sortname'),
            'sortorder' => $this->input->post('sortorder'),
            'qtype' => $this->input->post('qtype'),
            'query' => $this->input->post('query'),
            'letter_pressed' => $this->input->post('letter_pressed'),
            'ex_id' => $this->input->get('eid'),
        );
        $this->data = $this->master_db->gettable_prof($db);
        echo $this->data;
    }

    public function prof_status()
    {
        $status = $this->input->post('status');
        $det = $this->data['detail'];

        $db = array(
            'items' => $this->input->post('items'),
            'status' => $status,

        );
        $status = $this->master_db->changeStatus("prof_{$this->input->post('ex_id')}", $db);
        echo $status;
    }

    public function prof_pri()
    {
        $status = $this->input->post('status');
        $det = $this->data['detail'];

        $db = array(
            'items' => $this->input->post('items'),
            'status' => $status,
        );
        $status = $this->master_db->changePri("prof_{$this->input->post('ex_id')}", $db);
        echo $status;
    }

    function clean($string)
    {
        //$string = str_replace(' ', '-', $string); // Replaces all spaces with hyphens.
        $string = preg_replace('/[^A-Za-z0-9\-]/', ' ', $string); // Removes special chars.
        $string = str_replace('-', ' ', $string);
        $string = trim(preg_replace('!\s+!', ' ', $string));
        return trim(preg_replace('/-+/', '-', $string)); // Replaces multiple hyphens with single one.
    }

    public function prof_add()
    {
        $this->data["eid"] = $this->input->get("id");
        $this->data["dept"] = $this->master_db->getRecords('dept', array("status" => 1));
        $this->data["desig"] = $this->master_db->getRecords('designation', array("status" => 1));
        $this->data["type"] = "add";
        $this->data["dates"] = $this->master_db->getRecords("time_table_{$this->data["eid"]}", array()," date, db_date ");
        $this->load->view("add_prof", $this->data);

    }

    public function save_prof()
    {

        if ($_SERVER["REQUEST_METHOD"] == "POST") {
            $eid = $this->input->post("eid");
            $name = $this->clean($this->input->post("name"));
            $usn = $this->input->post("usn");
            $dept = $this->input->post("dept");
            $desig = $this->input->post("desig");
            $email = $this->input->post("email");
            $phone = $this->input->post("phone");
            $acc = $this->input->post("acc");
            $exclude = $this->input->post("exclude_dt");
            $usn_chk = $this->master_db->getRecords("prof_{$eid}", array("usn" => trim(preg_replace('!\s+!', ' ', strtoupper($usn)))));

            if (is_array($usn_chk) && count($usn_chk) >= 1) {
                $usn_chk_name = $usn_chk[0]->name;
                $this->session->set_flashdata('message', "<div class='alert alert-danger alert-dismissable'><button class='close' aria-hidden='true' data-dismiss='alert' type='button'>&times;</button>Professor ID already Exist With Name <b>{$usn_chk_name}</b>..!!</div>");
                redirect("master/prof?id={$eid}");
            } else {
                $res = $this->master_db->insertRecord("prof_{$eid}", array("name" => $this->clean(trim(preg_replace('!\s+!', ' ', $name))),
                    "usn" => trim(preg_replace('!\s+!', ' ', strtoupper($usn))),
                    "dept" => trim(preg_replace('!\s+!', ' ', $dept)),
                    "designation" => trim(preg_replace('!\s+!', ' ', $desig)),
                    "email" => trim(preg_replace('!\s+!', ' ', $email)),
                    "acc_num" => trim(preg_replace('!\s+!', ' ', $acc)),
                    "phone" => trim(preg_replace('!\s+!', ' ', $phone)),
                    "duty_code" => trim(preg_replace('!\s+!', ' ', $desig)),
                    "status" => trim(preg_replace('!\s+!', ' ', 1))));

                if(is_array($exclude) && count($exclude)>=1){
                    foreach($exclude as $val){
                        $this->master_db->insertRecord("exclude_date_{$eid}",array("prof_id"=>$res,"date"=>$val));
                    }
                    $this->master_db->updateRecord("prof_{$eid}",array("have_exclude_date"=>1),$res);
                }

                if ($res) {
                    $this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Successful..!!</div>');
                    redirect("master/prof?id={$eid}");
                } else {
                    $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Failed..!!</div>');
                    redirect("master/prof?id={$eid}");
                }
            }
        }
        $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Failed..!!</div>');
        redirect("master/prof?id={$eid}");
    }

    public function prof_edit()
    {
        $this->data["eid"] = $eid = $this->input->get("eid");
        if ($this->session->userdata('BMSAdmin')) {
            $det = $this->home_db->getdetails($this->session->userdata('BMSAdmin'));
            if ($det[0]->login_type != "US") {
                $id = $this->input->get("id");
                $id_check = $this->master_db->getRecords("prof_{$eid}", array("id" => $id));
                if (is_array($id_check) && count($id_check) >= 1) {
                    $this->data["prof"] = $this->master_db->execSQL("select d.id as did, dp.id as dept_id, p.id, p.usn, p.name, p.phone, p.email,d.name as desig,dp.name as dept, p.acc_num from prof_{$eid} p,designation d,dept dp where dp.id=p.dept and d.id=p.designation and p.id={$id}");
                    $this->data["dept"] = $this->master_db->getRecords('dept', array("status" => 1));
                    $this->data["desig"] = $this->master_db->getRecords('designation', array("status" => 1));
                    $this->data["type"] = "edit";
                    $this->data["dates"] = $this->master_db->getRecords("time_table_{$this->data["eid"]}", array()," date, db_date ");
                    $ex_dt = $this->master_db->getRecords("exclude_date_{$this->data["eid"]}", array("prof_id"=>$id));

                    $ex_dates = array();
                    if(is_array($ex_dt) && count($ex_dt)>=1){
                        foreach($ex_dt as $val){
                            $ex_dates[] = $val->date;
                        }
                    }
                    $this->data["ex_dates"] = $ex_dates;
                    $this->load->view("add_prof", $this->data);
                } else {
                    $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Failed..!!</div>');
                    redirect("master/prof?id={$eid}");

                }
            } else {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>You Are Not Admin..!!</div>');
                redirect("master/prof?id={$eid}");
            }
        }


    }

    function prof_edit_save()
    {
        $eid = $this->input->post("eid");
        if ($this->session->userdata('BMSAdmin')) {
            $det = $this->home_db->getdetails($this->session->userdata('BMSAdmin'));
            if ($det[0]->login_type != "US") {
                if ($_SERVER["REQUEST_METHOD"] == "POST") {

                    $name = $this->clean($this->input->post("name"));
                    $pid = $this->input->post("pid");
                    $dept = $this->input->post("dept");
                    $desig = $this->input->post("desig");
                    $email = $this->input->post("email");
                    $phone = $this->input->post("phone");
                    $acc = $this->input->post("acc");
                    $exclude = $this->input->post("exclude_dt");

                    $this->master_db->updateRecord("prof_{$eid}", array("name" => trim(preg_replace('!\s+!', ' ', $name)),
                        "dept" => trim(preg_replace('!\s+!', ' ', $dept)),
                        "designation" => trim(preg_replace('!\s+!', ' ', $desig)),
                        "email" => trim(preg_replace('!\s+!', ' ', $email)),
                        "acc_num" => trim(preg_replace('!\s+!', ' ', $acc)),
                        "phone" => trim(preg_replace('!\s+!', ' ', $phone)),
                        "duty_code" => trim(preg_replace('!\s+!', ' ', $desig)),
                        "status" => trim(preg_replace('!\s+!', ' ', 1))), $pid);
                    $this->master_db->runSQL("delete from exclude_date_{$eid} where prof_id={$pid}");

                    if(is_array($exclude) && count($exclude)>=1){
                        foreach($exclude as $val){
                            $this->master_db->insertRecord("exclude_date_{$eid}",array("prof_id"=>$pid,"date"=>$val));
                        }
                        $this->master_db->updateRecord("prof_{$eid}",array("have_exclude_date"=>1),$pid);
                    }
                    $this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Successful..!!</div>');
                    redirect("master/prof?id={$eid}");
                }
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Failed..!!</div>');
                redirect("master/prof?id={$eid}");
            } else {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>You Are Not Admin..!!</div>');
                redirect("master/prof?id={$eid}");
            }
        }

    }

    public function import_csv()
    {

        $eid = $this->input->post("eid");
        $row = 0;
        $i = 1;
        $success = 0;
        $fname = $_FILES['pinfile']['name'];
        $filename = $_FILES['pinfile']['tmp_name'];
        $handle = fopen($filename, "r");
        $err = '';                           //initialize variable error table body
        $err_headings = '';                  //initialize variable error body 1st row
        $dept = $this->master_db->getRecords('dept', array("status" => 1));
        $desig = $this->master_db->getRecords('designation', array("status" => 1));
        $dept_arr = NULL;
        $desig_arr = NULL;

        foreach ($dept as $value) {
            $dept_arr[$value->name] = $value->id;
        }

        foreach ($desig as $value2) {
            $desig_arr[$value2->name] = $value2->id;
        }


        //initialize variable error body Heading
        $err_tab = "	<table class='table table-bordered'>
							  <thead>
								<tr style='background: whitesmoke;'>
								  <th>#</th>
								  <th>A</th>
								  <th>B</th>
								  <th>C</th>
								  <th>D</th>
								  <th>E</th>
								  <th>F</th>
								  <th>G</th>

								  <th>Error Cell</th>
								  <th>Reason</th>
								</tr>
							  </thead>
							  <tbody>";


        while (($datar = fgetcsv($handle, 2000, ",")) !== FALSE) {
            if ($row == 0 && $datar[0] != "Prof ID") {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Headings namely <b>|| Prof ID | Name | Designation | Department | Phone | Email | Account Number || Not Found in Your CSV File..!! Please Match The Above File Format</div>');
                redirect("master/prof_csv?id={$eid}");
            } else {
                $row++;
                if ($row != 1) {        // check if it is a heading/first row or not.. first row in a .csv file is the heading row.. so we do not check all the below condition..
                    // check if all the coloumns are empty.. if yes skip the whole row.
                    if (trim($datar[0]) != "" || trim($datar[1]) != "" || trim($datar[2]) != "" || trim($datar[3]) != "" || trim($datar[4]) != "" || trim($datar[5]) != "") {
                        if (trim($datar[4]) != "") {
                            if (!is_numeric(trim(preg_replace('!\s+!', ' ', $datar[4])))) {
                                $reason = "Not a valid number";
                                $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>E{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                                continue;
                            }
                        } else {
                            $reason = "Empty cell";
                            $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>E{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                            continue;
                        }
                        if (trim($datar[1]) != "") {

                        } else {
                            $reason = "Empty cell";
                            $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>B{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                            continue;
                        }
                        if (trim($datar[5]) != "") {

                        } else {
                            $reason = "Empty cell";
                            $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>F{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                            continue;
                        }
                        $usn_chk = $this->master_db->getRecords("prof_{$eid}", array("usn" => trim(preg_replace('!\s+!', ' ', $datar[0]))));
                        if (trim($datar[0]) != "") {
                            if (is_array($usn_chk) && count($usn_chk) >= 1) {
                                $reason = "Professor ID Already Exist with name " . $usn_chk[0]->name;
                                $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>A{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                                continue;
                            } else {
                            }

                        } else {       // it is empty cell error. so skip all other succeeding condition checks and append error reason to error tabe body..
                            $reason = "Empty Cell";
                            $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>A{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                            continue;
                        }


                        if (trim($datar[2]) != "") {
                            if (array_key_exists(trim(preg_replace('!\s+!', ' ', $datar[2])), $desig_arr)) {

                                $desig_id = $desig_arr[trim(preg_replace('!\s+!', ' ', $datar[2]))];
                            } else {

                                $reason = "Invalid Designation Name";
                                $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>C{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                                continue;

                            }
                        } else {                // it is empty cell error. so skip all other succeeding condition checks and append error reason to error tabe body..
                            $reason = "Empty Cell";
                            $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>C{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                            continue;
                        }

                        if (trim($datar[3]) != "") {
                            if (array_key_exists(trim(preg_replace('!\s+!', ' ', $datar[3])), $dept_arr)) {

                                $dept_id = $dept_arr[trim(preg_replace('!\s+!', ' ', $datar[3]))];
                            } else {

                                $reason = "Invalid Department Name";
                                $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>D{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                                continue;
                            }
                        } else {                // it is empty cell error. so skip all other succeeding condition checks and append error reason to error tabe body..
                            $reason = "Empty Cell";
                            $err .= "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td><b>D{$row}</b></td>
									  <td><b>{$reason}</b></td>
									</tr>";
                            continue;
                        }
                        $res3 = $this->master_db->insertRecord("prof_{$eid}", array("usn" => trim(preg_replace('!\s+!', ' ', strtoupper($datar[0]))),
                            "name" => $this->clean(trim(preg_replace('!\s+!', ' ', $datar[1]))),
                            "designation" => $desig_id,
                            "dept" => $dept_id,
                            "acc_num" => trim(preg_replace('!\s+!', ' ', $datar[6])),
                            "email" => trim(preg_replace('!\s+!', ' ', $datar[5])),
                            "phone" => trim(preg_replace('!\s+!', ' ', $datar[4])),
                            "duty_code" => $desig_id,
                            "status" => 1));
                        $success++;
                    }
                } else {
                    $err_headings = "<tr class='table-danger'>
									  <th scope='row'>{$row}</th>
									  <td>{$datar[0]}</td>
									  <td>{$datar[1]}</td>
									  <td>{$datar[2]}</td>
									  <td>{$datar[3]}</td>

									  <td>{$datar[4]}</td>
									  <td>{$datar[5]}</td><td>{$datar[6]}</td>

									  <td></td>
									  <td></td>
									</tr>";
                }
            }
        }
        fclose($handle);
        $err_end = "</tbody>
				</table>";

        $error_log = $err_tab . $err_headings . $err . $err_end;  //merge all the error related variable and send it along with flash data..

        if ($err == '' || empty($err)) {
            $this->session->set_flashdata('message', "<div class='alert alert-success alert-dismissable'><button class='close' aria-hidden='true' data-dismiss='alert' type='button'>&times;</button>{$success} items have been imported successfully...!!</div>");
            redirect("master/prof?id={$eid}");
        } else {
            $this->session->set_flashdata('message', "<div class='alert alert-dismissable'><button class='close' aria-hidden='true' data-dismiss='alert' type='button'>&times;</button><div class='alert alert-danger alert-dismissable'><b><span style='color: green;'>{$success} items have been imported successfully.</span></b> However the following rows have some erros. Please refer <b>Error Cell</b> & <b>Reason</b> columns for more details.</div>{$error_log}</div>");
            redirect("master/prof_csv?id={$eid}");
        }
    }


    public function getStud(){
        $attended = array();
        $sem = $this->input->post("sem");
        $select = $this->input->post("select");
        if($select=="all")
            $result = $this->master_db->getRecords("student", array("sem" => $sem));
        else
            $result = $this->master_db->execSQL("select * from student where sem={$sem} and (elect1='{$select}' or elect2='{$select}' or elect3='{$select}')");
        $db_name = date("M_jS_Y");
        $edit_result = $this->master_db->execSQL("SHOW TABLES LIKE '{$db_name}'");
        if($edit_result){
            $result_edit = $this->master_db->getRecords($db_name, array("fac_id" => $this->data['detail'][0]->id));
            if(is_array($result_edit) && count($result_edit)>=1){
                foreach ($result_edit as $val){
                    $attended[] = $val->std_id;
                }
            }
        }
        if(is_array($result) && count($result)>=1)
        foreach ($result as $row){
            $name = $row->name;
            $id = $row->id;
            if(in_array($id,$attended))
                echo "<tr><td>{$name}</td><td><input type='checkbox' name='checked_list[]' value='{$id}' checked></td></tr>";
            else
                echo "<tr><td>{$name}</td><td><input type='checkbox' name='checked_list[]' value='{$id}' checked></td></tr>";

        }
    }


    public function attendance(){
        $this->load->view('attendance', $this->data);
    }

    public function student_add()
    {
        $this->data['type'] = 'add';
        $this->load->view('editstudent', $this->data);
    }

    public function check_exam_id()
    {
        $id = $this->clean($this->input->post("id"));
        $old_id = $this->clean($this->input->post("old_id"));
        if ($old_id === $id) {
            echo 0;
        } else {
            $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $id));
            if (is_array($flag_check) && count($flag_check) >= 1) {
                echo 1;
            } else {
                echo 0;
            }
        }


    }

    public function student_edit()
    {
        $id = preg_replace('/\s+/', '_', $this->input->get("id"));
        $flag_check2 = $this->master_db->getRecords("student", array("id" => $id));
        if((!is_array($flag_check2))){
            $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
            redirect("master/timetable");
        } else {
            $this->data['type'] = 'edit';
            $this->data["std_data"] = $flag_check2;
            $this->load->view('editstudent', $this->data);

        }

    }

    public function timetable()
    {

        $this->load->view('timetable', $this->data);
    }

    public function student_table()
    {
        $db = array(
            'page' => $this->input->post('page'),
            'rp' => $this->input->post('rp'),
            'sortname' => $this->input->post('sortname'),
            'sortorder' => $this->input->post('sortorder'),
            'qtype' => $this->input->post('qtype'),
            'query' => $this->input->post('query'),
            'letter_pressed' => $this->input->post('letter_pressed'),
        );
        $this->data = $this->master_db->getstudent_table($db);
        echo $this->data;
    }

    public function student_save()
    {
        $name = $this->input->post("std_name");
        $sem = $this->input->post("sem");
        $this->master_db->insertRecord("student",array("name"=>$name,"sem"=>$sem));
        $this->session->set_flashdata('message', "<div class='alert alert-success alert-dismissable'><button class='close' aria-hidden='true' data-dismiss='alert' type='button'>&times;</button>Success....!!!</div>");
        redirect("master/timetable");

    }

    public function student_edit_save()
    {
        $id = $this->input->post("edit_id");
        $name = $this->input->post("std_name");
        $sem = $this->input->post("sem");
        $this->master_db->updateRecord("student",array("name"=>$name,"sem"=>$sem),$id);
        $this->session->set_flashdata('message', "<div class='alert alert-success alert-dismissable'><button class='close' aria-hidden='true' data-dismiss='alert' type='button'>&times;</button>Success....!!!</div>");
        redirect("master/timetable");


    }

    function getDateTag($date)
    {


        $dates = date('Y-m-d', strtotime($date));
        $converted = date_create($dates);
        $dateTag = date_format($converted, "d_M_Y");
        return $dateTag;
    }


    function getDropDown()
    {
        //print_r($_GET);
        $id = $this->input->get("eid");
        $query = $this->input->get("q");
        if (trim($this->input->get("times")) == "") {
            $exclude = "-1";
        } else {
            $exclude = $this->input->get("times");
        }
//		if($id=="RS")
//		$d = $this->master_db->execSQL("SELECT id, name FROM prof WHERE id NOT IN ({$exclude}) and designation != 2 AND designation != 3 AND status = 1 AND (name LIKE '%{$query}%' OR usn LIKE '%{$query}%')");
//		if($id=="RLS")
//		$d = $this->master_db->execSQL("SELECT id, name FROM prof WHERE id NOT IN ({$exclude}) and designation = 2 AND status = 1 AND (name LIKE '%{$query}%' OR usn LIKE '%{$query}%')");
//		if($id=="DS")
//		$d = $this->master_db->execSQL("SELECT id, name FROM prof WHERE id NOT IN ({$exclude}) and designation = 3 AND status = 1 AND (name LIKE '%{$query}%' OR usn LIKE '%{$query}%')");
        $d = $this->master_db->execSQL("SELECT id, name FROM prof_{$id} WHERE id NOT IN ({$exclude}) AND status = 1 AND (name LIKE '%{$query}%' OR usn LIKE '%{$query}%')");
        echo json_encode($d);
    }

    function getDropDown_v2()
    {
        //print_r($_GET);
        $id = $this->input->get("id");
        $ex_id = $this->input->get("ex_id");
        if ($id == "RS")
            $d = $this->master_db->execSQL("SELECT name FROM prof_{$ex_id} WHERE  designation != 2 AND designation != 3 AND status = 1");
        if ($id == "RLS")
            $d = $this->master_db->execSQL("SELECT name FROM prof_{$ex_id} WHERE designation = 2 AND status = 1");
        if ($id == "DS")
            $d = $this->master_db->execSQL("SELECT name FROM prof_{$ex_id} WHERE designation = 3 AND status = 1");
        echo json_encode($d);
    }

    function duty_save()
    {
        $arr = json_decode($this->input->post("arr"));
        $exam_id = $this->input->post("exam_id");
        $this->master_db->runSQL("DROP TABLE  `assigned_duties_{$exam_id}`");
        $sql_create_table_assigned_duties = "CREATE TABLE IF NOT EXISTS `assigned_duties_{$exam_id}` (
                                                  `id` bigint(200) NOT NULL AUTO_INCREMENT,
                                                  `exam_id` text NOT NULL,
                                                  `unique_key` text NOT NULL,
                                                  `date` text NOT NULL,
                                                  `m3` int(11) NOT NULL,
                                                  `m4` int(11) NOT NULL,
                                                  `a3` int(11) NOT NULL,
                                                  `a4` int(11) NOT NULL,
                                                  `prof_id` int(11) NOT NULL,
                                                  `m3_designation` text NOT NULL,
                                                  `a3_designation` text NOT NULL,
                                                  `a4_designation` text NOT NULL,
                                                  `m4_designation` text NOT NULL,
                                                  `db_date` date NOT NULL,
                                                  PRIMARY KEY (`id`),
                                                  KEY `id` (`id`)
                                                )";
        $this->master_db->runSQL($sql_create_table_assigned_duties);
        $this->master_db->updateRecord("exam_id", array("exam_id" => $exam_id, "edited" => 0, "printed" => 0, "informed" => 0, "assigned" => 1), $exam_id, "exam_id");

        foreach ($arr as $keys => $value2) {
            $rs_m3 = array();
            $rs_m4 = array();
            $rs_a3 = array();
            $rs_a4 = array();

            $rls_m3 = array();
            $rls_m4 = array();
            $rls_a3 = array();
            $rls_a4 = array();

            $ds_m3 = array();
            $ds_m4 = array();
            $ds_a3 = array();
            $ds_a4 = array();

            foreach ($value2 as $key => $value) {
                if ($key == "RS") {
                    foreach ($value as $k => $v3) {
                        if ($k == "m3") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $rs_m3[] = $v2;
                        }

                        if ($k == "m4") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $rs_m4[] = $v2;
                        }

                        if ($k == "a3") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $rs_a3[] = $v2;
                        }

                        if ($k == "a4") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $rs_a4[] = $v2;
                        }
                    }
                }

//-------------------------------------------------------------------------------

                if ($key == "RLS") {
                    foreach ($value as $k => $v3) {
                        if ($k == "m3") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $rls_m3[] = $v2;
                        }

                        if ($k == "m4") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $rls_m4[] = $v2;
                        }

                        if ($k == "a3") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $rls_a3[] = $v2;
                        }

                        if ($k == "a4") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $rls_a4[] = $v2;
                        }
                    }
                }

//----------------------------------------------------------------------------

                if ($key == "DS") {
                    foreach ($value as $k => $v3) {
                        if ($k == "m3") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $ds_m3[] = $v2;
                        }

                        if ($k == "m4") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $ds_m4[] = $v2;
                        }

                        if ($k == "a3") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $ds_a3[] = $v2;
                        }

                        if ($k == "a4") {
                            $split = explode(",", $v3);
                            foreach ($split as $v2)
                                $ds_a4[] = $v2;
                        }
                    }
                }


            }
//--------------------------------------------------------------------------------------------------------------------------------------
            $id_holder = array();
//--------------------------------------------------------RS M3 Insert------------------------------------------------------------------
            foreach ($rs_m3 as $as_duty) {
                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m3" => 1,
                        "m3_designation" => "RS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "m3" => 1,
                        "m3_designation" => "RS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }
//--------------------------------------------------------RS M4 Insert------------------------------------------------------------------
            foreach ($rs_m4 as $as_duty) {

                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m4" => 1,
                        "m4_designation" => "RS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "m4" => 1,
                        "m4_designation" => "RS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }

//--------------------------------------------------------RS A3 Insert------------------------------------------------------------------
            foreach ($rs_a3 as $as_duty) {
                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a3" => 1,
                        "a3_designation" => "RS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "a3" => 1,
                        "a3_designation" => "RS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }
//--------------------------------------------------------RS A4 Insert------------------------------------------------------------------
            foreach ($rs_a4 as $as_duty) {

                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a4" => 1,
                        "a4_designation" => "RS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "a4" => 1,
                        "a4_designation" => "RS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }

//******************************************************************************************************************************************

//--------------------------------------------------------RLS M3 Insert------------------------------------------------------------------
            foreach ($rls_m3 as $as_duty) {
                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m3" => 1,
                        "m3_designation" => "RLS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "m3" => 1,
                        "m3_designation" => "RLS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }
//--------------------------------------------------------rls M4 Insert------------------------------------------------------------------
            foreach ($rls_m4 as $as_duty) {

                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m4" => 1,
                        "m4_designation" => "RLS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "m4" => 1,
                        "m4_designation" => "RLS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }

//--------------------------------------------------------rls A3 Insert------------------------------------------------------------------
            foreach ($rls_a3 as $as_duty) {
                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a3" => 1,
                        "a3_designation" => "RLS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "a3" => 1,
                        "a3_designation" => "RLS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }
//--------------------------------------------------------rls A4 Insert------------------------------------------------------------------
            foreach ($rls_a4 as $as_duty) {

                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a4" => 1,
                        "a4_designation" => "RLS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "a4" => 1,
                        "a4_designation" => "RLS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }

//******************************************************************************************************************************************

//--------------------------------------------------------DS M3 Insert------------------------------------------------------------------
            foreach ($ds_m3 as $as_duty) {
                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m3" => 1,
                        "m3_designation" => "DS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "m3" => 1,
                        "m3_designation" => "DS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }
//--------------------------------------------------------ds M4 Insert------------------------------------------------------------------
            foreach ($ds_m4 as $as_duty) {

                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m4" => 1,
                        "m4_designation" => "DS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "m4" => 1,
                        "m4_designation" => "DS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }

//--------------------------------------------------------ds A3 Insert------------------------------------------------------------------
            foreach ($ds_a3 as $as_duty) {
                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a3" => 1,
                        "a3_designation" => "DS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "a3" => 1,
                        "a3_designation" => "DS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }
//--------------------------------------------------------ds A4 Insert------------------------------------------------------------------
            foreach ($ds_a4 as $as_duty) {

                if (array_key_exists($as_duty, $id_holder)) {
                    $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a4" => 1,
                        "a4_designation" => "DS"), $id_holder[$as_duty]);
                } else {
                    $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                        "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                        "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                        "a4" => 1,
                        "a4_designation" => "DS",
                        "prof_id" => $as_duty));
                    if ($res) {
                        $id_holder[$as_duty] = $res;
                    }
                }
            }


        }
        $this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Successful..!!!</div>');
        echo "success	";
    }

    function  getSQL_Date($date)
    {

        $date = str_replace("_", "-", $date);
        $dates = date('Y-m-d', strtotime($date));
        $converted = date_create($dates);
        $dateTag = date_format($converted, "d-m-Y");
        return $dateTag;
    }


    function edit_assigned_duties()
    {
        if ($this->session->userdata('BMSAdmin')) {
            $det = $this->home_db->getdetails($this->session->userdata('BMSAdmin'));
            if ($det[0]->login_type != "US") {
                $exam_id = $this->input->get("id");
                $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $exam_id, "informed" => 1));
                if (is_array($flag_check) && count($flag_check) >= 1) {
                    $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                    redirect("master/timetable");
                } else {
                    $master = array();
                    $td = $this->master_db->getRecords("time_table_{$exam_id}", array("exam_id" => $this->input->get("id")), '*', 'id asc');
                    if (is_array($td) && count($td) >= 1) {
                        foreach ($td as $time_data) {
                            //$main_data = $this->master_db->getRecords("assigned_duties",array("exam_id"=>$time_data->exam_id,"date"=>$time_data->date));
                            $main_data = $this->master_db->execSQL("select d.*,p.name, p.usn from assigned_duties_{$exam_id} d, prof_{$exam_id} p where d.exam_id = '{$time_data->exam_id}' and d.date='{$time_data->date}' and d.prof_id = p.id ORDER BY d.id asc");
                            foreach ($main_data as $main) {
                                if ($main->m3 == 1 && $main->m3_designation == "RS") {
                                    $master[$this->getDateTag($time_data->date)][0][0]["m3"][$main->name] = $main->prof_id;
                                }
                                if ($main->m4 == 1 && $main->m4_designation == "RS") {
                                    $master[$this->getDateTag($time_data->date)][0][0]["m4"][$main->name] = $main->prof_id;
                                }

                                if ($main->a3 == 1 && $main->a3_designation == "RS") {
                                    $master[$this->getDateTag($time_data->date)][0][1]["a3"][$main->name] = $main->prof_id;
                                }

                                if ($main->a4 == 1 && $main->a4_designation == "RS") {
                                    $master[$this->getDateTag($time_data->date)][0][1]["a4"][$main->name] = $main->prof_id;
                                }

                                if ($main->m3 == 1 && $main->m3_designation == "RLS") {
                                    $master[$this->getDateTag($time_data->date)][1][0]["m3"][$main->name] = $main->prof_id;
                                }
                                if ($main->m4 == 1 && $main->m4_designation == "RLS") {
                                    $master[$this->getDateTag($time_data->date)][1][0]["m4"][$main->name] = $main->prof_id;
                                }

                                if ($main->a3 == 1 && $main->a3_designation == "RLS") {
                                    $master[$this->getDateTag($time_data->date)][1][1]["a3"][$main->name] = $main->prof_id;
                                }

                                if ($main->a4 == 1 && $main->a4_designation == "RLS") {
                                    $master[$this->getDateTag($time_data->date)][1][1]["a4"][$main->name] = $main->prof_id;
                                }


                                if ($main->m3 == 1 && $main->m3_designation == "DS") {
                                    $master[$this->getDateTag($time_data->date)][2][0]["m3"][$main->name] = $main->prof_id;
                                }
                                if ($main->m4 == 1 && $main->m4_designation == "DS") {
                                    $master[$this->getDateTag($time_data->date)][2][0]["m4"][$main->name] = $main->prof_id;
                                }

                                if ($main->a3 == 1 && $main->a3_designation == "DS") {
                                    $master[$this->getDateTag($time_data->date)][2][1]["a3"][$main->name] = $main->prof_id;
                                }

                                if ($main->a4 == 1 && $main->a4_designation == "DS") {
                                    $master[$this->getDateTag($time_data->date)][2][1]["a4"][$main->name] = $main->prof_id;
                                }
                            }

                        }

                        $this->calc_counts();
                        $this->data["populate"] = $master;
                        $this->load->view("edit_assign_duty", $this->data);
                    } else {
                        $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Invalid Exam..!!</div>');
                        redirect("master/timetable");
                    }
                }
            } else {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>You Are Not Admin</div>');
                redirect("master/timetable");
            }
        }
    }


    function edit_duty_save()
    {
        if ($this->session->userdata('BMSAdmin')) {
            $det = $this->home_db->getdetails($this->session->userdata('BMSAdmin'));
            if ($det[0]->login_type != "US") {
                $exam_id = $this->input->post("exam_id");
                $exam_date = $this->input->post("date");
                if($exam_date == ""){
                    $this->master_db->runSQL("DROP TABLE  `assigned_duties_{$exam_id}`");
                    $sql_create_table_assigned_duties = "CREATE TABLE IF NOT EXISTS `assigned_duties_{$exam_id}` (
                                                      `id` bigint(200) NOT NULL AUTO_INCREMENT,
                                                      `exam_id` text NOT NULL,
                                                      `unique_key` text NOT NULL,
                                                      `date` text NOT NULL,
                                                      `m3` int(11) NOT NULL,
                                                      `m4` int(11) NOT NULL,
                                                      `a3` int(11) NOT NULL,
                                                      `a4` int(11) NOT NULL,
                                                      `prof_id` int(11) NOT NULL,
                                                      `m3_designation` text NOT NULL,
                                                      `a3_designation` text NOT NULL,
                                                      `a4_designation` text NOT NULL,
                                                      `m4_designation` text NOT NULL,
                                                      `db_date` date NOT NULL,
                                                      PRIMARY KEY (`id`),
                                                      KEY `id` (`id`)
                                                    )";
                    $this->master_db->runSQL($sql_create_table_assigned_duties);
                } else {
                    $this->master_db->runSQL("delete FROM `assigned_duties_{$exam_id}` WHERE date = '{$exam_date}'");
                }
                $arr = json_decode($this->input->post("arr"));


                $this->master_db->updateRecord("exam_id", array("exam_id" => $exam_id, "edited" => 0, "printed" => 0, "informed" => 0, "assigned" => 1), $exam_id, "exam_id");

                foreach ($arr as $keys => $value2) {
                    $rs_m3 = array();
                    $rs_m4 = array();
                    $rs_a3 = array();
                    $rs_a4 = array();

                    $rls_m3 = array();
                    $rls_m4 = array();
                    $rls_a3 = array();
                    $rls_a4 = array();

                    $ds_m3 = array();
                    $ds_m4 = array();
                    $ds_a3 = array();
                    $ds_a4 = array();

                    foreach ($value2 as $key => $value) {
                        if ($key == "RS") {
                            foreach ($value as $k => $v3) {
                                if ($k == "m3") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $rs_m3[] = $v2;
                                }

                                if ($k == "m4") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $rs_m4[] = $v2;
                                }

                                if ($k == "a3") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $rs_a3[] = $v2;
                                }

                                if ($k == "a4") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $rs_a4[] = $v2;
                                }
                            }
                        }

//-------------------------------------------------------------------------------

                        if ($key == "RLS") {
                            foreach ($value as $k => $v3) {
                                if ($k == "m3") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $rls_m3[] = $v2;
                                }

                                if ($k == "m4") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $rls_m4[] = $v2;
                                }

                                if ($k == "a3") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $rls_a3[] = $v2;
                                }

                                if ($k == "a4") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $rls_a4[] = $v2;
                                }
                            }
                        }

//----------------------------------------------------------------------------

                        if ($key == "DS") {
                            foreach ($value as $k => $v3) {
                                if ($k == "m3") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $ds_m3[] = $v2;
                                }

                                if ($k == "m4") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $ds_m4[] = $v2;
                                }

                                if ($k == "a3") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $ds_a3[] = $v2;
                                }

                                if ($k == "a4") {
                                    $split = explode(",", $v3);
                                    foreach ($split as $v2)
                                        $ds_a4[] = $v2;
                                }
                            }
                        }


                    }
//--------------------------------------------------------------------------------------------------------------------------------------
                    $id_holder = array();
//--------------------------------------------------------RS M3 Insert------------------------------------------------------------------
                    foreach ($rs_m3 as $as_duty) {
                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m3" => 1,
                                "m3_designation" => "RS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "m3" => 1,
                                "m3_designation" => "RS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }
//--------------------------------------------------------RS M4 Insert------------------------------------------------------------------
                    foreach ($rs_m4 as $as_duty) {

                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m4" => 1,
                                "m4_designation" => "RS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "m4" => 1,
                                "m4_designation" => "RS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }

//--------------------------------------------------------RS A3 Insert------------------------------------------------------------------
                    foreach ($rs_a3 as $as_duty) {
                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a3" => 1,
                                "a3_designation" => "RS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "a3" => 1,
                                "a3_designation" => "RS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }
//--------------------------------------------------------RS A4 Insert------------------------------------------------------------------
                    foreach ($rs_a4 as $as_duty) {

                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a4" => 1,
                                "a4_designation" => "RS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "a4" => 1,
                                "a4_designation" => "RS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }

//******************************************************************************************************************************************

//--------------------------------------------------------RLS M3 Insert------------------------------------------------------------------
                    foreach ($rls_m3 as $as_duty) {
                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m3" => 1,
                                "m3_designation" => "RLS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "m3" => 1,
                                "m3_designation" => "RLS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }
//--------------------------------------------------------rls M4 Insert------------------------------------------------------------------
                    foreach ($rls_m4 as $as_duty) {

                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m4" => 1,
                                "m4_designation" => "RLS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "m4" => 1,
                                "m4_designation" => "RLS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }

//--------------------------------------------------------rls A3 Insert------------------------------------------------------------------
                    foreach ($rls_a3 as $as_duty) {
                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a3" => 1,
                                "a3_designation" => "RLS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "a3" => 1,
                                "a3_designation" => "RLS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }
//--------------------------------------------------------rls A4 Insert------------------------------------------------------------------
                    foreach ($rls_a4 as $as_duty) {

                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a4" => 1,
                                "a4_designation" => "RLS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "a4" => 1,
                                "a4_designation" => "RLS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }

//******************************************************************************************************************************************

//--------------------------------------------------------DS M3 Insert------------------------------------------------------------------
                    foreach ($ds_m3 as $as_duty) {
                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m3" => 1,
                                "m3_designation" => "DS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "m3" => 1,
                                "m3_designation" => "DS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }
//--------------------------------------------------------ds M4 Insert------------------------------------------------------------------
                    foreach ($ds_m4 as $as_duty) {

                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("m4" => 1,
                                "m4_designation" => "DS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "m4" => 1,
                                "m4_designation" => "DS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }

//--------------------------------------------------------ds A3 Insert------------------------------------------------------------------
                    foreach ($ds_a3 as $as_duty) {
                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a3" => 1,
                                "a3_designation" => "DS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "a3" => 1,
                                "a3_designation" => "DS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }
//--------------------------------------------------------ds A4 Insert------------------------------------------------------------------
                    foreach ($ds_a4 as $as_duty) {

                        if (array_key_exists($as_duty, $id_holder)) {
                            $this->master_db->updateRecord("assigned_duties_{$exam_id}", array("a4" => 1,
                                "a4_designation" => "DS"), $id_holder[$as_duty]);
                        } else {
                            $res = $this->master_db->insertRecord("assigned_duties_{$exam_id}", array("exam_id" => $exam_id,
                                "unique_key" => $this->getSQL_Date($keys) . "__" . $exam_id,
                                "date" => $this->getSQL_Date($keys), "db_date" => date('Y-m-d', strtotime($this->getSQL_Date($keys))),
                                "a4" => 1,
                                "a4_designation" => "DS",
                                "prof_id" => $as_duty));
                            if ($res) {
                                $id_holder[$as_duty] = $res;
                            }
                        }
                    }


                }

                echo "success";
            } else {
                echo "failed";
            }
        }

    }


    function calc_counts()
    {
        $exam_id = $this->input->get("id");
        $this->data['table_data'] = $td = $this->master_db->getRecords("time_table_{$exam_id}", array("exam_id" => $this->input->get("id")), '*', 'id asc');
        $RS = $this->master_db->getRecords("prof_{$exam_id}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0));
        $RLS = $this->master_db->getRecords("prof_{$exam_id}", array("designation" => 2, "status" => 1, "priority" => 0));
        $DS = $this->master_db->getRecords("prof_{$exam_id}", array("designation" => 3, "status" => 1, "priority" => 0));


        if (is_array($RS) && is_array($RLS) && is_array($DS) && count($RS) >= 1 && count($RLS) >= 1 && count($DS) >= 1) {
            shuffle($RS);
            shuffle($RLS);
            shuffle($DS);
        }

        if (is_array($RS) && count($RS))
            shuffle($RS);
        if (is_array($RLS) && count($RLS))
            shuffle($RLS);
        if (is_array($DS) && count($DS))
            shuffle($DS);

        $RS_pri = $this->master_db->getRecords("prof_{$exam_id}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 1));
        $RLS_pri = $this->master_db->getRecords("prof_{$exam_id}", array("designation" => 2, "status" => 1, "priority" => 1));
        $DS_pri = $this->master_db->getRecords("prof_{$exam_id}", array("designation" => 3, "status" => 1, "priority" => 1));

        if (is_array($RS_pri) && count($RS_pri))
            $RS = array_merge($RS_pri, $RS);
        if (is_array($RLS_pri) && count($RLS_pri))
            $RLS = array_merge($RLS_pri, $RLS);
        if (is_array($DS_pri) && count($DS_pri))
            $DS = array_merge($DS_pri, $DS);

        $this->data['RS'] = $RS;
        $this->data['RLS'] = $RLS;
        $this->data['DS'] = $DS;


        $m3_str = array();
        $m4_str = array();
        $a3_str = array();
        $a4_str = array();


        $m3_rs_count = array();
        $m3_rls_count = array();
        $m3_ds_count = array();

        $m4_rs_count = array();
        $m4_rls_count = array();
        $m4_ds_count = array();

        $a3_rs_count = array();
        $a3_rls_count = array();
        $a3_ds_count = array();

        $a4_rs_count = array();
        $a4_rls_count = array();
        $a4_ds_count = array();

        $rs_max_duty = 0;
        $rls_max_duty = 0;
        $ds_max_duty = 0;

        $counter = 0;
        foreach ($td as $row) {
            $m3 = 0;
            $m4 = 0;
            $a3 = 0;
            $a4 = 0;
            $m3_str[] = $row->m3strength;
            $m4_str[] = $row->m4strength;
            $a3_str[] = $row->a3strength;
            $a4_str[] = $row->a4strength;
            if ($row->m3strength != -1) {
                $m3 += $row->m3strength;
            }

            if ($row->m4strength != -1) {
                $m4 += $row->m4strength;
            }

            if ($row->a3strength != -1) {
                $a3 += $row->a3strength;
            }

            if ($row->a4strength != -1) {
                $a4 += $row->a4strength;
            }

            if ($m3 < 30) {
                $m3_rs_count[] = ceil($m3 / 30);

            } else {
                $m3_rs_count[] = round($m3 / 30);

            }
            if ($a3 < 30) {
                $a3_rs_count[] = ceil($a3 / 30);

            } else {
                $a3_rs_count[] = round($a3 / 30);

            }
            if ($m4 < 30) {
                $m4_rs_count[] = ceil($m4 / 30);

            } else {
                $m4_rs_count[] = round($m4 / 30);

            }
            if ($a4 < 30) {
                $a4_rs_count[] = ceil($a4 / 30);

            } else {
                $a4_rs_count[] = round($a4 / 30);

            }

            if ($m3 >= 76) {
                if ($m3_rs_count[$counter] < 5)
                    $m3_rls_count[] = ceil(($m3_rs_count[$counter]) / 5);
                else
                    $m3_rls_count[] = round(($m3_rs_count[$counter]) / 5);
            } else {
                $m3_rls_count[] = 0;
            }

            if ($a3 >= 76) {
                if ($a3_rs_count[$counter] < 5)
                    $a3_rls_count[] = ceil(($a3_rs_count[$counter]) / 5);
                else
                    $a3_rls_count[] = round(($a3_rs_count[$counter]) / 5);
            } else {
                $a3_rls_count[] = 0;
            }

            if ($m4 >= 76) {
                if ($m4_rs_count[$counter] < 5)
                    $m4_rls_count[] = ceil(($m4_rs_count[$counter]) / 5);
                else
                    $m4_rls_count[] = round(($m4_rs_count[$counter]) / 5);
            } else {
                $m4_rls_count[] = 0;
            }

            if ($a4 >= 76) {
                if ($a4_rs_count[$counter] < 5)
                    $a4_rls_count[] = ceil(($a4_rs_count[$counter]) / 5);
                else
                    $a4_rls_count[] = round(($a4_rs_count[$counter]) / 5);
            } else {
                $a4_rls_count[] = 0;
            }


            if ($m3 < 250) {

                $m3_ds_count[] = ceil(($m3) / 250);
            } else {

                $m3_ds_count[] = round(($m3) / 250);
            }
            if ($a3 < 250) {

                $a3_ds_count[] = ceil(($a3) / 250);
            } else {

                $a3_ds_count[] = round(($a3) / 250);
            }
            if ($m4 < 250) {

                $m4_ds_count[] = ceil(($m4) / 250);
            } else {

                $m4_ds_count[] = round(($m4) / 250);
            }
            if ($a4 < 250) {

                $a4_ds_count[] = ceil(($a4) / 250);
            } else {

                $a4_ds_count[] = round(($a4) / 250);
            }

            $rs_max_duty += $m3_rs_count[$counter] + $a3_rs_count[$counter] + $m4_rs_count[$counter] + $a4_rs_count[$counter];
            $rls_max_duty += $m3_rls_count[$counter] + $a3_rls_count[$counter] + $m4_rls_count[$counter] + $a4_rls_count[$counter];
            $ds_max_duty += $m3_ds_count[$counter] + $a3_ds_count[$counter] + $m4_ds_count[$counter] + $a4_ds_count[$counter];
            $counter++;
        }

        $this->data["m3_rs_count"] = $m3_rs_count;
        $this->data["a3_rs_count"] = $a3_rs_count;

        $this->data["m4_rs_count"] = $m4_rs_count;
        $this->data["a4_rs_count"] = $a4_rs_count;

        $this->data["m3_rls_count"] = $m3_rls_count;
        $this->data["a3_rls_count"] = $a3_rls_count;

        $this->data["m4_rls_count"] = $m4_rls_count;
        $this->data["a4_rls_count"] = $a4_rls_count;

        $this->data["m3_ds_count"] = $m3_ds_count;
        $this->data["a3_ds_count"] = $a3_ds_count;

        $this->data["m4_ds_count"] = $m4_ds_count;
        $this->data["a4_ds_count"] = $a4_ds_count;

        $this->data["rs_count"] = $rs_max_duty;
        $this->data["rls_count"] = $rls_max_duty;
        $this->data["ds_count"] = $ds_max_duty;

        $settings = $this->master_db->getRecords("settings", array());
        $rs_priority_duty = $settings[0]->rs_priority_duty;
        $rls_priority_duty = $settings[0]->rls_priority_duty;
        $ds_priority_duty = $settings[0]->ds_priority_duty;


        $rs_max_duty_temp = ceil($rs_max_duty / count($RS));
        $rls_max_duty_temp = ceil($rls_max_duty / count($RLS));
        $ds_max_duty_temp = ceil($ds_max_duty / count($DS));

        if ($rs_priority_duty < $rs_max_duty_temp && is_array($RS_pri) && count($RS_pri) >= 1 && $rs_priority_duty >= 1) {
            $this->data["rs_max_duty"] = $rs_max_duty = ceil(($rs_max_duty + (($rs_max_duty_temp - $rs_priority_duty) * count($RS_pri))) / count($RS));
        } else {
            $this->data["rs_max_duty"] = $rs_max_duty = ceil($rs_max_duty / count($RS));
        }

        if ($rls_priority_duty < $rls_max_duty_temp && is_array($RLS_pri) && count($RLS_pri) >= 1 && $rls_priority_duty >= 1) {
            $this->data["rls_max_duty"] = $rls_max_duty = ceil(($rls_max_duty + (($rls_max_duty_temp - $rls_priority_duty) * count($RLS_pri))) / count($RLS));
        } else {
            $this->data["rls_max_duty"] = $rls_max_duty = ceil($rls_max_duty / count($RLS));
        }


        if ($ds_priority_duty < $ds_max_duty_temp && is_array($DS_pri) && count($DS_pri) >= 1 && $ds_priority_duty >= 1) {
            $this->data["ds_max_duty"] = $ds_max_duty = ceil(($ds_max_duty + (($ds_max_duty_temp - $ds_priority_duty) * count($DS_pri))) / count($DS));
        } else {
            $this->data["ds_max_duty"] = $ds_max_duty = ceil($ds_max_duty / count($DS));
        }

        $this->data["m3_str"] = $m3_str;
        $this->data["m4_str"] = $m4_str;
        $this->data["a3_str"] = $a3_str;
        $this->data["a4_str"] = $a4_str;

    }


    function printreport()
    {
        $this->data["exam_id"] = $eid = $this->input->get("exam_id");
        $this->data["flag"] = $flag = $this->input->get("flag");
        $check = $this->master_db->getRecords("exam_id", array("assigned" => 1, "exam_id" => $eid));
        if (is_array($check) && count($check) >= 1) {
            $this->data["exam"] = $check = $this->master_db->getRecords("exam_id", array("assigned" => 1));
            $this->data["dept"] = $this->master_db->getRecords("dept", array("status" => 1));
            $this->data["desig"] = $this->master_db->getRecords("designation", array("status" => 1));
            $this->data["d_desig"] = $this->master_db->getRecords("duty_designation", array());
            $this->data["timetable"] = $check = $this->master_db->getRecords("time_table_{$eid}", array("exam_id" => $eid), "id, date", "db_date asc");
            if($flag=="")
                $this->load->view("gen_report", $this->data);
            else
                $this->load->view("tick_report", $this->data);
        } else {
            $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Invalid Exam..!!</div>');
            redirect("master/timetable");
        }
    }

    function print_report()
    {

        $master = array();
        $advanced = $this->input->post("advanced");
        $exam = $this->input->post("exam_id");
        $dept = $this->input->post("dept");
        $desig = $this->input->post("desig");
        $d_desig = $this->input->post("d_desig");
        if ($advanced == 0) {

            $where = "";
            if ($dept != -1) {
                $where .= " AND b.dept={$dept} ";
            }
            if ($desig != -1) {
                $where .= " AND b.designation={$desig} ";
            }
            if ($d_desig != -1) {
                $where .= " AND (a.m3_designation='{$d_desig}' OR a.m4_designation='{$d_desig}' OR a.a3_designation='{$d_desig}' OR a.a4_designation='{$d_desig}') ";
            }

            $where .= " ORDER BY e.db_date";

            $prof_sql = "SELECT DISTINCT (
					a.prof_id
					) AS pid
					FROM assigned_duties_{$exam} a,prof_{$exam} p
					WHERE  a.exam_id =  '{$exam}' AND a.prof_id=p.id ORDER BY p.dept ";

            $time_data = $this->master_db->execSQL($prof_sql);
            if (is_array($time_data) && count($time_data) >= 1) {
                foreach ($time_data as $time) {
                    $sql = "SELECT a.exam_id, a.date, e.m3start_time, e.m4start_time, e.a3start_time, e.a4start_time,a.m3, a.m4, a.a3, a.a4, a.m3_designation, a.m4_designation, a.a3_designation, a.a4_designation, b.name AS prof_name, b.phone, c.name AS desig_name, d.name AS dept_name
				FROM assigned_duties_{$exam} a, prof_{$exam} b, designation c, dept d, time_table_{$exam} e
				WHERE a.prof_id = b.id
				AND b.designation = c.id
				AND b.dept = d.id
				AND a.exam_id = e.exam_id
				AND a.date = e.date
				AND a.exam_id = '{$exam}'
				AND a.prof_id = {$time->pid} ";

                    $d = $this->master_db->execSQL($sql . $where);
                    if (is_array($d) && count($d) >= 1)
                        $master[] = $d;
                }
            }

            $this->data["report"] = $master;
            $settings = $this->master_db->getRecords("settings", array());
            if (is_array($settings) && count($settings) >= 1 && is_array($master) && count($master) >= 1) {
                $this->data["note_text"] = $settings[0]->rp_note_text;
                $this->data["head_text"] = $this->attach_variable($settings[0]->rp_text_head, $exam);
                $this->load->view("print_report", $this->data);
            } else {
                redirect("dutyadmin");
            }
        } else {
            $ex_date = $this->input->post("ex_date");
            $session = $this->input->post("session");
            $match = array("1" => "",
                "2" => " and a.m3=1 ",
                "3" => " and a.m4=1 ",
                "4" => " and a.a3=1 ",
                "5" => " and a.a4=1 ",
                "6" => " and (a.m3=1 or a.m4=1) ",
                "7" => " and (a.a3=1 or a.a4=1) ");
            $match = $match[$session];


            $sql = "SELECT a.exam_id, a.date, e.m3start_time, e.m4start_time, e.a3start_time, e.a4start_time,a.m3, a.m4, a.a3, a.a4, a.m3_designation, a.m4_designation, a.a3_designation, a.a4_designation, b.name AS prof_name, b.phone, c.name AS desig_name, d.name AS dept_name
				FROM assigned_duties_{$exam} a, prof_{$exam} b, designation c, dept d, time_table_{$exam} e
				WHERE a.prof_id = b.id
				AND b.designation = c.id
				AND b.dept = d.id
				AND a.exam_id = e.exam_id
				AND a.date = e.date
				AND a.exam_id = '{$exam}'
				AND a.date = '{$ex_date}' {$match} ";
            $where = "";
            if ($dept != -1) {
                $where .= " AND b.dept={$dept} ";
            }
            if ($desig != -1) {
                $where .= " AND b.designation={$desig} ";
            }
            if ($d_desig != -1) {
                $where .= " AND (a.m3_designation='{$d_desig}' OR a.m4_designation='{$d_desig}' OR a.a3_designation='{$d_desig}' OR a.a4_designation='{$d_desig}') ";
            }
            $where .= " ORDER BY b.dept ";
            $time_data = $this->master_db->execSQL($sql . $where);
//			echo "<pre>";
//			print_r($time_data);
//			echo "</pre>";
            $this->data["report"] = $time_data;
            $this->data["exam_id"] = $exam;
            $this->data["session"] = $session;
            $this->data["ex_date"] = $ex_date;
            $this->load->view("print_report_advanced", $this->data);
        }

    }


    function sendWay2SMS($phone, $msg, $uid = "9449751831", $pwd = "8884040443")
    {
        $this->load->library('curl');
        $this->load->library('WAY2SMSClient', "sms");
        $client = new WAY2SMSClient();
        if ($client->login($uid, $pwd)) {
            if (is_array($phone) && is_array($msg) && count($phone) >= 1 && count($msg) >= 1 && count($phone) == count($msg)) {
                foreach ($phone as $key => $val) {
                    $client->send($val, $msg[$key]);
                    sleep(8);
                }
            }
            $client->logout();
            return 1;
        } else {
            return 0;
        }

    }


    function send()
    {
        //$this->load->library('Textlocal');
        require('Textlocal.php');
        $textlocal = new Textlocal("vsd42032@gmail.com", ".adgjmptw1A");

        $numbers = array(919449751831);
        $sender = 'TXTLCL';
        $message = 'This is your message';

        $response = $textlocal->sendSms($numbers, $message, $sender);
        print_r($response);
    }


    function mail_duty()
    {
        $master = array();
        $settings = $this->master_db->getRecords("settings", array());
        $exam = $this->input->post("exam_id");
        $where = " ORDER BY e.db_date";

        $prof_sql = "SELECT DISTINCT (
					a.prof_id
					) AS pid
					FROM assigned_duties_{$exam} a,prof_{$exam} p
					WHERE  a.exam_id =  '{$exam}' AND a.prof_id=p.id ORDER BY p.dept ";

        $time_data = $this->master_db->execSQL($prof_sql);
        if (is_array($time_data) && count($time_data) >= 1)
            foreach ($time_data as $time) {
                $sql = "SELECT a.exam_id, b.email, a.date, e.m3start_time, e.m4start_time, e.a3start_time, e.a4start_time,a.m3, a.m4, a.a3, a.a4, a.m3_designation, a.m4_designation, a.a3_designation, a.a4_designation, b.name AS prof_name, c.name AS desig_name, d.name AS dept_name
				FROM assigned_duties_{$exam} a, prof_{$exam} b, designation c, dept d, time_table_{$exam} e
				WHERE a.prof_id = b.id
				AND b.designation = c.id
				AND b.dept = d.id
				AND a.exam_id = e.exam_id
				AND a.date = e.date
				AND a.exam_id = '{$exam}'
				AND a.prof_id = {$time->pid} ";

                $d = $this->master_db->execSQL($sql . $where);
                if (is_array($d) && count($d) >= 1)
                    $master[] = $d;

            } else
            redirect("dutyadmin");


        ignore_user_abort(True);
        set_time_limit(0);
        $tCount = count($master);

        if (is_array($settings) && count($settings) >= 1 && is_array($master) && count($master) >= 1) {
            $this->data["note_text"] = $settings[0]->rp_note_text;
        } else {
            redirect("dutyadmin");
        }
        $flag = true;
        $err = "";
        foreach ($master as $m_key => $m_value) {

            $this->data["report"] = array($master[$m_key]);
            $this->data["m_key"] = $m_key + 1;
            $this->data["head_text"] = $this->attach_variable($settings[0]->rp_text_head, $exam);
            $html = $this->load->view("mail_duty_to_prof", $this->data, true);

            if (($err = $this->mail_duty_to_prof($html, $m_value[0], $settings)) != 1) {
                $flag = false;
            }


        }
        if ($flag) {
            echo $err;
            $this->master_db->updateRecord("exam_id", array("exam_id" => $exam, "edited" => 0, "printed" => 1, "informed" => 1, "assigned" => 1), $exam, "exam_id");
            $this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Mail Sent Successfully..!!</div>');

        } else {
            $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Failed..!! Check Mail Password / Internet Connection</div>');
            echo $err;
        }

    }


    function mail_duty_to_prof($msg_body, $to_mail_id, $settings)
    {


        require_once "Mail/Mail.php";

        $from = $settings[0]->from_email;
        $to = $to_mail_id->email;
        $subject = $settings[0]->email_subject;
        $body = $this->attachVariable($settings[0]->email_text, $to_mail_id) . "<br><br><br><br>" . $msg_body;
        $pass = $settings[0]->email_password;

        $headers = array(
            'From' => $from,
            'To' => $to,
            'Subject' => $subject,
            'MIME-Version' => 1,
            'Content-type' => 'text/html;charset=iso-8859-1'
        );

        $smtp = @Mail::factory('smtp', array(
            'host' => 'ssl://smtp.gmail.com',
            'port' => '465',
            'auth' => true,
            'username' => $from,
            'password' => $pass
        ));

        $mail = @$smtp->send($to, $headers, $body);

        if (@PEAR::isError($mail)) {
            return ('<p>' . $mail->getMessage() . '</p>');
            //return 1;
        } else {
            return 1;
        }

    }


    function getEndTime($time, $hrs)
    {
        $date = new DateTime($time);
        $date->add(new DateInterval("PT{$hrs}H"));
        return $date->format('h:i A');
    }


    function duty_SMS()
    {
        $phone = array();
        $sms = array();
        //echo date("h:i A");
        //$exam_id = $this->input->get("exam_id");

        $exam_date = $this->master_db->getRecords("time_table_{$exam_id}", array("db_date" => date("Y/m/d"), "sms" => 0), "db_date ");
        $msg_text = $this->master_db->getRecords("settings", array(), "msg_text");
        if (is_array($msg_text))
            $msg_text = preg_replace("/\s|&nbsp;/", ' ', strip_tags($msg_text[0]->msg_text));
        $date = date('Y/m/d');

        if (is_array($exam_date) && count($exam_date) >= 1) {
            ignore_user_abort(True);
            set_time_limit(0);
            $to_be_sent = "SELECT DISTINCT (
					a.prof_id
					) AS pid, p.email
					FROM assigned_duties a,prof p
					WHERE a.prof_id=p.id AND a.db_date='{$date}' ORDER BY p.dept";
            $time_data = $this->master_db->execSQL($to_be_sent);

            if (is_array($time_data) && count($time_data) >= 1) {
                foreach ($time_data as $time) {
                    $sql = "SELECT a.exam_id, b.email, b.phone, a.date, e.m3start_time, e.m4start_time, e.a3start_time, e.a4start_time,a.m3, a.m4, a.a3, a.a4, a.m3_designation, a.m4_designation, a.a3_designation, a.a4_designation, b.name AS prof_name, c.name AS desig_name, d.name AS dept_name
				FROM assigned_duties a, prof b, designation c, dept d, time_table e
				WHERE a.prof_id = b.id
				AND b.designation = c.id
				AND b.dept = d.id
				AND a.exam_id = e.exam_id
				AND a.date = e.date
				AND a.db_date = '{$date}'
				AND a.prof_id = {$time->pid} ";

                    $d = $this->master_db->execSQL($sql);
                    if (is_array($d) && count($d) >= 1) {
                        foreach ($d as $d_val) {
                            $msg_to_send = $this->attachVariable($msg_text, $d_val);
                            $phone[] = $d_val->phone;
                            $sms[] = $msg_to_send;
                        }

                    }
                }
            }

            $res = $this->sendWay2SMS($phone, $sms);
            if ($res == 1) {

                $this->master_db->updateRecord("time_table", array("sms" => 1), $date, "db_date");
                $this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>SMS Sent..!!</div>');
            } else {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Failed..!! Check SMS Password / Internet Connection</div>');
            }


        } else {
            $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>No Exam Today <b>Or</b> SMS Already Sent..!!</div>');
        }


        redirect("master/timetable");
//		echo "<pre>";
//		print_r($phone);
//		echo "</pre>";

//		echo "<pre>--------------------------------------------------------------------------------------------<br>";
//		print_r($sms);
//		echo "</pre>";
    }


    function attachVariable($to_be_attached, $value)
    {
        $m_start = "-";
        $a_start = "-";
        $m_hr = 0;
        $a_hr = 0;
        $m_end = "-";
        $a_end = "-";
        $m_desig = "-";
        $a_desig = "-";


        if ($value->m3 != 0) {
            $m_start = $this->getEndTime($value->m3start_time, 0);
            $m_hr = 3;
            $m_end = $this->getEndTime($m_start, $m_hr);
            $m_desig = $value->m3_designation;
        } else if ($value->m4 != 0) {
            $m_start = $this->getEndTime($value->m4start_time, 0);
            $m_hr = 4;
            $m_end = $this->getEndTime($m_start, $m_hr);
            $m_desig = $value->m4_designation;
        }

        if ($value->a3 != 0) {
            $a_start = $this->getEndTime($value->a3start_time, 0);
            $a_hr = 3;
            $a_end = $this->getEndTime($a_start, $a_hr);
            $a_desig = $value->a3_designation;
        } else if ($value->a4 != 0) {
            $a_start = $this->getEndTime($value->a4start_time, 0);
            $a_hr = 4;
            $a_end = $this->getEndTime($a_start, $a_hr);
            $a_desig = $value->a4_designation;
        }

        if ($value->m3 == 1 && $value->m4 == 1) {
            $m_start = "<span style='color: red'>ERROR</span>";
            $m_hr = "<span style='color: red'>ERROR</span>";
            $m_end = "<span style='color: red'>ERROR</span>";
            $m_desig = "<span style='color: red'>ERROR</span>";
            $a_start = "<span style='color: red'>ERROR</span>";
            $a_hr = "<span style='color: red'>ERROR</span>";
            $a_end = "<span style='color: red'>ERROR</span>";
            $a_desig = "<span style='color: red'>ERROR</span>";
        }

        if ($value->a3 == 1 && $value->a4 == 1) {
            $a_start = "<span style='color: red'>ERROR</span>";
            $a_hr = "<span style='color: red'>ERROR</span>";
            $a_end = "<span style='color: red'>ERROR</span>";
            $a_desig = "<span style='color: red'>ERROR</span>";
            $m_start = "<span style='color: red'>ERROR</span>";
            $m_hr = "<span style='color: red'>ERROR</span>";
            $m_end = "<span style='color: red'>ERROR</span>";
            $m_desig = "<span style='color: red'>ERROR</span>";
        }

        $tags = array("[EXAM_ID]",
            "[DATE]",
            "[M_START_TIME]",
            "[M_END_TIME]",
            "[A_END_TIME]",
            "[A_START_TIME]",
            "[M_DESIGNATION]",
            "[A_DESIGNATION]",
            "[PROF_EMAIL]",
            "[PROF_NAME]",
            "[PROF_DESIG]",
            "[PROF_DEPT]");
        $rep_tags = array($value->exam_id,
            $value->date,
            $m_start,
            $m_end,
            $a_end,
            $a_start,
            $m_desig,
            $a_desig,
            $value->email,
            $value->prof_name,
            $value->desig_name,
            $value->dept_name);

        return str_replace("- and", "", str_replace("and -", "", str_replace($tags, $rep_tags, $to_be_attached)));
    }


    public function assign_duty_m()
    {
        if ($this->input->get("method") != "m") {
            redirect("master/timetable");
        } else {
            $exam_id=$ex_id = $this->input->get("id");
            $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $exam_id));

            if (is_array($flag_check) && count($flag_check) >= 1) {
                $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $this->input->get("id"), "informed" => 1));
                if (is_array($flag_check) && count($flag_check) >= 1) {
                    $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                    redirect("master/timetable");
                } else {
                    $this->data['table_data'] = $td = $this->master_db->getRecords("time_table_{$exam_id}", array("exam_id" => $this->input->get("id")), '*', 'id asc');
                    $RS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
                    $RLS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
                    $DS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

                    if (is_array($RS) && count($RS) >= 1) ;
                    //shuffle($RS);
                    else
                        $RS = array();
                    if (is_array($RLS) && count($RLS) >= 1) ;
                    //shuffle($RLS);
                    else
                        $RLS = array();
                    if (is_array($DS) && count($DS) >= 1) ;
                    //shuffle($DS);
                    else
                        $DS = array();

                    $RS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
                    $RLS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
                    $DS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

                    if (is_array($RS_ex) && count($RS_ex) >= 1) ;
                    //shuffle($RS_ex);
                    else
                        $RS_ex = array();
                    if (is_array($RLS_ex) && count($RLS_ex) >= 1) ;
                    //shuffle($RLS_ex);
                    else
                        $RLS_ex = array();
                    if (is_array($DS_ex) && count($DS_ex) >= 1) ;
                    //shuffle($DS_ex);
                    else
                        $DS_ex = array();


                    $RS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 1));
                    $RLS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 2, "status" => 1, "priority" => 1));
                    $DS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 3, "status" => 1, "priority" => 1));

                    if (is_array($RS_pri) && count($RS_pri) >= 1) ;
                    //shuffle($RS_pri);
                    else
                        $RS_pri = array();
                    if (is_array($RLS_pri) && count($RLS_pri) >= 1) ;
                    //shuffle($RLS_pri);
                    else
                        $RLS_pri = array();
                    if (is_array($DS_pri) && count($DS_pri) >= 1) ;
                    //shuffle($DS_pri);
                    else
                        $DS_pri = array();

                    //if(is_array($RS_pri) && count($RS_pri))
                    $RS = array_merge($RS_ex, array_merge($RS_pri, $RS));
                    //if(is_array($RLS_pri) && count($RLS_pri))
                    $RLS = array_merge($RLS_ex, array_merge($RLS_pri, $RLS));
                    //if(is_array($DS_pri) && count($DS_pri))
                    $DS = array_merge($DS_ex, array_merge($DS_pri, $DS));
                    $ex_dates = array();
                    $ex_dates_db = $this->master_db->getRecords("exclude_date_{$ex_id}", array());
                    if (is_array($ex_dates_db) && count($ex_dates_db) >= 1) {
                        foreach ($ex_dates_db as $val) {
                            if (!array_key_exists($val->prof_id, $ex_dates)) {
                                $ex_dates[$val->prof_id] = array();
                            }
                            $ex_dates[$val->prof_id][] = $val->date;
                        }
                    }

                    $this->data['RS'] = $RS;
                    $this->data['RLS'] = $RLS;
                    $this->data['DS'] = $DS;

                    $m3_str = array();
                    $m4_str = array();
                    $a3_str = array();
                    $a4_str = array();


                    $m3_rs_count = array();
                    $m3_rls_count = array();
                    $m3_ds_count = array();

                    $m4_rs_count = array();
                    $m4_rls_count = array();
                    $m4_ds_count = array();

                    $a3_rs_count = array();
                    $a3_rls_count = array();
                    $a3_ds_count = array();

                    $a4_rs_count = array();
                    $a4_rls_count = array();
                    $a4_ds_count = array();

                    $rs_max_duty = 0;
                    $rls_max_duty = 0;
                    $ds_max_duty = 0;

                    $counter = 0;
                    foreach ($td as $row) {
                        $m3 = 0;
                        $m4 = 0;
                        $a3 = 0;
                        $a4 = 0;
                        $m3_str[] = $row->m3strength;
                        $m4_str[] = $row->m4strength;
                        $a3_str[] = $row->a3strength;
                        $a4_str[] = $row->a4strength;
                        if ($row->m3strength != -1) {
                            $m3 += $row->m3strength;
                        }

                        if ($row->m4strength != -1) {
                            $m4 += $row->m4strength;
                        }

                        if ($row->a3strength != -1) {
                            $a3 += $row->a3strength;
                        }

                        if ($row->a4strength != -1) {
                            $a4 += $row->a4strength;
                        }

                        if ($m3 < 30) {
                            $m3_rs_count[] = ceil($m3 / 30);

                        } else {
                            $m3_rs_count[] = round($m3 / 30);

                        }
                        if ($a3 < 30) {
                            $a3_rs_count[] = ceil($a3 / 30);

                        } else {
                            $a3_rs_count[] = round($a3 / 30);

                        }
                        if ($m4 < 30) {
                            $m4_rs_count[] = ceil($m4 / 30);

                        } else {
                            $m4_rs_count[] = round($m4 / 30);

                        }
                        if ($a4 < 30) {
                            $a4_rs_count[] = ceil($a4 / 30);

                        } else {
                            $a4_rs_count[] = round($a4 / 30);

                        }

                        if ($m3 >= 76) {
                            if ($m3_rs_count[$counter] < 5)
                                $m3_rls_count[] = ceil(($m3_rs_count[$counter]) / 5);
                            else
                                $m3_rls_count[] = round(($m3_rs_count[$counter]) / 5);
                        } else {
                            $m3_rls_count[] = 0;
                        }

                        if ($a3 >= 76) {
                            if ($a3_rs_count[$counter] < 5)
                                $a3_rls_count[] = ceil(($a3_rs_count[$counter]) / 5);
                            else
                                $a3_rls_count[] = round(($a3_rs_count[$counter]) / 5);
                        } else {
                            $a3_rls_count[] = 0;
                        }

                        if ($m4 >= 76) {
                            if ($m4_rs_count[$counter] < 5)
                                $m4_rls_count[] = ceil(($m4_rs_count[$counter]) / 5);
                            else
                                $m4_rls_count[] = round(($m4_rs_count[$counter]) / 5);
                        } else {
                            $m4_rls_count[] = 0;
                        }

                        if ($a4 >= 76) {
                            if ($a4_rs_count[$counter] < 5)
                                $a4_rls_count[] = ceil(($a4_rs_count[$counter]) / 5);
                            else
                                $a4_rls_count[] = round(($a4_rs_count[$counter]) / 5);
                        } else {
                            $a4_rls_count[] = 0;
                        }


                        if ($m3 < 250) {

                            $m3_ds_count[] = ceil(($m3) / 250);
                        } else {

                            $m3_ds_count[] = round(($m3) / 250);
                        }
                        if ($a3 < 250) {

                            $a3_ds_count[] = ceil(($a3) / 250);
                        } else {

                            $a3_ds_count[] = round(($a3) / 250);
                        }
                        if ($m4 < 250) {

                            $m4_ds_count[] = ceil(($m4) / 250);
                        } else {

                            $m4_ds_count[] = round(($m4) / 250);
                        }
                        if ($a4 < 250) {

                            $a4_ds_count[] = ceil(($a4) / 250);
                        } else {

                            $a4_ds_count[] = round(($a4) / 250);
                        }

                        $rs_max_duty += $m3_rs_count[$counter] + $a3_rs_count[$counter] + $m4_rs_count[$counter] + $a4_rs_count[$counter];
                        $rls_max_duty += $m3_rls_count[$counter] + $a3_rls_count[$counter] + $m4_rls_count[$counter] + $a4_rls_count[$counter];
                        $ds_max_duty += $m3_ds_count[$counter] + $a3_ds_count[$counter] + $m4_ds_count[$counter] + $a4_ds_count[$counter];
                        $counter++;
                    }

                    $this->data["m3_rs_count"] = $m3_rs_count;
                    $this->data["a3_rs_count"] = $a3_rs_count;

                    $this->data["m4_rs_count"] = $m4_rs_count;
                    $this->data["a4_rs_count"] = $a4_rs_count;

                    $this->data["m3_rls_count"] = $m3_rls_count;
                    $this->data["a3_rls_count"] = $a3_rls_count;

                    $this->data["m4_rls_count"] = $m4_rls_count;
                    $this->data["a4_rls_count"] = $a4_rls_count;

                    $this->data["m3_ds_count"] = $m3_ds_count;
                    $this->data["a3_ds_count"] = $a3_ds_count;

                    $this->data["m4_ds_count"] = $m4_ds_count;
                    $this->data["a4_ds_count"] = $a4_ds_count;

                    $this->data["rs_count"] = $rs_max_duty;
                    $this->data["rls_count"] = $rls_max_duty;
                    $this->data["ds_count"] = $ds_max_duty;

                    $settings = $this->master_db->getRecords("settings", array());
                    $rs_priority_duty = $settings[0]->rs_priority_duty;
                    $rls_priority_duty = $settings[0]->rls_priority_duty;
                    $ds_priority_duty = $settings[0]->ds_priority_duty;


                    $rs_max_duty_temp = ceil($rs_max_duty / count($RS));
                    $rls_max_duty_temp = ceil($rls_max_duty / count($RLS));
                    $ds_max_duty_temp = ceil($ds_max_duty / count($DS));

                    if ($rs_priority_duty < $rs_max_duty_temp && is_array($RS_pri) && count($RS_pri) >= 1 && $rs_priority_duty >= 1) {
                        $this->data["rs_max_duty"] = $rs_max_duty = ceil(($rs_max_duty + (($rs_max_duty_temp - $rs_priority_duty) * count($RS_pri))) / count($RS));
                    } else {
                        $this->data["rs_max_duty"] = $rs_max_duty = ceil($rs_max_duty / count($RS));
                    }

                    if ($rls_priority_duty < $rls_max_duty_temp && is_array($RLS_pri) && count($RLS_pri) >= 1 && $rls_priority_duty >= 1) {
                        $this->data["rls_max_duty"] = $rls_max_duty = ceil(($rls_max_duty + (($rls_max_duty_temp - $rls_priority_duty) * count($RLS_pri))) / count($RLS));
                    } else {
                        $this->data["rls_max_duty"] = $rls_max_duty = ceil($rls_max_duty / count($RLS));
                    }


                    if ($ds_priority_duty < $ds_max_duty_temp && is_array($DS_pri) && count($DS_pri) >= 1 && $ds_priority_duty >= 1) {
                        $this->data["ds_max_duty"] = $ds_max_duty = ceil(($ds_max_duty + (($ds_max_duty_temp - $ds_priority_duty) * count($DS_pri))) / count($DS));
                    } else {
                        $this->data["ds_max_duty"] = $ds_max_duty = ceil($ds_max_duty / count($DS));
                    }

                    $master = array();

                    $rs_total_duty = 0;
                    $rs_index = 0;
                    foreach ($RS as $rs_rand) {
                        if (!array_key_exists($rs_rand->id, $ex_dates)) {
                            $ex_dates[$rs_rand->id] = array();
                        }
                        if ($rs_rand->priority && $rs_priority_duty >= 1 && $rs_priority_duty < $this->data["rs_max_duty"])
                            $rs_max_duty = $rs_priority_duty;
                        else
                            $rs_max_duty = $this->data["rs_max_duty"];
                        $duty_counter = 0;
                        $mr_counter = 0;
                        $aft_counter = 0;
                        $rs_index++;
                        if ($rs_index >= 15) {
                            $rs_max_duty++;
                        }
                        foreach ($td as $time_data) {
                            //echo $rs_total_duty."<br>";

                            $m3_flag = 1;
                            if ($duty_counter != $rs_max_duty && !in_array($time_data->db_date, $ex_dates[$rs_rand->id])) {
                                if ($m3_rs_count[$mr_counter] != 0 && $duty_counter != $rs_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
                                    $duty_counter++;
                                    $m3_rs_count[$mr_counter]--;
                                    $m3_flag = 0;
                                    $rs_total_duty++;
                                }


                                if ($m3_flag)
                                    if ($m4_rs_count[$mr_counter] != 0 & $duty_counter != $rs_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][0][0]["m4"][$rs_rand->name] = $rs_rand->id;
                                        $duty_counter++;
                                        $m4_rs_count[$mr_counter]--;
                                        $rs_total_duty++;
                                    }


                            }


                            $mr_counter++;
                        }
                        foreach ($td as $time_data) {

                            $a3_flag = 1;

                            if ($duty_counter != $rs_max_duty && !in_array($time_data->db_date, $ex_dates[$rs_rand->id])) {


                                if ($a3_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
                                    $duty_counter++;
                                    $a3_rs_count[$aft_counter]--;
                                    $a3_flag = 0;
                                    $rs_total_duty++;

                                }


                                if ($a3_flag)
                                    if ($a4_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][0][1]["a4"][$rs_rand->name] = $rs_rand->id;
                                        $duty_counter++;
                                        $a4_rs_count[$aft_counter]--;
                                        $rs_total_duty++;
                                    }
                            }


                            $aft_counter++;
                        }


                    }
                    echo $rs_total_duty;
                    foreach ($a3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }


                    foreach ($RLS as $rls_rand) {
                        if (!array_key_exists($rls_rand->id, $ex_dates)) {
                            $ex_dates[$rls_rand->id] = array();
                        }
                        if ($rls_rand->priority && $rls_priority_duty >= 1 && $rls_priority_duty < $this->data["rls_max_duty"])
                            $rls_max_duty = $rls_priority_duty;
                        else
                            $rls_max_duty = $this->data["rls_max_duty"];
                        $duty_counter = 0;
                        $mr_counter = 0;
                        $aft_counter = 0;
                        foreach ($td as $time_data) {
                            $m3_flag = 1;
                            if ($duty_counter != $rls_max_duty && !in_array($time_data->db_date, $ex_dates[$rls_rand->id])) {
                                if ($m3_rls_count[$mr_counter] != 0 && $duty_counter != $rls_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][1][0]["m3"][$rls_rand->name] = $rls_rand->id;
                                    $duty_counter++;
                                    $m3_rls_count[$mr_counter]--;
                                    $m3_flag = 0;
                                }


                                if ($m3_flag)
                                    if ($m4_rls_count[$mr_counter] != 0 & $duty_counter != $rls_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][1][0]["m4"][$rls_rand->name] = $rls_rand->id;
                                        $duty_counter++;
                                        $m4_rls_count[$mr_counter]--;
                                    }


                            }


                            $mr_counter++;
                        }
                        foreach ($td as $time_data) {

                            $a3_flag = 1;

                            if ($duty_counter != $rls_max_duty && !in_array($time_data->db_date, $ex_dates[$rls_rand->id])) {


                                if ($a3_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][1][1]["a3"][$rls_rand->name] = $rls_rand->id;
                                    $duty_counter++;
                                    $a3_rls_count[$aft_counter]--;
                                    $a3_flag = 0;

                                }


                                if ($a3_flag)
                                    if ($a4_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][1][1]["a4"][$rls_rand->name] = $rls_rand->id;
                                        $duty_counter++;
                                        $a4_rls_count[$aft_counter]--;
                                    }
                            }


                            $aft_counter++;
                        }
                    }

                    foreach ($a3_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($DS as $ds_rand) {
                        if (!array_key_exists($ds_rand->id, $ex_dates)) {
                            $ex_dates[$ds_rand->id] = array();
                        }
                        if ($ds_rand->priority && $ds_priority_duty >= 1 && $ds_priority_duty < $this->data["ds_max_duty"])
                            $ds_max_duty = $ds_priority_duty;
                        else
                            $ds_max_duty = $this->data["ds_max_duty"];
                        $duty_counter = 0;
                        $mr_counter = 0;
                        $aft_counter = 0;
                        foreach ($td as $time_data) {
                            $m3_flag = 1;
                            if ($duty_counter != $ds_max_duty && !in_array($time_data->db_date, $ex_dates[$ds_rand->id])) {
                                if ($m3_ds_count[$mr_counter] != 0 && $duty_counter != $ds_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][2][0]["m3"][$ds_rand->name] = $ds_rand->id;
                                    $duty_counter++;
                                    $m3_ds_count[$mr_counter]--;
                                    $m3_flag = 0;
                                }


                                if ($m3_flag)
                                    if ($m4_ds_count[$mr_counter] != 0 & $duty_counter != $ds_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][2][0]["m4"][$ds_rand->name] = $ds_rand->id;
                                        $duty_counter++;
                                        $m4_ds_count[$mr_counter]--;
                                    }


                            }


                            $mr_counter++;
                        }
                        foreach ($td as $time_data) {

                            $a3_flag = 1;

                            if ($duty_counter != $ds_max_duty && !in_array($time_data->db_date, $ex_dates[$ds_rand->id])) {


                                if ($a3_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][2][1]["a3"][$ds_rand->name] = $ds_rand->id;
                                    $duty_counter++;
                                    $a3_ds_count[$aft_counter]--;
                                    $a3_flag = 0;

                                }


                                if ($a3_flag)
                                    if ($a4_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][2][1]["a4"][$ds_rand->name] = $ds_rand->id;
                                        $duty_counter++;
                                        $a4_ds_count[$aft_counter]--;
                                    }
                            }


                            $aft_counter++;
                        }
                    }

                    foreach ($a3_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }


                    $this->data["populate"] = $master;
                    $this->data["populate"] = $master;
                    $this->data["m3_str"] = $m3_str;
                    $this->data["m4_str"] = $m4_str;
                    $this->data["a3_str"] = $a3_str;
                    $this->data["a4_str"] = $a4_str;
                    $this->load->view("assign_duty1", $this->data);
                    //echo "<pre>".print_r($master,true)."</pre>";


                }
            } else {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                redirect("master/timetable");
            }


        }

    }

    public function assign_duty_s()
    {
        if ($this->input->get("method") != "s") {
            redirect("master/timetable");
        } else {
            $exam_id =$ex_id = $this->input->get("id");
            $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $this->input->get("id")));

            if (is_array($flag_check) && count($flag_check) >= 1) {
                $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $this->input->get("id"), "informed" => 1));
                if (is_array($flag_check) && count($flag_check) >= 1) {
                    $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                    redirect("master/timetable");
                } else {

                    $this->data['table_data'] = $td = $this->master_db->getRecords("time_table_{$exam_id}", array("exam_id" => $this->input->get("id")), '*', 'id asc');
                    $RS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
                    $RLS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
                    $DS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

                    if (is_array($RS) && count($RS) >= 1) ;
                    //shuffle($RS);
                    else
                        $RS = array();
                    if (is_array($RLS) && count($RLS) >= 1) ;
                    //shuffle($RLS);
                    else
                        $RLS = array();
                    if (is_array($DS) && count($DS) >= 1) ;
                    //shuffle($DS);
                    else
                        $DS = array();

                    $RS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
                    $RLS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
                    $DS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

                    if (is_array($RS_ex) && count($RS_ex) >= 1) ;
                    //shuffle($RS_ex);
                    else
                        $RS_ex = array();
                    if (is_array($RLS_ex) && count($RLS_ex) >= 1) ;
                    //shuffle($RLS_ex);
                    else
                        $RLS_ex = array();
                    if (is_array($DS_ex) && count($DS_ex) >= 1) ;
                    //shuffle($DS_ex);
                    else
                        $DS_ex = array();


                    $RS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 1));
                    $RLS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 2, "status" => 1, "priority" => 1));
                    $DS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 3, "status" => 1, "priority" => 1));

                    if (is_array($RS_pri) && count($RS_pri) >= 1) ;
                    //shuffle($RS_pri);
                    else
                        $RS_pri = array();
                    if (is_array($RLS_pri) && count($RLS_pri) >= 1) ;
                    //shuffle($RLS_pri);
                    else
                        $RLS_pri = array();
                    if (is_array($DS_pri) && count($DS_pri) >= 1) ;
                    //shuffle($DS_pri);
                    else
                        $DS_pri = array();

                    //if(is_array($RS_pri) && count($RS_pri))
                    $RS = array_merge($RS_ex, array_merge($RS_pri, $RS));
                    //if(is_array($RLS_pri) && count($RLS_pri))
                    $RLS = array_merge($RLS_ex, array_merge($RLS_pri, $RLS));
                    //if(is_array($DS_pri) && count($DS_pri))
                    $DS = array_merge($DS_ex, array_merge($DS_pri, $DS));
                    $ex_dates = array();
                    $ex_dates_db = $this->master_db->getRecords("exclude_date_{$ex_id}", array());
                    if (is_array($ex_dates_db) && count($ex_dates_db) >= 1) {
                        foreach ($ex_dates_db as $val) {
                            if (!array_key_exists($val->prof_id, $ex_dates)) {
                                $ex_dates[$val->prof_id] = array();
                            }
                            $ex_dates[$val->prof_id][] = $val->date;
                        }
                    }

                    $this->data['RS'] = $RS;
                    $this->data['RLS'] = $RLS;
                    $this->data['DS'] = $DS;


                    $m3_str = array();
                    $m4_str = array();
                    $a3_str = array();
                    $a4_str = array();


                    $m3_rs_count = array();
                    $m3_rls_count = array();
                    $m3_ds_count = array();

                    $m4_rs_count = array();
                    $m4_rls_count = array();
                    $m4_ds_count = array();

                    $a3_rs_count = array();
                    $a3_rls_count = array();
                    $a3_ds_count = array();

                    $a4_rs_count = array();
                    $a4_rls_count = array();
                    $a4_ds_count = array();

                    $rs_max_duty = 0;
                    $rls_max_duty = 0;
                    $ds_max_duty = 0;

                    $counter = 0;
                    foreach ($td as $row) {
                        $m3 = 0;
                        $m4 = 0;
                        $a3 = 0;
                        $a4 = 0;
                        $m3_str[] = $row->m3strength;
                        $m4_str[] = $row->m4strength;
                        $a3_str[] = $row->a3strength;
                        $a4_str[] = $row->a4strength;
                        if ($row->m3strength != -1) {
                            $m3 += $row->m3strength;
                        }

                        if ($row->m4strength != -1) {
                            $m4 += $row->m4strength;
                        }

                        if ($row->a3strength != -1) {
                            $a3 += $row->a3strength;
                        }

                        if ($row->a4strength != -1) {
                            $a4 += $row->a4strength;
                        }

                        if ($m3 < 30) {
                            $m3_rs_count[] = ceil($m3 / 30);

                        } else {
                            $m3_rs_count[] = round($m3 / 30);

                        }
                        if ($a3 < 30) {
                            $a3_rs_count[] = ceil($a3 / 30);

                        } else {
                            $a3_rs_count[] = round($a3 / 30);

                        }
                        if ($m4 < 30) {
                            $m4_rs_count[] = ceil($m4 / 30);

                        } else {
                            $m4_rs_count[] = round($m4 / 30);

                        }
                        if ($a4 < 30) {
                            $a4_rs_count[] = ceil($a4 / 30);

                        } else {
                            $a4_rs_count[] = round($a4 / 30);

                        }

                        if ($m3 >= 76) {
                            if ($m3_rs_count[$counter] < 5)
                                $m3_rls_count[] = ceil(($m3_rs_count[$counter]) / 5);
                            else
                                $m3_rls_count[] = round(($m3_rs_count[$counter]) / 5);
                        } else {
                            $m3_rls_count[] = 0;
                        }

                        if ($a3 >= 76) {
                            if ($a3_rs_count[$counter] < 5)
                                $a3_rls_count[] = ceil(($a3_rs_count[$counter]) / 5);
                            else
                                $a3_rls_count[] = round(($a3_rs_count[$counter]) / 5);
                        } else {
                            $a3_rls_count[] = 0;
                        }

                        if ($m4 >= 76) {
                            if ($m4_rs_count[$counter] < 5)
                                $m4_rls_count[] = ceil(($m4_rs_count[$counter]) / 5);
                            else
                                $m4_rls_count[] = round(($m4_rs_count[$counter]) / 5);
                        } else {
                            $m4_rls_count[] = 0;
                        }

                        if ($a4 >= 76) {
                            if ($a4_rs_count[$counter] < 5)
                                $a4_rls_count[] = ceil(($a4_rs_count[$counter]) / 5);
                            else
                                $a4_rls_count[] = round(($a4_rs_count[$counter]) / 5);
                        } else {
                            $a4_rls_count[] = 0;
                        }


                        if ($m3 < 250) {

                            $m3_ds_count[] = ceil(($m3) / 250);
                        } else {

                            $m3_ds_count[] = round(($m3) / 250);
                        }
                        if ($a3 < 250) {

                            $a3_ds_count[] = ceil(($a3) / 250);
                        } else {

                            $a3_ds_count[] = round(($a3) / 250);
                        }
                        if ($m4 < 250) {

                            $m4_ds_count[] = ceil(($m4) / 250);
                        } else {

                            $m4_ds_count[] = round(($m4) / 250);
                        }
                        if ($a4 < 250) {

                            $a4_ds_count[] = ceil(($a4) / 250);
                        } else {

                            $a4_ds_count[] = round(($a4) / 250);
                        }

                        $rs_max_duty += $m3_rs_count[$counter] + $a3_rs_count[$counter] + $m4_rs_count[$counter] + $a4_rs_count[$counter];
                        $rls_max_duty += $m3_rls_count[$counter] + $a3_rls_count[$counter] + $m4_rls_count[$counter] + $a4_rls_count[$counter];
                        $ds_max_duty += $m3_ds_count[$counter] + $a3_ds_count[$counter] + $m4_ds_count[$counter] + $a4_ds_count[$counter];
                        $counter++;
                    }

                    $this->data["m3_rs_count"] = $m3_rs_count;
                    $this->data["a3_rs_count"] = $a3_rs_count;

                    $this->data["m4_rs_count"] = $m4_rs_count;
                    $this->data["a4_rs_count"] = $a4_rs_count;

                    $this->data["m3_rls_count"] = $m3_rls_count;
                    $this->data["a3_rls_count"] = $a3_rls_count;

                    $this->data["m4_rls_count"] = $m4_rls_count;
                    $this->data["a4_rls_count"] = $a4_rls_count;

                    $this->data["m3_ds_count"] = $m3_ds_count;
                    $this->data["a3_ds_count"] = $a3_ds_count;

                    $this->data["m4_ds_count"] = $m4_ds_count;
                    $this->data["a4_ds_count"] = $a4_ds_count;

                    $this->data["rs_count"] = $rs_max_duty;
                    $this->data["rls_count"] = $rls_max_duty;
                    $this->data["ds_count"] = $ds_max_duty;

                    $settings = $this->master_db->getRecords("settings", array());
                    $rs_priority_duty = $settings[0]->rs_priority_duty;
                    $rls_priority_duty = $settings[0]->rls_priority_duty;
                    $ds_priority_duty = $settings[0]->ds_priority_duty;


                    $rs_max_duty_temp = ceil($rs_max_duty / count($RS));
                    $rls_max_duty_temp = ceil($rls_max_duty / count($RLS));
                    $ds_max_duty_temp = ceil($ds_max_duty / count($DS));

                    if ($rs_priority_duty < $rs_max_duty_temp && is_array($RS_pri) && count($RS_pri) >= 1 && $rs_priority_duty >= 1) {
                        $this->data["rs_max_duty"] = $rs_max_duty = ceil(($rs_max_duty + (($rs_max_duty_temp - $rs_priority_duty) * count($RS_pri))) / count($RS));
                    } else {
                        $this->data["rs_max_duty"] = $rs_max_duty = ceil($rs_max_duty / count($RS));
                    }

                    if ($rls_priority_duty < $rls_max_duty_temp && is_array($RLS_pri) && count($RLS_pri) >= 1 && $rls_priority_duty >= 1) {
                        $this->data["rls_max_duty"] = $rls_max_duty = ceil(($rls_max_duty + (($rls_max_duty_temp - $rls_priority_duty) * count($RLS_pri))) / count($RLS));
                    } else {
                        $this->data["rls_max_duty"] = $rls_max_duty = ceil($rls_max_duty / count($RLS));
                    }


                    if ($ds_priority_duty < $ds_max_duty_temp && is_array($DS_pri) && count($DS_pri) >= 1 && $ds_priority_duty >= 1) {
                        $this->data["ds_max_duty"] = $ds_max_duty = ceil(($ds_max_duty + (($ds_max_duty_temp - $ds_priority_duty) * count($DS_pri))) / count($DS));
                    } else {
                        $this->data["ds_max_duty"] = $ds_max_duty = ceil($ds_max_duty / count($DS));
                    }

                    $master = array();
                    $rs_duty_counter_array = array();
                    $rls_duty_counter_array = array();
                    $ds_duty_counter_array = array();
                    $counter = 0;
                    foreach ($td as $timeTable) {
                        {//RS

                            foreach ($RS as $key => $rs_person) {
                                if (!array_key_exists($rs_person->id, $ex_dates)) {
                                    $ex_dates[$rs_person->id] = array();
                                }
                                $m3_rs__duty = false;

                                if (!array_key_exists($rs_person->id, $rs_duty_counter_array)) {
                                    if ($rs_person->priority && $rs_priority_duty >= 1 && $rs_priority_duty < $this->data["rs_max_duty"])
                                        $rs_duty_counter_array[$rs_person->id] = $rs_priority_duty;
                                    else
                                        $rs_duty_counter_array[$rs_person->id] = $this->data["rs_max_duty"];
                                }

                                if ($rs_duty_counter_array[$rs_person->id] != 0 && $m3_rs_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$rs_person->id])) {
                                    $master[$this->getDateTag($timeTable->date)][0][0]["m3"][$rs_person->name] = $rs_person->id;
                                    $rs_duty_counter_array[$rs_person->id]--;
                                    $m3_rs_count[$counter]--;
                                    $m3_rs__duty = true;
                                    $RS[] = $rs_person;
                                    unset($RS[$key]);
                                }

                                if (!$m3_rs__duty) {
                                    if ($rs_duty_counter_array[$rs_person->id] != 0 && $m4_rs_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$rs_person->id])) {
                                        $master[$this->getDateTag($timeTable->date)][0][0]["m4"][$rs_person->name] = $rs_person->id;
                                        $rs_duty_counter_array[$rs_person->id]--;
                                        $m4_rs_count[$counter]--;
                                        $RS[] = $rs_person;
                                        unset($RS[$key]);
                                    }

                                }

                            }

                            foreach ($RS as $key => $rs_person) {

                                $a3_rs_duty = false;
                                if (!array_key_exists($rs_person->id, $rs_duty_counter_array)) {
                                    if ($rs_person->priority && $rs_priority_duty >= 1 && $rs_priority_duty < $this->data["rs_max_duty"])
                                        $rs_duty_counter_array[$rs_person->id] = $rs_priority_duty;
                                    else
                                        $rs_duty_counter_array[$rs_person->id] = $this->data["rs_max_duty"];
                                }
                                if ($rs_duty_counter_array[$rs_person->id] != 0 && $a3_rs_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$rs_person->id])) {
                                    $master[$this->getDateTag($timeTable->date)][0][1]["a3"][$rs_person->name] = $rs_person->id;
                                    $rs_duty_counter_array[$rs_person->id]--;
                                    $a3_rs_count[$counter]--;
                                    $a3_rs_duty = true;
                                    $RS[] = $rs_person;
                                    unset($RS[$key]);
                                }

                                if (!$a3_rs_duty) {
                                    if ($rs_duty_counter_array[$rs_person->id] != 0 && $a4_rs_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$rs_person->id])) {
                                        $master[$this->getDateTag($timeTable->date)][0][1]["a4"][$rs_person->name] = $rs_person->id;
                                        $rs_duty_counter_array[$rs_person->id]--;
                                        $a4_rs_count[$counter]--;
                                        $RS[] = $rs_person;
                                        unset($RS[$key]);

                                    }

                                }

                            }
                            //echo $m3_rs_count[$counter]+$m4_rs_count[$counter]+$a3_rs_count[$counter]+$a4_rs_count[$counter]." ".$timeTable->date."<br>";


                        }

//--------------------------------------------------------------------------------------------------------------------------------------------------
                        {//RLS

                            foreach ($RLS as $key => $rls_person) {
                                if (!array_key_exists($rls_person->id, $ex_dates)) {
                                    $ex_dates[$rls_person->id] = array();
                                }
                                $m3_rls__duty = false;

                                if (!array_key_exists($rls_person->id, $rls_duty_counter_array)) {
                                    if ($rls_person->priority && $rls_priority_duty >= 1 && $rls_priority_duty < $this->data["rls_max_duty"])
                                        $rls_duty_counter_array[$rls_person->id] = $rls_priority_duty;
                                    else
                                        $rls_duty_counter_array[$rls_person->id] = $this->data["rls_max_duty"];
                                }
                                if ($rls_duty_counter_array[$rls_person->id] != 0 && $m3_rls_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$rls_person->id])) {
                                    $master[$this->getDateTag($timeTable->date)][1][0]["m3"][$rls_person->name] = $rls_person->id;
                                    $rls_duty_counter_array[$rls_person->id]--;
                                    $m3_rls_count[$counter]--;
                                    $m3_rls__duty = true;
                                    $RLS[] = $rls_person;
                                    unset($RLS[$key]);
                                }

                                if (!$m3_rls__duty) {
                                    if ($rls_duty_counter_array[$rls_person->id] != 0 && $m4_rls_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$rls_person->id])) {
                                        $master[$this->getDateTag($timeTable->date)][1][0]["m4"][$rls_person->name] = $rls_person->id;
                                        $rls_duty_counter_array[$rls_person->id]--;
                                        $m4_rls_count[$counter]--;
                                        $RLS[] = $rls_person;
                                        unset($RLS[$key]);
                                    }

                                }

                            }

                            foreach ($RLS as $key => $rls_person) {

                                $a3_rls_duty = false;
                                if (!array_key_exists($rls_person->id, $rls_duty_counter_array)) {
                                    if ($rls_person->priority && $rls_priority_duty >= 1 && $rls_priority_duty < $this->data["rls_max_duty"])
                                        $rls_duty_counter_array[$rls_person->id] = $rls_priority_duty;
                                    else
                                        $rls_duty_counter_array[$rls_person->id] = $this->data["rls_max_duty"];
                                }
                                if ($rls_duty_counter_array[$rls_person->id] != 0 && $a3_rls_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$rls_person->id])) {
                                    $master[$this->getDateTag($timeTable->date)][1][1]["a3"][$rls_person->name] = $rls_person->id;
                                    $rls_duty_counter_array[$rls_person->id]--;
                                    $a3_rls_count[$counter]--;
                                    $a3_rls_duty = true;
                                    $RLS[] = $rls_person;
                                    unset($RLS[$key]);
                                }

                                if (!$a3_rls_duty) {
                                    if ($rls_duty_counter_array[$rls_person->id] != 0 && $a4_rls_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$rls_person->id])) {
                                        $master[$this->getDateTag($timeTable->date)][1][1]["a4"][$rls_person->name] = $rls_person->id;
                                        $rls_duty_counter_array[$rls_person->id]--;
                                        $a4_rls_count[$counter]--;
                                        $RLS[] = $rls_person;
                                        unset($RLS[$key]);

                                    }

                                }

                            }
                            //echo $m3_rls_count[$counter]+$m4_rls_count[$counter]+$a3_rls_count[$counter]+$a4_rls_count[$counter]." ".$timeTable->date."<br>";


                        }
//------------------------------------------------------------------------------------------------------------------------------------------------
                        {//DS

                            foreach ($DS as $key => $ds_person) {
                                if (!array_key_exists($ds_person->id, $ex_dates)) {
                                    $ex_dates[$ds_person->id] = array();
                                }
                                $m3_ds__duty = false;

                                if (!array_key_exists($ds_person->id, $ds_duty_counter_array)) {
                                    if ($ds_person->priority && $ds_priority_duty >= 1 && $ds_priority_duty < $this->data["ds_max_duty"])
                                        $ds_duty_counter_array[$ds_person->id] = $ds_priority_duty;
                                    else
                                        $ds_duty_counter_array[$ds_person->id] = $this->data["ds_max_duty"];
                                }
                                if ($ds_duty_counter_array[$ds_person->id] != 0 && $m3_ds_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$ds_person->id])) {
                                    $master[$this->getDateTag($timeTable->date)][2][0]["m3"][$ds_person->name] = $ds_person->id;
                                    $ds_duty_counter_array[$ds_person->id]--;
                                    $m3_ds_count[$counter]--;
                                    $m3_ds__duty = true;
                                    $DS[] = $ds_person;
                                    unset($DS[$key]);
                                }

                                if (!$m3_ds__duty) {
                                    if ($ds_duty_counter_array[$ds_person->id] != 0 && $m4_ds_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$ds_person->id])) {
                                        $master[$this->getDateTag($timeTable->date)][2][0]["m4"][$ds_person->name] = $ds_person->id;
                                        $ds_duty_counter_array[$ds_person->id]--;
                                        $m4_ds_count[$counter]--;
                                        $DS[] = $ds_person;
                                        unset($DS[$key]);
                                    }

                                }

                            }

                            foreach ($DS as $key => $ds_person) {

                                $a3_ds_duty = false;
                                if (!array_key_exists($ds_person->id, $ds_duty_counter_array)) {
                                    if ($ds_person->priority && $ds_priority_duty >= 1 && $ds_priority_duty < $this->data["ds_max_duty"])
                                        $ds_duty_counter_array[$ds_person->id] = $ds_priority_duty;
                                    else
                                        $ds_duty_counter_array[$ds_person->id] = $this->data["ds_max_duty"];
                                }
                                if ($ds_duty_counter_array[$ds_person->id] != 0 && $a3_ds_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$ds_person->id])) {
                                    $master[$this->getDateTag($timeTable->date)][2][1]["a3"][$ds_person->name] = $ds_person->id;
                                    $ds_duty_counter_array[$ds_person->id]--;
                                    $a3_ds_count[$counter]--;
                                    $a3_ds_duty = true;
                                    $DS[] = $ds_person;
                                    unset($DS[$key]);
                                }

                                if (!$a3_ds_duty) {
                                    if ($ds_duty_counter_array[$ds_person->id] != 0 && $a4_ds_count[$counter] != 0 && !in_array($timeTable->db_date, $ex_dates[$ds_person->id])) {
                                        $master[$this->getDateTag($timeTable->date)][2][1]["a4"][$ds_person->name] = $ds_person->id;
                                        $ds_duty_counter_array[$ds_person->id]--;
                                        $a4_ds_count[$counter]--;
                                        $DS[] = $ds_person;
                                        unset($DS[$key]);
                                    }
                                }
                            }
                            //echo $m3_ds_count[$counter]+$m4_ds_count[$counter]+$a3_ds_count[$counter]+$a4_ds_count[$counter]." ".$timeTable->date."<br>";
                        }
                        $counter++;
                    }

                    foreach ($a3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }


                    foreach ($m4_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }


                    foreach ($a3_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }


                    foreach ($a3_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

//		echo "<pre>".print_r($master,true)."</pre>-----------------------------------------------------------------------";
//		echo "<pre>".print_r($rs_duty_counter_array,true)."</pre>";
                    $this->data["populate"] = $master;
                    $this->data["m3_str"] = $m3_str;
                    $this->data["m4_str"] = $m4_str;
                    $this->data["a3_str"] = $a3_str;
                    $this->data["a4_str"] = $a4_str;
                    $this->load->view("assign_duty1", $this->data);
                }
            } else {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                redirect("master/timetable");
            }


        }

    }

    public function assign_duty_c()
    {
        if ($this->input->get("method") != "c") {
            redirect("master/timetable");
        } else {
            $exam_id =$ex_id= $this->input->get("id");
            $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $this->input->get("id")));

            if (is_array($flag_check) && count($flag_check) >= 1) {
                $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $this->input->get("id"), "informed" => 1));
                if (is_array($flag_check) && count($flag_check) >= 1) {
                    $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                    redirect("master/timetable");
                } else {

                    $this->data['table_data'] = $td = $this->master_db->getRecords("time_table_{$exam_id}", array("exam_id" => $this->input->get("id")), '*', 'id asc');
                    $RS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
                    $RLS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
                    $DS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

                    if (is_array($RS) && count($RS) >= 1) ;
                    //shuffle($RS);
                    else
                        $RS = array();
                    if (is_array($RLS) && count($RLS) >= 1) ;
                    //shuffle($RLS);
                    else
                        $RLS = array();
                    if (is_array($DS) && count($DS) >= 1) ;
                    //shuffle($DS);
                    else
                        $DS = array();

                    $RS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
                    $RLS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
                    $DS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

                    if (is_array($RS_ex) && count($RS_ex) >= 1) ;
                    //shuffle($RS_ex);
                    else
                        $RS_ex = array();
                    if (is_array($RLS_ex) && count($RLS_ex) >= 1) ;
                    //shuffle($RLS_ex);
                    else
                        $RLS_ex = array();
                    if (is_array($DS_ex) && count($DS_ex) >= 1) ;
                    //shuffle($DS_ex);
                    else
                        $DS_ex = array();


                    $RS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 1));
                    $RLS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 2, "status" => 1, "priority" => 1));
                    $DS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 3, "status" => 1, "priority" => 1));

                    if (is_array($RS_pri) && count($RS_pri) >= 1) ;
                    //shuffle($RS_pri);
                    else
                        $RS_pri = array();
                    if (is_array($RLS_pri) && count($RLS_pri) >= 1) ;
                    //shuffle($RLS_pri);
                    else
                        $RLS_pri = array();
                    if (is_array($DS_pri) && count($DS_pri) >= 1) ;
                    //shuffle($DS_pri);
                    else
                        $DS_pri = array();

                    //if(is_array($RS_pri) && count($RS_pri))
                    $RS = array_merge($RS_ex, array_merge($RS_pri, $RS));
                    //if(is_array($RLS_pri) && count($RLS_pri))
                    $RLS = array_merge($RLS_ex, array_merge($RLS_pri, $RLS));
                    //if(is_array($DS_pri) && count($DS_pri))
                    $DS = array_merge($DS_ex, array_merge($DS_pri, $DS));
                    $ex_dates = array();
                    $ex_dates_db = $this->master_db->getRecords("exclude_date_{$ex_id}", array());
                    if (is_array($ex_dates_db) && count($ex_dates_db) >= 1) {
                        foreach ($ex_dates_db as $val) {
                            if (!array_key_exists($val->prof_id, $ex_dates)) {
                                $ex_dates[$val->prof_id] = array();
                            }
                            $ex_dates[$val->prof_id][] = $val->date;
                        }
                    }

                    $this->data['RS'] = $RS;
                    $this->data['RLS'] = $RLS;
                    $this->data['DS'] = $DS;

                    $m3_str = array();
                    $m4_str = array();
                    $a3_str = array();
                    $a4_str = array();


                    $m3_rs_count = array();
                    $m3_rls_count = array();
                    $m3_ds_count = array();

                    $m4_rs_count = array();
                    $m4_rls_count = array();
                    $m4_ds_count = array();

                    $a3_rs_count = array();
                    $a3_rls_count = array();
                    $a3_ds_count = array();

                    $a4_rs_count = array();
                    $a4_rls_count = array();
                    $a4_ds_count = array();

                    $rs_max_duty = 0;
                    $rls_max_duty = 0;
                    $ds_max_duty = 0;

                    $counter = 0;
                    foreach ($td as $row) {
                        $m3 = 0;
                        $m4 = 0;
                        $a3 = 0;
                        $a4 = 0;
                        $m3_str[] = $row->m3strength;
                        $m4_str[] = $row->m4strength;
                        $a3_str[] = $row->a3strength;
                        $a4_str[] = $row->a4strength;
                        if ($row->m3strength != -1) {
                            $m3 += $row->m3strength;
                        }

                        if ($row->m4strength != -1) {
                            $m4 += $row->m4strength;
                        }

                        if ($row->a3strength != -1) {
                            $a3 += $row->a3strength;
                        }

                        if ($row->a4strength != -1) {
                            $a4 += $row->a4strength;
                        }

                        if ($m3 < 30) {
                            $m3_rs_count[] = ceil($m3 / 30);

                        } else {
                            $m3_rs_count[] = round($m3 / 30);

                        }
                        if ($a3 < 30) {
                            $a3_rs_count[] = ceil($a3 / 30);

                        } else {
                            $a3_rs_count[] = round($a3 / 30);

                        }
                        if ($m4 < 30) {
                            $m4_rs_count[] = ceil($m4 / 30);

                        } else {
                            $m4_rs_count[] = round($m4 / 30);

                        }
                        if ($a4 < 30) {
                            $a4_rs_count[] = ceil($a4 / 30);

                        } else {
                            $a4_rs_count[] = round($a4 / 30);

                        }

                        if ($m3 >= 76) {
                            if ($m3_rs_count[$counter] < 5)
                                $m3_rls_count[] = ceil(($m3_rs_count[$counter]) / 5);
                            else
                                $m3_rls_count[] = round(($m3_rs_count[$counter]) / 5);
                        } else {
                            $m3_rls_count[] = 0;
                        }

                        if ($a3 >= 76) {
                            if ($a3_rs_count[$counter] < 5)
                                $a3_rls_count[] = ceil(($a3_rs_count[$counter]) / 5);
                            else
                                $a3_rls_count[] = round(($a3_rs_count[$counter]) / 5);
                        } else {
                            $a3_rls_count[] = 0;
                        }

                        if ($m4 >= 76) {
                            if ($m4_rs_count[$counter] < 5)
                                $m4_rls_count[] = ceil(($m4_rs_count[$counter]) / 5);
                            else
                                $m4_rls_count[] = round(($m4_rs_count[$counter]) / 5);
                        } else {
                            $m4_rls_count[] = 0;
                        }

                        if ($a4 >= 76) {
                            if ($a4_rs_count[$counter] < 5)
                                $a4_rls_count[] = ceil(($a4_rs_count[$counter]) / 5);
                            else
                                $a4_rls_count[] = round(($a4_rs_count[$counter]) / 5);
                        } else {
                            $a4_rls_count[] = 0;
                        }


                        if ($m3 < 250) {

                            $m3_ds_count[] = ceil(($m3) / 250);
                        } else {

                            $m3_ds_count[] = round(($m3) / 250);
                        }
                        if ($a3 < 250) {

                            $a3_ds_count[] = ceil(($a3) / 250);
                        } else {

                            $a3_ds_count[] = round(($a3) / 250);
                        }
                        if ($m4 < 250) {

                            $m4_ds_count[] = ceil(($m4) / 250);
                        } else {

                            $m4_ds_count[] = round(($m4) / 250);
                        }
                        if ($a4 < 250) {

                            $a4_ds_count[] = ceil(($a4) / 250);
                        } else {

                            $a4_ds_count[] = round(($a4) / 250);
                        }

                        $rs_max_duty += $m3_rs_count[$counter] + $a3_rs_count[$counter] + $m4_rs_count[$counter] + $a4_rs_count[$counter];
                        $rls_max_duty += $m3_rls_count[$counter] + $a3_rls_count[$counter] + $m4_rls_count[$counter] + $a4_rls_count[$counter];
                        $ds_max_duty += $m3_ds_count[$counter] + $a3_ds_count[$counter] + $m4_ds_count[$counter] + $a4_ds_count[$counter];
                        $counter++;
                    }

                    $this->data["m3_rs_count"] = $m3_rs_count;
                    $this->data["a3_rs_count"] = $a3_rs_count;

                    $this->data["m4_rs_count"] = $m4_rs_count;
                    $this->data["a4_rs_count"] = $a4_rs_count;

                    $this->data["m3_rls_count"] = $m3_rls_count;
                    $this->data["a3_rls_count"] = $a3_rls_count;

                    $this->data["m4_rls_count"] = $m4_rls_count;
                    $this->data["a4_rls_count"] = $a4_rls_count;

                    $this->data["m3_ds_count"] = $m3_ds_count;
                    $this->data["a3_ds_count"] = $a3_ds_count;

                    $this->data["m4_ds_count"] = $m4_ds_count;
                    $this->data["a4_ds_count"] = $a4_ds_count;

                    $this->data["rs_count"] = $rs_max_duty;
                    $this->data["rls_count"] = $rls_max_duty;
                    $this->data["ds_count"] = $ds_max_duty;

                    $settings = $this->master_db->getRecords("settings", array());
                    $rs_priority_duty = $settings[0]->rs_priority_duty;
                    $rls_priority_duty = $settings[0]->rls_priority_duty;
                    $ds_priority_duty = $settings[0]->ds_priority_duty;


                    $rs_max_duty_temp = ceil($rs_max_duty / count($RS));
                    $rls_max_duty_temp = ceil($rls_max_duty / count($RLS));
                    $ds_max_duty_temp = ceil($ds_max_duty / count($DS));

                    if ($rs_priority_duty < $rs_max_duty_temp && is_array($RS_pri) && count($RS_pri) >= 1 && $rs_priority_duty >= 1) {
                        $this->data["rs_max_duty"] = $rs_max_duty = ceil(($rs_max_duty + (($rs_max_duty_temp - $rs_priority_duty) * count($RS_pri))) / count($RS));
                    } else {
                        $this->data["rs_max_duty"] = $rs_max_duty = ceil($rs_max_duty / count($RS));
                    }

                    if ($rls_priority_duty < $rls_max_duty_temp && is_array($RLS_pri) && count($RLS_pri) >= 1 && $rls_priority_duty >= 1) {
                        $this->data["rls_max_duty"] = $rls_max_duty = ceil(($rls_max_duty + (($rls_max_duty_temp - $rls_priority_duty) * count($RLS_pri))) / count($RLS));
                    } else {
                        $this->data["rls_max_duty"] = $rls_max_duty = ceil($rls_max_duty / count($RLS));
                    }


                    if ($ds_priority_duty < $ds_max_duty_temp && is_array($DS_pri) && count($DS_pri) >= 1 && $ds_priority_duty >= 1) {
                        $this->data["ds_max_duty"] = $ds_max_duty = ceil(($ds_max_duty + (($ds_max_duty_temp - $ds_priority_duty) * count($DS_pri))) / count($DS));
                    } else {
                        $this->data["ds_max_duty"] = $ds_max_duty = ceil($ds_max_duty / count($DS));
                    }

                    $master = array();


                    foreach ($RS as $rs_rand) {
                        if (!array_key_exists($rs_rand->id, $ex_dates)) {
                            $ex_dates[$rs_rand->id] = array();
                        }
                        if ($rs_rand->priority && $rs_priority_duty >= 1 && $rs_priority_duty < $this->data["rs_max_duty"])
                            $rs_max_duty = $rs_priority_duty;
                        else
                            $rs_max_duty = $this->data["rs_max_duty"];
                        $duty_counter = 0;
                        $counter = 0;
                        foreach ($td as $time_data) {
                            $m3_flag = 1;
                            $a3_flag = 1;

                            if ($duty_counter != $rs_max_duty && !in_array($time_data->db_date, $ex_dates[$rs_rand->id])) {
                                if ($m3_rs_count[$counter] != 0 && $duty_counter != $rs_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
                                    $duty_counter++;
                                    $m3_rs_count[$counter]--;
                                    $m3_flag = 0;
                                }

                                if ($a3_rs_count[$counter] != 0 && $duty_counter != $rs_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
                                    $duty_counter++;
                                    $a3_rs_count[$counter]--;
                                    $a3_flag = 0;

                                }

                                if ($m3_flag)
                                    if ($m4_rs_count[$counter] != 0 & $duty_counter != $rs_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][0][0]["m4"][$rs_rand->name] = $rs_rand->id;
                                        $duty_counter++;
                                        $m4_rs_count[$counter]--;
                                    }

                                if ($a3_flag)
                                    if ($a4_rs_count[$counter] != 0 && $duty_counter != $rs_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][0][1]["a4"][$rs_rand->name] = $rs_rand->id;
                                        $duty_counter++;
                                        $a4_rs_count[$counter]--;
                                    }
                            }


                            $counter++;
                        }


                    }

                    foreach ($a3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }


                    foreach ($RLS as $rls_rand) {
                        if (!array_key_exists($rls_rand->id, $ex_dates)) {
                            $ex_dates[$rls_rand->id] = array();
                        }
                        if ($rls_rand->priority && $rls_priority_duty >= 1 && $rls_priority_duty < $this->data["rls_max_duty"])
                            $rls_max_duty = $rls_priority_duty;
                        else
                            $rls_max_duty = $this->data["rls_max_duty"];
                        $duty_counter = 0;
                        $counter = 0;
                        foreach ($td as $time_data) {
                            $m3_flag = 1;
                            $a3_flag = 1;

                            if ($duty_counter != $rls_max_duty && !in_array($time_data->db_date, $ex_dates[$rls_rand->id])) {
                                if ($m3_rls_count[$counter] != 0 && $duty_counter != $rls_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][1][0]["m3"][$rls_rand->name] = $rls_rand->id;
                                    $duty_counter++;
                                    $m3_rls_count[$counter]--;
                                    $m3_flag = 0;
                                }

                                if ($a3_rls_count[$counter] != 0 && $duty_counter != $rls_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][1][1]["a3"][$rls_rand->name] = $rls_rand->id;
                                    $duty_counter++;
                                    $a3_rls_count[$counter]--;
                                    $a3_flag = 0;
                                }

                                if ($m3_flag)
                                    if ($m4_rls_count[$counter] != 0 && $duty_counter != $rls_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][1][0]["m4"][$rls_rand->name] = $rls_rand->id;
                                        $duty_counter++;
                                        $m4_rls_count[$counter]--;

                                    }
                                if ($a3_flag)
                                    if ($a4_rls_count[$counter] != 0 && $duty_counter != $rls_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][1][1]["a4"][$rls_rand->name] = $rls_rand->id;
                                        $duty_counter++;
                                        $a4_rls_count[$counter]--;

                                    }
                            }


                            $counter++;
                        }
                    }

                    foreach ($a3_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($DS as $ds_rand) {
                        if (!array_key_exists($ds_rand->id, $ex_dates)) {
                            $ex_dates[$ds_rand->id] = array();
                        }
                        if ($ds_rand->priority && $ds_priority_duty >= 1 && $ds_priority_duty < $this->data["ds_max_duty"])
                            $ds_max_duty = $ds_priority_duty;
                        else
                            $ds_max_duty = $this->data["ds_max_duty"];
                        $duty_counter = 0;
                        $counter = 0;
                        foreach ($td as $time_data) {
                            $m3_flag = 1;
                            $a3_flag = 1;

                            if ($duty_counter != $ds_max_duty && !in_array($time_data->db_date, $ex_dates[$ds_rand->id])) {
                                if ($m3_ds_count[$counter] != 0 && $duty_counter != $ds_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][2][0]["m3"][$ds_rand->name] = $ds_rand->id;
                                    $duty_counter++;
                                    $m3_ds_count[$counter]--;
                                    $m3_flag = 0;
                                }

                                if ($a3_ds_count[$counter] != 0 && $duty_counter != $ds_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][2][1]["a3"][$ds_rand->name] = $ds_rand->id;
                                    $duty_counter++;
                                    $a3_ds_count[$counter]--;
                                    $a3_flag = 0;
                                }

                                if ($m3_flag)
                                    if ($m4_ds_count[$counter] != 0 && $duty_counter != $ds_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][2][0]["m4"][$ds_rand->name] = $ds_rand->id;
                                        $duty_counter++;
                                        $m4_ds_count[$counter]--;
                                    }

                                if ($a3_flag)
                                    if ($a4_ds_count[$counter] != 0 && $duty_counter != $ds_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][2][1]["a4"][$ds_rand->name] = $ds_rand->id;
                                        $duty_counter++;
                                        $a4_ds_count[$counter]--;
                                    }


                            }


                            $counter++;
                        }
                    }

                    foreach ($a3_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    //echo "<pre>".print_r($master,true)."</pre>";
                    $this->data["populate"] = $master;
                    $this->data["m3_str"] = $m3_str;
                    $this->data["m4_str"] = $m4_str;
                    $this->data["a3_str"] = $a3_str;
                    $this->data["a4_str"] = $a4_str;
                    $this->load->view("assign_duty1", $this->data);


                }
            } else {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                redirect("master/timetable");
            }


        }

    }

    function attach_variable($string, $value)
    {
        $tags = array("[EXAM_ID]");
        $rep_tags = array($value);

        return str_replace($tags, $rep_tags, $string);
    }

    function getTime()
    {
        $date = $this->input->post("date");
        $ex_id = $this->input->post("ex_id");
        $sql = "select * from time_table_{$ex_id} where exam_id='{$ex_id}' and date='{$date}'";
        $res = $this->master_db->execSQL($sql);

        if (is_array($res) && count($res) == 1) {
            $res = $res[0];
            echo "'<option value=''>--Select--</option>";
            echo "'<option value='1'> All </option>";

            if ($res->m3start_time != -1) {
                echo "<option value='2'> {$res->m3start_time} </option>";
            }
            if ($res->m4start_time != -1) {
                echo "<option value='3'> {$res->m4start_time} </option>";
            }
            if ($res->a3start_time != -1) {
                echo "<option value='4'> {$res->a3start_time} </option>";
            }
            if ($res->a4start_time != -1) {
                echo "<option value='5'> {$res->a4start_time} </option>";
            }
            if ($res->m3start_time != -1 && $res->m4start_time != -1) {
                echo "<option value='6'> Both {$res->m3start_time} & {$res->m4start_time} (Morning)</option>";
            }
            if ($res->a3start_time != -1 && $res->a4start_time != -1) {
                echo "<option value='7'> Both {$res->a3start_time} & {$res->a4start_time} (Afternoon)</option>";
            }
        }
    }


    function initalize_master(&$master, $td)
    {
        $desig = array(0, 1, 2);
        $session = array("a3", "m3", "a4", "m4");
        $num_arr = array(0, 1);
        foreach ($td as $tdKey => $key) {
            foreach ($session as $sval) {
                foreach ($num_arr as $nval) {
                    foreach ($desig as $dkey => $val) {
                        if (!array_key_exists($this->getDateTag($key->date), $master)) {
                            $master[$this->getDateTag($key->date)] = array();
                        }
                        if (!array_key_exists($val, $master[$this->getDateTag($key->date)])) {
                            $master[$this->getDateTag($key->date)][$val] = array();
                        }
                        if (!array_key_exists($nval, $master[$this->getDateTag($key->date)][$val])) {
                            $master[$this->getDateTag($key->date)][$val][$nval] = array();
                        }
                        if (!array_key_exists($sval, $master[$this->getDateTag($key->date)][$val][$nval])) {
                            $master[$this->getDateTag($key->date)][$val][$nval][$sval] = array();
                        }
                    }
                }
            }
        }


    }

    public function assign_duty_m_copy()
    {
        $this->session->unset_userdata('td');
        $this->session->unset_userdata('RS');
        $this->session->unset_userdata('RLS');
        $this->session->unset_userdata('DS');
        $this->session->unset_userdata('RS_pri');
        $this->session->unset_userdata('RLS_pri');
        $this->session->unset_userdata('DS_pri');
        $this->session->unset_userdata('settings');
        $this->session->unset_userdata("opmiz_ajax");
        if ($this->input->get("method") != "a") {
            redirect("master/timetable");
        } else {
            $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $this->input->get("id")));

            if (is_array($flag_check) && count($flag_check) >= 1) {
                $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $this->input->get("id"), "informed" => 1));
                if (is_array($flag_check) && count($flag_check) >= 1) {
                    $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                    redirect("master/timetable");
                } else {
                    $this->data['ex_id'] = $this->input->get("id");
                    $this->data['table_data'] = $td = $this->master_db->getRecords("time_table_{$this->data['ex_id']}", array("exam_id" => $this->input->get("id")), '*', 'id asc');
                    $RS = $this->master_db->getRecords("prof_{$this->data['ex_id']}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
                    $RLS = $this->master_db->getRecords("prof_{$this->data['ex_id']}", array("designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
                    $DS = $this->master_db->getRecords("prof_{$this->data['ex_id']}", array("designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

//					if(is_array($RS) && count($RS))
//						shuffle($RS);
//					else
//						$RS = array();
//					if(is_array($RLS) && count($RLS))
//						shuffle($RLS);
//					else
//						$RLS = array();
//					if(is_array($DS) && count($DS))
//						shuffle($DS);
//					else
//						$DS = array();

                    $RS_pri = $this->master_db->getRecords("prof_{$this->data['ex_id']}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 1));
                    $RLS_pri = $this->master_db->getRecords("prof_{$this->data['ex_id']}", array("designation" => 2, "status" => 1, "priority" => 1));
                    $DS_pri = $this->master_db->getRecords("prof_{$this->data['ex_id']}", array("designation" => 3, "status" => 1, "priority" => 1));

                    if (is_array($RS_pri) && count($RS_pri))
                        $RS = array_merge($RS_pri, $RS);
                    if (is_array($RLS_pri) && count($RLS_pri))
                        $RLS = array_merge($RLS_pri, $RLS);
                    if (is_array($DS_pri) && count($DS_pri))
                        $DS = array_merge($DS_pri, $DS);

                    $this->data['RS'] = $RS;
                    $this->data['RLS'] = $RLS;
                    $this->data['DS'] = $DS;

                    $m3_str = array();
                    $m4_str = array();
                    $a3_str = array();
                    $a4_str = array();


                    $m3_rs_count = array();
                    $m3_rls_count = array();
                    $m3_ds_count = array();

                    $m4_rs_count = array();
                    $m4_rls_count = array();
                    $m4_ds_count = array();

                    $a3_rs_count = array();
                    $a3_rls_count = array();
                    $a3_ds_count = array();

                    $a4_rs_count = array();
                    $a4_rls_count = array();
                    $a4_ds_count = array();

                    $rs_max_duty = 0;
                    $rls_max_duty = 0;
                    $ds_max_duty = 0;

                    $counter = 0;
                    $master = array();
                    $this->initalize_master($master, $td);

                    foreach ($td as $key => $row) {


                        $m3 = 0;
                        $m4 = 0;
                        $a3 = 0;
                        $a4 = 0;
                        $m3_str[] = $row->m3strength;
                        $m4_str[] = $row->m4strength;
                        $a3_str[] = $row->a3strength;
                        $a4_str[] = $row->a4strength;
                        if ($row->m3strength != -1) {
                            $m3 += $row->m3strength;
                        }

                        if ($row->m4strength != -1) {
                            $m4 += $row->m4strength;
                        }

                        if ($row->a3strength != -1) {
                            $a3 += $row->a3strength;
                        }

                        if ($row->a4strength != -1) {
                            $a4 += $row->a4strength;
                        }

                        if ($m3 < 30) {
                            $m3_rs_count[] = ceil($m3 / 30);

                        } else {
                            $m3_rs_count[] = round($m3 / 30);

                        }
                        if ($a3 < 30) {
                            $a3_rs_count[] = ceil($a3 / 30);

                        } else {
                            $a3_rs_count[] = round($a3 / 30);

                        }
                        if ($m4 < 30) {
                            $m4_rs_count[] = ceil($m4 / 30);

                        } else {
                            $m4_rs_count[] = round($m4 / 30);

                        }
                        if ($a4 < 30) {
                            $a4_rs_count[] = ceil($a4 / 30);

                        } else {
                            $a4_rs_count[] = round($a4 / 30);

                        }

                        if ($m3 >= 76) {
                            if ($m3_rs_count[$counter] < 5)
                                $m3_rls_count[] = ceil(($m3_rs_count[$counter]) / 5);
                            else
                                $m3_rls_count[] = round(($m3_rs_count[$counter]) / 5);
                        } else {
                            $m3_rls_count[] = 0;
                        }

                        if ($a3 >= 76) {
                            if ($a3_rs_count[$counter] < 5)
                                $a3_rls_count[] = ceil(($a3_rs_count[$counter]) / 5);
                            else
                                $a3_rls_count[] = round(($a3_rs_count[$counter]) / 5);
                        } else {
                            $a3_rls_count[] = 0;
                        }

                        if ($m4 >= 76) {
                            if ($m4_rs_count[$counter] < 5)
                                $m4_rls_count[] = ceil(($m4_rs_count[$counter]) / 5);
                            else
                                $m4_rls_count[] = round(($m4_rs_count[$counter]) / 5);
                        } else {
                            $m4_rls_count[] = 0;
                        }

                        if ($a4 >= 76) {
                            if ($a4_rs_count[$counter] < 5)
                                $a4_rls_count[] = ceil(($a4_rs_count[$counter]) / 5);
                            else
                                $a4_rls_count[] = round(($a4_rs_count[$counter]) / 5);
                        } else {
                            $a4_rls_count[] = 0;
                        }


                        if ($m3 < 250) {

                            $m3_ds_count[] = ceil(($m3) / 250);
                        } else {

                            $m3_ds_count[] = round(($m3) / 250);
                        }
                        if ($a3 < 250) {

                            $a3_ds_count[] = ceil(($a3) / 250);
                        } else {

                            $a3_ds_count[] = round(($a3) / 250);
                        }
                        if ($m4 < 250) {

                            $m4_ds_count[] = ceil(($m4) / 250);
                        } else {

                            $m4_ds_count[] = round(($m4) / 250);
                        }
                        if ($a4 < 250) {

                            $a4_ds_count[] = ceil(($a4) / 250);
                        } else {

                            $a4_ds_count[] = round(($a4) / 250);
                        }

                        $rs_max_duty += $m3_rs_count[$counter] + $a3_rs_count[$counter] + $m4_rs_count[$counter] + $a4_rs_count[$counter];
                        $rls_max_duty += $m3_rls_count[$counter] + $a3_rls_count[$counter] + $m4_rls_count[$counter] + $a4_rls_count[$counter];
                        $ds_max_duty += $m3_ds_count[$counter] + $a3_ds_count[$counter] + $m4_ds_count[$counter] + $a4_ds_count[$counter];

                        $counter++;

                    }

                    $this->data["m3_rs_count"] = $m3_rs_count;
                    $this->data["a3_rs_count"] = $a3_rs_count;

                    $this->data["m4_rs_count"] = $m4_rs_count;
                    $this->data["a4_rs_count"] = $a4_rs_count;


                    $this->data["m3_rls_count"] = $m3_rls_count;
                    $this->data["a3_rls_count"] = $a3_rls_count;

                    $this->data["m4_rls_count"] = $m4_rls_count;
                    $this->data["a4_rls_count"] = $a4_rls_count;

                    $this->data["m3_ds_count"] = $m3_ds_count;
                    $this->data["a3_ds_count"] = $a3_ds_count;

                    $this->data["m4_ds_count"] = $m4_ds_count;
                    $this->data["a4_ds_count"] = $a4_ds_count;

                    foreach ($td as $key => $val) {
                        $m3_rs_count[$key] += $m4_rs_count[$key];
                        $a3_rs_count[$key] += $a4_rs_count[$key];
                    }


                    $this->data["rs_count"] = $rs_max_duty;
                    $this->data["rls_count"] = $rls_max_duty;
                    $this->data["ds_count"] = $ds_max_duty;

                    $settings = $this->master_db->getRecords("settings", array());
                    $rs_priority_duty = $settings[0]->rs_priority_duty;
                    $rls_priority_duty = $settings[0]->rls_priority_duty;
                    $ds_priority_duty = $settings[0]->ds_priority_duty;


                    $rs_max_duty_temp = ceil($rs_max_duty / count($RS));
                    $rls_max_duty_temp = ceil($rls_max_duty / count($RLS));
                    $ds_max_duty_temp = ceil($ds_max_duty / count($DS));

                    if ($rs_priority_duty < $rs_max_duty_temp && is_array($RS_pri) && count($RS_pri) >= 1 && $rs_priority_duty >= 1) {
                        $this->data["rs_max_duty"] = $rs_max_duty = ceil(($rs_max_duty + (($rs_max_duty_temp - $rs_priority_duty) * count($RS_pri))) / count($RS));
                    } else {
                        $this->data["rs_max_duty"] = $rs_max_duty = ceil($rs_max_duty / count($RS));
                    }

                    if ($rls_priority_duty < $rls_max_duty_temp && is_array($RLS_pri) && count($RLS_pri) >= 1 && $rls_priority_duty >= 1) {
                        $this->data["rls_max_duty"] = $rls_max_duty = ceil(($rls_max_duty + (($rls_max_duty_temp - $rls_priority_duty) * count($RLS_pri))) / count($RLS));
                    } else {
                        $this->data["rls_max_duty"] = $rls_max_duty = ceil($rls_max_duty / count($RLS));
                    }


                    if ($ds_priority_duty < $ds_max_duty_temp && is_array($DS_pri) && count($DS_pri) >= 1 && $ds_priority_duty >= 1) {
                        $this->data["ds_max_duty"] = $ds_max_duty = ceil(($ds_max_duty + (($ds_max_duty_temp - $ds_priority_duty) * count($DS_pri))) / count($DS));
                    } else {
                        $this->data["ds_max_duty"] = $ds_max_duty = ceil($ds_max_duty / count($DS));
                    }

                    $allowed = array();
                    $rs_shortage = array();
                    $rs_last = array();

                    $allocation = 0;
                    $rs_total_duty = 0;
                    $rs_index = 0;

                    foreach ($RS as $rs_rand) {
                        if ($rs_index % 1 != 0)
                            $allowed[$rs_rand->id] = 0;
                        else
                            $allowed[$rs_rand->id] = 2;

                        if ($rs_rand->priority && $rs_priority_duty >= 1 && $rs_priority_duty < $this->data["rs_max_duty"])
                            $rs_max_duty = $rs_priority_duty;
                        else
                            $rs_max_duty = $this->data["rs_max_duty"];
                        $duty_counter = 0;
                        $mr_counter = 0;
                        $aft_counter = 0;
                        $rs_index++;
                        $aft_share = round($rs_max_duty * 25 / 100);
                        $mr_share = $rs_max_duty - $aft_share;
                        foreach ($td as $tdKey => $time_data) {
                            //echo $rs_total_duty."<br>";

                            $m3_flag = true;
                            $a3_flag = true;
//							if($duty_counter != $rs_max_duty && $mr_share!=0){
//								if($m3_rs_count[$mr_counter] != 0 && $duty_counter != $rs_max_duty){
//									$master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
//									$duty_counter++;
//									$m3_rs_count[$mr_counter]--;
//									$m3_flag=false;
//									$rs_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($rs_rand->id,$rs_last))
//										$rs_last[$rs_rand->id] = $tdKey;
//									$rs_data[$rs_rand->id][] = array("m3"=>$tdKey);
//								}
//							}
//
//							if($duty_counter != $rs_max_duty && $aft_share!=0){
//
//
//									if($a3_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty){
//										$master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
//										$duty_counter++;
//										$a3_rs_count[$aft_counter]--;
//										$a3_flag=false;
//										$rs_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($rs_rand->id,$rs_last))
//											$rs_last[$rs_rand->id] = $tdKey;
//										$rs_data[$rs_rand->id][] = array("a3"=>$tdKey);
//									}
//
//							}

                            if ($duty_counter != $rs_max_duty && $m3_flag) {
                                if ($m3_rs_count[$mr_counter] != 0 && $duty_counter != $rs_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
                                    $duty_counter++;
                                    $m3_rs_count[$mr_counter]--;

                                    $rs_total_duty++;
                                    $allocation++;
                                    $mr_share--;
                                    if (!array_key_exists($rs_rand->id, $rs_last))
                                        $rs_last[$rs_rand->id] = $tdKey;
                                    $rs_data[$rs_rand->id][] = array("m3" => $tdKey);
                                }
                            }

                            if ($duty_counter != $rs_max_duty && $a3_flag) {


                                if ($a3_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
                                    $duty_counter++;
                                    $a3_rs_count[$aft_counter]--;
                                    $a3_flag = 0;
                                    $rs_total_duty++;
                                    $allocation++;
                                    $aft_share--;
                                    if (!array_key_exists($rs_rand->id, $rs_last))
                                        $rs_last[$rs_rand->id] = $tdKey;
                                    $rs_data[$rs_rand->id][] = array("a3" => $tdKey);
                                }

                            }

                            $mr_counter++;
                            $aft_counter++;


                        }


                        $rs_shortage[$rs_rand->id] = $duty_counter;
                        if (!array_key_exists($rs_rand->id, $rs_last)) {
                            $rs_last[$rs_rand->id] = count($td);
                        }
                        if ($duty_counter <= $this->data["rs_max_duty"] - 1)
                            $allowed[$rs_rand->id] = 0;
                        //echo $rs_rand->name. "--> ".$duty_counter."<br>";
                    }
                    //echo $rs_total_duty;
                    //echo $allocation;
                    //echo "<pre>".print_r($rs_data,true)."</pre>";
                    $mast_changed = array();


                    foreach ($a3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                for ($j = $key - 1; $j > 0; $j--) {
                                    if (array_key_exists($j, $td)) {
                                        foreach (array_merge($master[$this->getDateTag($td[$j]->date)][0][0]["m3"], $master[$this->getDateTag($td[$j]->date)][0][1]["a3"]) as $bkey => $bval) {
                                            $bflag = false;
                                            foreach ($master[$this->getDateTag($td[$key]->date)][0][1]["a3"] as $ckey => $cval) {
                                                if ($bval == $cval) {
                                                    $bflag = true;
                                                }
                                            }
                                            if (!$bflag && $i < $val && $rs_shortage[$bval] <= $this->data["rs_max_duty"]) {
                                                $master[$this->getDateTag($td[$key]->date)][0][1]["a3"][$bkey] = $bval;
                                                $rs_shortage[$bval]++;
                                                $i++;
                                                //echo $bkey."------------->Key-------->".$key."<br>";
                                                $a3_rs_count[$key]--;
                                                $allowed[$bval]++;
                                                //$allowed[$bval]++;
                                            }
                                        }
                                    }
                                }
                                //$master[$this->getDateTag($td[$key]->date)][0][1]["a3"]["TO BE ADDED {$i}"]=-1;
                            }
                        }
                    }


                    foreach ($m3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                for ($j = $key - 1; $j > 0; $j--) {
                                    if (array_key_exists($j, $td)) {
                                        foreach (array_merge($master[$this->getDateTag($td[$j]->date)][0][0]["m3"], $master[$this->getDateTag($td[$j]->date)][0][1]["a3"]) as $bkey => $bval) {
                                            $bflag = false;
                                            foreach ($master[$this->getDateTag($td[$key]->date)][0][0]["m3"] as $ckey => $cval) {
                                                if ($bval == $cval) {
                                                    $bflag = true;
                                                }
                                            }
                                            if (!$bflag && $i < $val && $rs_shortage[$bval] <= $this->data["rs_max_duty"]) {
                                                $master[$this->getDateTag($td[$key]->date)][0][0]["m3"][$bkey] = $bval;
                                                $rs_shortage[$bval]++;
                                                $i++;
                                                //echo $bkey."------------->Key-------->".$key."<br>";
                                                $m3_rs_count[$key]--;
                                                $allowed[$bval]++;
                                                //$allowed[$bval]++;

                                            }
                                        }
                                    }
                                }

                            }
                        }
                    }

                    //echo "<pre>".print_r(array_merge($master[$this->getDateTag($td[11]->date)][0][0]["m3"],$master[$this->getDateTag($td[11]->date)][0][1]["a3"]),true)."</pre>";

                    foreach ($a3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {

                                $master[$this->getDateTag($td[$key]->date)][0][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }


                    foreach ($m3_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_rs_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][0][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach (array_reverse($RS) as $rskey => $rsp) {
                        if ($rs_shortage[$rsp->id] <= $this->data["rs_max_duty"] - 1) {
                            $pos = 1;
                            $req = $this->data["rs_max_duty"] - $rs_shortage[$rsp->id];

                            $req_counter = 0;
                            //echo "Req=".$req."Shortage=".$rs_shortage[$rsp->id]."Name=".$rsp->name."<br>";
                            while (array_key_exists($rs_last[$rsp->id] - $pos, $td) && $req_counter != $req) {
                                $got = 0;

                                $date_tag = $td[$rs_last[$rsp->id] - $pos]->date;


                                foreach (array_merge($master[$this->getDateTag($date_tag)][0][0]["m3"], $master[$this->getDateTag($date_tag)][0][1]["a3"]) as $pt => $idVal) {
                                    if ($got == 0) {
                                        if (!array_key_exists($rsp->name, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                            for ($j = $this->data["rs_max_duty"] + 4; $j > 0; $j--) {

                                                //&& !array_key_exists($idVal,$mast_changed[$this->getDateTag($date_tag)][0][0]["m3"])
                                                if ($rs_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $allowed) && $allowed[$idVal] != 0) {
                                                    $got++;
                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                                        $master[$this->getDateTag($date_tag)][0][0]["m3"][$rsp->name] = $rsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][0][0]["m3"][$pt]);
                                                        $rs_shortage[$idVal]--;
                                                        $rs_shortage[$rsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt."---->".$rsp->name."------->".$date_tag."<br>";
                                                        $allowed[$idVal]--;
                                                    }
                                                }
                                            }
                                        } else if (!array_key_exists($rsp->name, $master[$this->getDateTag($date_tag)][0][1]["a3"])) {
                                            for ($j = $this->data["rs_max_duty"] + 4; $j > 0; $j--) {

                                                if ($rs_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $allowed) && $allowed[$idVal] != 0) {
                                                    $got++;
                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                                        $master[$this->getDateTag($date_tag)][0][1]["a3"][$rsp->name] = $rsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][0][1]["a3"][$pt]);
                                                        $rs_shortage[$idVal]--;
                                                        $rs_shortage[$rsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt . "---->" . $rsp->name . "------->" . $date_tag . "<br>";
                                                        $allowed[$idVal]--;

                                                    }
                                                }
                                            }
                                        }
                                    } else {
                                        //continue;
                                    }
                                }


                                if ($got == 0) {
                                    //echo "<h3>Skipped {$date_tag}</h3><br>";
                                }
                                $pos++;
                            }
                        }

                    }

                    $diff_array_rs = $duty_arr_rs = array();
                    $counter = 1;
                    foreach ($RS as $rskey => $rsval) {

                        $diff_array_rs[$rsval->id] = array();
                        foreach ($td as $tdKey => $tdVal) {
                            foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m3"], $master[$this->getDateTag($td[$tdKey]->date)][0][0]["m4"]) as $asKey => $asVal) {
                                if ($rsval->id == $asVal) {
                                    $diff_array_rs[$rsval->id][] = $tdKey;
                                }
                            }
                            foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a3"], $master[$this->getDateTag($td[$tdKey]->date)][0][1]["a4"]) as $asKey => $asVal) {
                                if ($rsval->id == $asVal) {
                                    $diff_array_rs[$rsval->id][] = $tdKey;
                                }
                            }
                        }
                        $max = 0;

                        for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
                            $dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
                            if ($max < $dif)
                                $max = $dif;

                        }


                        $max--;
                        if ($max = -1) {
                            //echo "<br>{$counter}Long Gap(2)-->".$rsval->name."($max)";
                            $counter++;
                            //echo "<pre>".print_r($diff_array_rs[$rsval->id],true)."</pre>";
                        }

                        if (!array_key_exists(count($diff_array_rs[$rsval->id]), $duty_arr_rs)) {
                            $duty_arr_rs[count($diff_array_rs[$rsval->id])] = array();
                        }

                        $duty_arr_rs[count($diff_array_rs[$rsval->id])][] = $rsval->id;

                    }

                    foreach ($duty_arr_rs as $key => $val) {
                        $cnt = count($val);
                        //$duty_ctr_str.="<tr><td>{$cnt}</td><td>{$key}</td></tr>";
                        if ($cnt == 0) {
                            //print_r($val);
                        }
                    }

                    //$this->print_r($duty_arr_rs);


                    foreach ($m4_rs_count as $key => $val) {
                        $ctr = 0;
                        foreach ($master[$this->getDateTag($td[$key]->date)][0][0]["m3"] as $k => $v) {
                            if ($ctr != $this->data["m4_rs_count"][$key]) {
                                $master[$this->getDateTag($td[$key]->date)][0][0]["m4"][$k] = $v;
                                unset($master[$this->getDateTag($td[$key]->date)][0][0]["m3"][$k]);
                                $ctr++;
                            }
                        }

                    }


                    foreach ($RLS as $rls_rand) {
                        if ($rls_rand->priority && $rls_priority_duty >= 1 && $rls_priority_duty < $this->data["rls_max_duty"])
                            $rls_max_duty = $rls_priority_duty;
                        else
                            $rls_max_duty = $this->data["rls_max_duty"];
                        $duty_counter = 0;
                        $mr_counter = 0;
                        $aft_counter = 0;
                        foreach ($td as $time_data) {
                            $m3_flag = 1;
                            if ($duty_counter != $rls_max_duty) {
                                if ($m3_rls_count[$mr_counter] != 0 && $duty_counter != $rls_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][1][0]["m3"][$rls_rand->name] = $rls_rand->id;
                                    $duty_counter++;
                                    $m3_rls_count[$mr_counter]--;
                                    $m3_flag = 0;
                                }


                                if ($m3_flag)
                                    if ($m4_rls_count[$mr_counter] != 0 & $duty_counter != $rls_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][1][0]["m4"][$rls_rand->name] = $rls_rand->id;
                                        $duty_counter++;
                                        $m4_rls_count[$mr_counter]--;
                                    }


                            }


                            $mr_counter++;
                        }
                        foreach ($td as $time_data) {

                            $a3_flag = 1;

                            if ($duty_counter != $rls_max_duty) {


                                if ($a3_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][1][1]["a3"][$rls_rand->name] = $rls_rand->id;
                                    $duty_counter++;
                                    $a3_rls_count[$aft_counter]--;
                                    $a3_flag = 0;

                                }


                                if ($a3_flag)
                                    if ($a4_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][1][1]["a4"][$rls_rand->name] = $rls_rand->id;
                                        $duty_counter++;
                                        $a4_rls_count[$aft_counter]--;
                                    }
                            }


                            $aft_counter++;
                        }
                    }

                    foreach ($a3_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_rls_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][1][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($DS as $ds_rand) {
                        if ($ds_rand->priority && $ds_priority_duty >= 1 && $ds_priority_duty < $this->data["ds_max_duty"])
                            $ds_max_duty = $ds_priority_duty;
                        else
                            $ds_max_duty = $this->data["ds_max_duty"];
                        $duty_counter = 0;
                        $mr_counter = 0;
                        $aft_counter = 0;
                        foreach ($td as $time_data) {
                            $m3_flag = 1;
                            if ($duty_counter != $ds_max_duty) {
                                if ($m3_ds_count[$mr_counter] != 0 && $duty_counter != $ds_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][2][0]["m3"][$ds_rand->name] = $ds_rand->id;
                                    $duty_counter++;
                                    $m3_ds_count[$mr_counter]--;
                                    $m3_flag = 0;
                                }


                                if ($m3_flag)
                                    if ($m4_ds_count[$mr_counter] != 0 & $duty_counter != $ds_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][2][0]["m4"][$ds_rand->name] = $ds_rand->id;
                                        $duty_counter++;
                                        $m4_ds_count[$mr_counter]--;
                                    }


                            }


                            $mr_counter++;
                        }
                        foreach ($td as $time_data) {

                            $a3_flag = 1;

                            if ($duty_counter != $ds_max_duty) {


                                if ($a3_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty) {
                                    $master[$this->getDateTag($time_data->date)][2][1]["a3"][$ds_rand->name] = $ds_rand->id;
                                    $duty_counter++;
                                    $a3_ds_count[$aft_counter]--;
                                    $a3_flag = 0;

                                }


                                if ($a3_flag)
                                    if ($a4_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty) {
                                        $master[$this->getDateTag($time_data->date)][2][1]["a4"][$ds_rand->name] = $ds_rand->id;
                                        $duty_counter++;
                                        $a4_ds_count[$aft_counter]--;
                                    }
                            }


                            $aft_counter++;
                        }
                    }

                    foreach ($a3_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][1]["a3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m3_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][0]["m3"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($a4_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][1]["a4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }

                    foreach ($m4_ds_count as $key => $val) {
                        if ($val != 0) {
                            for ($i = 0; $i < $val; $i++) {
                                $master[$this->getDateTag($td[$key]->date)][2][0]["m4"]["TO BE ADDED {$i}"] = -1;
                            }
                        }
                    }


                    $this->data["populate"] = $master;
                    $this->data["populate"] = $master;
                    $this->data["m3_str"] = $m3_str;
                    $this->data["m4_str"] = $m4_str;
                    $this->data["a3_str"] = $a3_str;
                    $this->data["a4_str"] = $a4_str;
                    
                    $this->load->view("assign_duty", $this->data);
                    //echo "<pre>".print_r($master,true)."</pre>";


                }
            } else {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                redirect("master/timetable");
            }


        }

    }



    function print_r($arr)
    {
        echo "<pre>" . print_r($arr, true) . "</pre>";
    }

    function normalize(&$master)
    {
        {
            $diff_array_rs = array();
            $counter = 1;
            $gap_str_rs = "";
            $duty_arr_rs = array();
            $to_be_added = 0;
//			foreach ($RS as $rskey => $rsval) {
//
//				$diff_array_rs[$rsval->id] = array();
//				foreach ($td as $tdKey => $tdVal) {
//					foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m3"], $master[$this->getDateTag($td[$tdKey]->date)][0][0]["m4"]) as $asKey => $asVal) {
//						if ($rsval->id == $asVal) {
//							$diff_array_rs[$rsval->id][] = $tdKey;
//						}
//					}
//					foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a3"], $master[$this->getDateTag($td[$tdKey]->date)][0][1]["a4"]) as $asKey => $asVal) {
//						if ($rsval->id == $asVal) {
//							$diff_array_rs[$rsval->id][] = $tdKey;
//						}
//					}
//				}
//				$max = 0;
//
//				for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
//					$dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
//					if ($max < $dif)
//						$max = $dif;
//
//				}
//				$mx=$max;
//				if ($max != 0)
//					$max--;
//				if ($max >= 3)
//					for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
//						$dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
//						if ($max+1==$dif){
//							if($i+1<ceil(count($diff_array_rs[$rsval->id])/2)){
//								for($j=0;$j<$i+1;$j++){
//									if(array_key_exists($diff_array_rs[$rsval->id][$j],$td)){
//
//										if(array_key_exists($j,$diff_array_rs[$rsval->id]))
//											if(array_key_exists($rsval->name,$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])){
//												//$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED Skipped ".$to_be_added]=-1;
//												unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$rsval->name]);
//												$to_be_added++;
//												unset($diff_array_rs[$rsval->id][$j]);
//												$rs_shortage[$rsval->id]--;
//												$rs_last[$rs_rand->id] = $i+1;
//												$m3_rs_count[$j]++;
//											}
//										if(array_key_exists($j,$diff_array_rs[$rsval->id]))
//											if(array_key_exists($rsval->name,$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])){
//												//$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED Skipped ".$to_be_added]=-1;
//												unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$rsval->name]);
//												$to_be_added++;
//												unset($diff_array_rs[$rsval->id][$j]);
//												$rs_shortage[$rsval->id]--;
//												$rs_last[$rs_rand->id] = $i+1;
//												//$m3_rs_count[$j]++;
//											}
//										if(array_key_exists($j,$diff_array_rs[$rsval->id]))
//											if(array_key_exists($rsval->name,$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])){
//												//$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED Skipped ".$to_be_added]=-1;
//												unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$rsval->name]);
//												$to_be_added++;
//												unset($diff_array_rs[$rsval->id][$j]);
//												$rs_shortage[$rsval->id]--;
//												$rs_last[$rs_rand->id] = $i+1;
//												$a3_rs_count[$j]++;
//											}
//										if(array_key_exists($j,$diff_array_rs[$rsval->id]))
//											if(array_key_exists($rsval->name,$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])){
//												//$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED Skipped ".$to_be_added]=-1;
//												unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$rsval->name]);
//												$to_be_added++;
//												unset($diff_array_rs[$rsval->id][$j]);
//												$rs_shortage[$rsval->id]--;
//												$rs_last[$rs_rand->id] = $i+1;
//												//$a3_rs_count[$j]++;
//											}
//									}
//								}
//							} else {
//								for($j=$i+1;$j<count($diff_array_rs[$rsval->id]);$j++){
//									if(array_key_exists($diff_array_rs[$rsval->id][$j],$td)){
//										if(array_key_exists($j,$diff_array_rs[$rsval->id]))
//											if(array_key_exists($rsval->name,$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])){
//												//$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED Skipped ".$to_be_added]=-1;
//												unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$rsval->name]);
//												$to_be_added++;
//												unset($diff_array_rs[$rsval->id][$j]);
//												$rs_shortage[$rsval->id]--;
//												$m3_rs_count[$j]++;
//											}
//										if(array_key_exists($j,$diff_array_rs[$rsval->id]))
//											if(array_key_exists($rsval->name,$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])){
//												//$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED Skipped ".$to_be_added]=-1;
//												unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$rsval->name]);
//												$to_be_added++;
//												unset($diff_array_rs[$rsval->id][$j]);
//												$rs_shortage[$rsval->id]--;
//												//$m3_rs_count[$j]++;
//											}
//										if(array_key_exists($j,$diff_array_rs[$rsval->id]))
//											if(array_key_exists($rsval->name,$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])){
//												//$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED Skipped ".$to_be_added]=-1;
//												unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$rsval->name]);
//												$to_be_added++;
//												unset($diff_array_rs[$rsval->id][$j]);
//												$rs_shortage[$rsval->id]--;
//												$a3_rs_count[$j]++;
//											}
//										if(array_key_exists($j,$diff_array_rs[$rsval->id]))
//											if(array_key_exists($rsval->name,$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])){
//												//$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED Skipped ".$to_be_added]=-1;
//												unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$rsval->name]);
//												$to_be_added++;
//												unset($diff_array_rs[$rsval->id][$j]);
//												$rs_shortage[$rsval->id]--;
//												//$a3_rs_count[$j]++;
//											}
//									}
//								}
//							}
//							break;
//
//						}
//
//					}
//
//				$diff_array_rs[$rsval->id] = array_values($diff_array_rs[$rsval->id]);
//				$max=$mx;
//				if ($max != 0)
//					$max--;
//				if ($max >= 3) {
//					//echo "<br>{$counter}Long Gap(2)-->".$rsval->name."($max)";
//					$gap_str_rs .= "<tr><td>{$counter}</td><td>{$rsval->name}</td><td>{$max}</td></tr>";
//					$counter++;
//					//echo "<pre>".print_r($diff_array_rs[$rsval->id],true)."</pre>";
//				}
//
//				if (!array_key_exists(count($diff_array_rs[$rsval->id]), $duty_arr_rs)) {
//					$duty_arr_rs[count($diff_array_rs[$rsval->id])] = array();
//				}
//
//				$duty_arr_rs[count($diff_array_rs[$rsval->id])][] = $rsval->id;
//
//
//			}
        }
    }

    public function ana2()
    {

        {
            $gen_flag = false;
            $gap_str_rs = $duty_ctr_str_rs = $gap_str_rls = $duty_ctr_str_rls = $gap_str_ds = $duty_ctr_str_ds = $str = "";
            $req_flag = $this->input->post("req_flag");
            $rs_one = $this->input->post("rs_one");
            $rs_two = $this->input->post("rs_two");
            $rs_three = $this->input->post("rs_three");
            $rs_four = $this->input->post("rs_four");

            $rls_one = $this->input->post("rls_one");
            $rls_two = $this->input->post("rls_two");
            $rls_three = $this->input->post("rls_three");
            $rls_four = $this->input->post("rls_four");

            $ds_one = $this->input->post("ds_one");
            $ds_two = $this->input->post("ds_two");
            $ds_three = $this->input->post("ds_three");
            $ds_four = $this->input->post("ds_four");
            $ex_id = $this->input->post("id");

//            if (!$this->session->userdata('opmiz_ajax')) {
            $settings = $this->master_db->getRecords("settings", array());
            $this->data['table_data'] = $td = $this->master_db->getRecords("time_table_{$ex_id}", array("exam_id" => $ex_id), '*', 'id asc');
            $RS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date"=>0, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
            $RLS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date"=>0, "designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
            $DS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date"=>0, "designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

            if (is_array($RS) && count($RS) >= 1);
            //shuffle($RS);
            else
                $RS = array();
            if (is_array($RLS) && count($RLS) >= 1);
            //shuffle($RLS);
            else
                $RLS = array();
            if (is_array($DS) && count($DS) >= 1);
            //shuffle($DS);
            else
                $DS = array();

            $RS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date"=>1, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
            $RLS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date"=>1,"designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
            $DS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date"=>1,"designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

            if (is_array($RS_ex) && count($RS_ex) >= 1);
            //shuffle($RS_ex);
            else
                $RS_ex = array();
            if (is_array($RLS_ex) && count($RLS_ex) >= 1);
            //shuffle($RLS_ex);
            else
                $RLS_ex = array();
            if (is_array($DS_ex) && count($DS_ex) >= 1);
            //shuffle($DS_ex);
            else
                $DS_ex = array();




            $RS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 1));
            $RLS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 2, "status" => 1, "priority" => 1));
            $DS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 3, "status" => 1, "priority" => 1));

            if (is_array($RS_pri) && count($RS_pri) >= 1);
            //shuffle($RS_pri);
            else
                $RS_pri = array();
            if (is_array($RLS_pri) && count($RLS_pri) >= 1);
            //shuffle($RLS_pri);
            else
                $RLS_pri = array();
            if (is_array($DS_pri) && count($DS_pri) >= 1);
            //shuffle($DS_pri);
            else
                $DS_pri = array();

            //if(is_array($RS_pri) && count($RS_pri))
            $RS = array_merge($RS_ex,array_merge($RS_pri, $RS));
            //if(is_array($RLS_pri) && count($RLS_pri))
            $RLS = array_merge($RLS_ex,array_merge($RLS_pri, $RLS));
            //if(is_array($DS_pri) && count($DS_pri))
            $DS = array_merge($DS_ex,array_merge($DS_pri, $DS));
            $ex_dates = array();
            $ex_dates_db = $this->master_db->getRecords("exclude_date_{$ex_id}", array());
            if(is_array($ex_dates_db) && count($ex_dates_db)>=1){
                foreach($ex_dates_db as $val){
                    if(!array_key_exists($val->prof_id,$ex_dates)){
                        $ex_dates[$val->prof_id] = array();
                    }
                    $ex_dates[$val->prof_id][] = $val->date;
                }
            }

            $this->data['RS'] = $RS;
            $this->data['RLS'] = $RLS;
            $this->data['DS'] = $DS;
            $this->session->set_userdata("opmiz_ajax", "1");
            $this->session->set_userdata("td", $td);
            $this->session->set_userdata("RS", $RS);
            $this->session->set_userdata("RLS", $RLS);
            $this->session->set_userdata("DS", $DS);
            $this->session->set_userdata("RS_pri", $RS_pri);
            $this->session->set_userdata("RLS_pri", $RLS_pri);
            $this->session->set_userdata("DS_pri", $DS_pri);
            $this->session->set_userdata("settings", $settings);
//            } else {
//                $this->data['table_data'] = $td = $this->session->userdata('td');
//                $RS = $this->data['RS'] = $this->session->userdata('RS');
//                $RLS = $this->data['RLS'] = $this->session->userdata('RLS');
//                $DS = $this->data['DS'] = $this->session->userdata('DS');
//                $RS_pri = $this->session->userdata('RS_pri');
//                $RLS_pri = $this->session->userdata('RLS_pri');
//                $DS_pri = $this->session->userdata('DS_pri');
//                $settings = $this->session->userdata('settings');
//            }

            $m3_str = array();
            $m4_str = array();
            $a3_str = array();
            $a4_str = array();


            $m3_rs_count = array();
            $m3_rls_count = array();
            $m3_ds_count = array();

            $m4_rs_count = array();
            $m4_rls_count = array();
            $m4_ds_count = array();

            $a3_rs_count = array();
            $a3_rls_count = array();
            $a3_ds_count = array();

            $a4_rs_count = array();
            $a4_rls_count = array();
            $a4_ds_count = array();

            $rs_max_duty = 0;
            $rls_max_duty = 0;
            $ds_max_duty = 0;

            $counter = 0;
            $master = array();
            $this->initalize_master($master, $td);

            foreach ($td as $key => $row) {
                $m3 = 0;
                $m4 = 0;
                $a3 = 0;
                $a4 = 0;
                $m3_str[] = $row->m3strength;
                $m4_str[] = $row->m4strength;
                $a3_str[] = $row->a3strength;
                $a4_str[] = $row->a4strength;
                if ($row->m3strength != -1) {
                    $m3 += $row->m3strength;
                }

                if ($row->m4strength != -1) {
                    $m4 += $row->m4strength;
                }

                if ($row->a3strength != -1) {
                    $a3 += $row->a3strength;
                }

                if ($row->a4strength != -1) {
                    $a4 += $row->a4strength;
                }

                if ($m3 < 30) {
                    $m3_rs_count[] = ceil($m3 / 30);

                } else {
                    $m3_rs_count[] = round($m3 / 30);

                }
                if ($a3 < 30) {
                    $a3_rs_count[] = ceil($a3 / 30);

                } else {
                    $a3_rs_count[] = round($a3 / 30);

                }
                if ($m4 < 30) {
                    $m4_rs_count[] = ceil($m4 / 30);

                } else {
                    $m4_rs_count[] = round($m4 / 30);

                }
                if ($a4 < 30) {
                    $a4_rs_count[] = ceil($a4 / 30);

                } else {
                    $a4_rs_count[] = round($a4 / 30);

                }

                if ($m3 >= 76) {
                    if ($m3_rs_count[$counter] < 5)
                        $m3_rls_count[] = ceil(($m3_rs_count[$counter]) / 5);
                    else
                        $m3_rls_count[] = round(($m3_rs_count[$counter]) / 5);
                } else {
                    $m3_rls_count[] = 0;
                }

                if ($a3 >= 76) {
                    if ($a3_rs_count[$counter] < 5)
                        $a3_rls_count[] = ceil(($a3_rs_count[$counter]) / 5);
                    else
                        $a3_rls_count[] = round(($a3_rs_count[$counter]) / 5);
                } else {
                    $a3_rls_count[] = 0;
                }

                if ($m4 >= 76) {
                    if ($m4_rs_count[$counter] < 5)
                        $m4_rls_count[] = ceil(($m4_rs_count[$counter]) / 5);
                    else
                        $m4_rls_count[] = round(($m4_rs_count[$counter]) / 5);
                } else {
                    $m4_rls_count[] = 0;
                }

                if ($a4 >= 76) {
                    if ($a4_rs_count[$counter] < 5)
                        $a4_rls_count[] = ceil(($a4_rs_count[$counter]) / 5);
                    else
                        $a4_rls_count[] = round(($a4_rs_count[$counter]) / 5);
                } else {
                    $a4_rls_count[] = 0;
                }


                if ($m3 < 250) {

                    $m3_ds_count[] = ceil(($m3) / 250);
                } else {

                    $m3_ds_count[] = round(($m3) / 250);
                }
                if ($a3 < 250) {

                    $a3_ds_count[] = ceil(($a3) / 250);
                } else {

                    $a3_ds_count[] = round(($a3) / 250);
                }
                if ($m4 < 250) {

                    $m4_ds_count[] = ceil(($m4) / 250);
                } else {

                    $m4_ds_count[] = round(($m4) / 250);
                }
                if ($a4 < 250) {

                    $a4_ds_count[] = ceil(($a4) / 250);
                } else {

                    $a4_ds_count[] = round(($a4) / 250);
                }

                $rs_max_duty += $m3_rs_count[$counter] + $a3_rs_count[$counter] + $m4_rs_count[$counter] + $a4_rs_count[$counter];
                $rls_max_duty += $m3_rls_count[$counter] + $a3_rls_count[$counter] + $m4_rls_count[$counter] + $a4_rls_count[$counter];
                $ds_max_duty += $m3_ds_count[$counter] + $a3_ds_count[$counter] + $m4_ds_count[$counter] + $a4_ds_count[$counter];

                $counter++;

            }

            $this->data["m3_rs_count"] = $m3_rs_count;
            $this->data["a3_rs_count"] = $a3_rs_count;

            $this->data["m4_rs_count"] = $m4_rs_count;
            $this->data["a4_rs_count"] = $a4_rs_count;


            $this->data["m3_rls_count"] = $m3_rls_count;
            $this->data["a3_rls_count"] = $a3_rls_count;

            $this->data["m4_rls_count"] = $m4_rls_count;
            $this->data["a4_rls_count"] = $a4_rls_count;

            $this->data["m3_ds_count"] = $m3_ds_count;
            $this->data["a3_ds_count"] = $a3_ds_count;

            $this->data["m4_ds_count"] = $m4_ds_count;
            $this->data["a4_ds_count"] = $a4_ds_count;

            foreach ($td as $key => $val) {
                $m3_rs_count[$key] += $m4_rs_count[$key];
                $a3_rs_count[$key] += $a4_rs_count[$key];

                $m3_rls_count[$key] += $m4_rls_count[$key];
                $a3_rls_count[$key] += $a4_rls_count[$key];

                $m3_ds_count[$key] += $m4_ds_count[$key];
                $a3_ds_count[$key] += $a4_ds_count[$key];
            }


            $this->data["rs_count"] = $rs_max_duty;
            $this->data["rls_count"] = $rls_max_duty;
            $this->data["ds_count"] = $ds_max_duty;


            $rs_priority_duty = $settings[0]->rs_priority_duty;
            $rls_priority_duty = $settings[0]->rls_priority_duty;
            $ds_priority_duty = $settings[0]->ds_priority_duty;


            $rs_max_duty_temp = ceil($rs_max_duty / count($RS));
            $rls_max_duty_temp = ceil($rls_max_duty / count($RLS));
            $ds_max_duty_temp = ceil($ds_max_duty / count($DS));

            if ($rs_priority_duty < $rs_max_duty_temp && is_array($RS_pri) && count($RS_pri) >= 1 && $rs_priority_duty >= 1) {
                $this->data["rs_max_duty"] = $rs_max_duty = ceil(($rs_max_duty + (($rs_max_duty_temp - $rs_priority_duty) * count($RS_pri))) / count($RS));
            } else {
                $this->data["rs_max_duty"] = $rs_max_duty = ceil($rs_max_duty / count($RS));
            }

            if ($rls_priority_duty < $rls_max_duty_temp && is_array($RLS_pri) && count($RLS_pri) >= 1 && $rls_priority_duty >= 1) {
                $this->data["rls_max_duty"] = $rls_max_duty = ceil(($rls_max_duty + (($rls_max_duty_temp - $rls_priority_duty) * count($RLS_pri))) / count($RLS));
            } else {
                $this->data["rls_max_duty"] = $rls_max_duty = ceil($rls_max_duty / count($RLS));
            }


            if ($ds_priority_duty < $ds_max_duty_temp && is_array($DS_pri) && count($DS_pri) >= 1 && $ds_priority_duty >= 1) {
                $this->data["ds_max_duty"] = $ds_max_duty = ceil(($ds_max_duty + (($ds_max_duty_temp - $ds_priority_duty) * count($DS_pri))) / count($DS));
            } else {
                $this->data["ds_max_duty"] = $ds_max_duty = ceil($ds_max_duty / count($DS));
            }


//---------------------------------------------------RS------------------------------------------------------------
            if ($req_flag == "rs" || $gen_flag) {
                $rs_allowed = array();
                $rs_shortage = array();
                $rs_last = array();

                $allocation = 0;
                $rs_total_duty = 0;
                $rs_index = 0;

                $rs_pri_fac = array();
                $rs_ex_fac = array();
                foreach ($RS as $rs_rand) {
                    if(!array_key_exists($rs_rand->id,$ex_dates)){
                        $ex_dates[$rs_rand->id] = array();
                    } else {
                        $rs_ex_fac[$rs_rand->id] = $rs_rand->id;
                    }
                    $rs_allowed[$rs_rand->id] = 0;


                    if ($rs_rand->priority && $rs_priority_duty >= 1 && $rs_priority_duty < $this->data["rs_max_duty"]) {
                        $rs_max_duty = $rs_priority_duty;
                        $rs_pri_fac[$rs_rand->id] = $rs_priority_duty;
                    } else
                        $rs_max_duty = $this->data["rs_max_duty"];
                    $duty_counter = 0;
                    $mr_counter = 0;
                    $aft_counter = 0;
                    $rs_index++;
                    $aft_share = round($rs_max_duty * 25 / 100);
                    $mr_share = $rs_max_duty - $aft_share;
                    foreach ($td as $tdKey => $time_data) {

                        $m3_flag = true;
                        $a3_flag = true;
//							if($duty_counter != $rs_max_duty && $mr_share!=0){
//								if($m3_rs_count[$mr_counter] != 0 && $duty_counter != $rs_max_duty){
//									$master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
//									$duty_counter++;
//									$m3_rs_count[$mr_counter]--;
//									$m3_flag=false;
//									$rs_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($rs_rand->id,$rs_last))
//										$rs_last[$rs_rand->id] = $tdKey;
//
//								}
//							}
//
//							if($duty_counter != $rs_max_duty && $aft_share!=0){
//
//
//									if($a3_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty){
//										$master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
//										$duty_counter++;
//										$a3_rs_count[$aft_counter]--;
//										$a3_flag=false;
//										$rs_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($rs_rand->id,$rs_last))
//											$rs_last[$rs_rand->id] = $tdKey;
//
//									}
//
//							}

                        if ($duty_counter != $rs_max_duty && $m3_flag && !in_array($time_data->db_date,$ex_dates[$rs_rand->id])) {
                            if ($m3_rs_count[$mr_counter] != 0 && $duty_counter != $rs_max_duty) {
                                $master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
                                $duty_counter++;
                                $m3_rs_count[$mr_counter]--;
                                $rs_total_duty++;
                                $allocation++;
                                $mr_share--;
                                if (!array_key_exists($rs_rand->id, $rs_last))
                                    $rs_last[$rs_rand->id] = $tdKey;

                            }
                        }

                        if ($duty_counter != $rs_max_duty && $a3_flag && !in_array($time_data->db_date,$ex_dates[$rs_rand->id])) {
                            if ($a3_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty) {
                                $master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
                                $duty_counter++;
                                $a3_rs_count[$aft_counter]--;
                                $rs_total_duty++;
                                $allocation++;
                                $aft_share--;
                                if (!array_key_exists($rs_rand->id, $rs_last))
                                    $rs_last[$rs_rand->id] = $tdKey;

                            }

                        }

                        $mr_counter++;
                        $aft_counter++;
                    }

                    $rs_shortage[$rs_rand->id] = $duty_counter;
                    if (!array_key_exists($rs_rand->id, $rs_last)) {
                        $rs_last[$rs_rand->id] = count($td);
                    }
                    if ($duty_counter <= $this->data["rs_max_duty"] - 1 || in_array($rs_rand, $RS_pri))
                        $rs_allowed[$rs_rand->id] = 0;

                }


                foreach ($a3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][0][0]["m3"], $master[$this->getDateTag($td[$j]->date)][0][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][0][1]["a3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rs_shortage[$bval] <= $this->data["rs_max_duty"] && !array_key_exists($bval,$rs_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][0][1]["a3"][$bkey] = $bval;
                                            $rs_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $a3_rs_count[$key]--;
                                            $rs_allowed[$bval]++;

                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($m3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][0][0]["m3"], $master[$this->getDateTag($td[$j]->date)][0][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][0][0]["m3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rs_shortage[$bval] <= $this->data["rs_max_duty"] && !array_key_exists($bval,$rs_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][0][0]["m3"][$bkey] = $bval;
                                            $rs_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $m3_rs_count[$key]--;
                                            $rs_allowed[$bval]++;


                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($a3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][0][1]["a3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($m3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][0][0]["m3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                $to_test = "";
                $final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs);
                $sum_min = PHP_INT_MAX;
                $master_copy = $master;
                $rs_shortage_copy = $rs_shortage;
                $rs_allowed_cpy = $rs_allowed;
                $duty_ctr_str_rs = "";
                $gap_str_rs = "";
                set_time_limit(0);

                foreach ($RS as $allowKey => $alloVal) {
                    if ($rs_shortage[$alloVal->id] != 0) {
                        if ($allowKey % ($rs_four) != 0)
                            $rs_allowed[$alloVal->id] = $rs_allowed[$alloVal->id] + $rs_one;
                        else
                            $rs_allowed[$alloVal->id] = $rs_allowed[$alloVal->id] + $rs_two;
                    } else {
                        $rs_allowed[$alloVal->id] = 0;
                    }
                }


                foreach (array_reverse($RS) as $rskey => $rsp) {
                    if ($rs_shortage[$rsp->id] <= $this->data["rs_max_duty"] - $rs_three && !array_key_exists($rsp->id,$rs_ex_fac)) {
                        $pos = 1;

                        if (array_key_exists($rsp->id, $rs_pri_fac))
                            $req = $rs_pri_fac[$rsp->id] - $rs_shortage[$rsp->id];
                        else {
                            $req = $this->data["rs_max_duty"] - $rs_shortage[$rsp->id];
                            if ($req == $this->data["rs_max_duty"]) {
                                //$req = $this->data["rs_max_duty"] - 1;
                            }
                        }


                        $req_counter = 0;

                        while (array_key_exists($rs_last[$rsp->id] - $pos, $td) && $req_counter != $req) {
                            $got = 0;

                            $date_tag = $td[$rs_last[$rsp->id] - $pos]->date;


                            foreach (array_merge($master[$this->getDateTag($date_tag)][0][0]["m3"], $master[$this->getDateTag($date_tag)][0][1]["a3"]) as $pt => $idVal) {
                                if ($got == 0 && $rs_allowed[$idVal] != 0 && !isset($master[$this->getDateTag($date_tag)][0][0]["m3"][$rsp->name]) && !array_key_exists($idVal,$rs_ex_fac)) {

                                    for ($j = $this->data["rs_max_duty"] + 4; $j > 0; $j--) {
                                        if ($got == 0)
                                            if (array_key_exists($idVal, $rs_shortage) && !array_key_exists($rsp->name, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                                if ($rs_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rs_allowed) && $rs_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                                        $master[$this->getDateTag($date_tag)][0][0]["m3"][$rsp->name] = $rsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][0][0]["m3"][$pt]);
                                                        $rs_shortage[$idVal]--;
                                                        $rs_shortage[$rsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt."---->".$rsp->name."------->".$date_tag."<br>";
                                                        $rs_allowed[$idVal]--;
                                                        $got++;
                                                    }

                                                }
                                            }

                                        if ($got == 0)
                                            if (array_key_exists($idVal, $rs_shortage) && !array_key_exists($rsp->name, $master[$this->getDateTag($date_tag)][0][1]["a3"])) {
                                                if ($rs_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rs_allowed) && $rs_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][0][1]["a3"])) {
                                                        $master[$this->getDateTag($date_tag)][0][1]["a3"][$rsp->name] = $rsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][0][1]["a3"][$pt]);
                                                        $rs_shortage[$idVal]--;
                                                        $rs_shortage[$rsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt . "---->" . $rsp->name . "------->" . $date_tag . "<br>";
                                                        $rs_allowed[$idVal]--;
                                                        $got++;
                                                    }
                                                }
                                            }
                                    }
                                }
                            }


                            if ($got == 0) {
                                //echo "<h3>Skipped {$date_tag}</h3><br>";
                            }
                            $pos++;
                        }
                    }

                }


                $max_arr=array();
                $diff_array_rs = array();
                $counter = 1;
                $gap_str_rs = "";
                $duty_arr_rs = array();
                foreach ($RS as $rskey => $rsval) {

                    if (!array_key_exists($rsval->id, $diff_array_rs))
                        $diff_array_rs[$rsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m3"] as $asKey => $asVal) {
                            if ($rsval->id == $asVal) {
                                $diff_array_rs[$rsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m4"] as $asKey => $asVal) {
                            if ($rsval->id == $asVal) {
                                $diff_array_rs[$rsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a3"] as $asKey => $asVal) {
                            if ($rsval->id == $asVal) {
                                $diff_array_rs[$rsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a4"] as $asKey => $asVal) {
                            if ($rsval->id == $asVal) {
                                $diff_array_rs[$rsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_rs[$rsval->id]);
                    $diff_array_rs[$rsval->id] = array_values($diff_array_rs[$rsval->id]);
                    for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
                        if ($max < $dif){
                            $max = $dif;
                        }
                    }

                    if(!array_key_exists($rsval->id,$rs_ex_fac))
                        $max_arr[$rsval->id] = $max;
                    else
                        $max_arr[$rsval->id] = 0;

                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_rs .= "<tr><td>{$counter}</td><td>{$rsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }




                }

                $check_fg="";
                foreach($RS as $rskey => $rsval){
                    $last = 0;
                    $max = $max_arr[$rsval->id];
                    if ($max - 1 >= 3)
                        for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
                            if(array_key_exists($i,$diff_array_rs[$rsval->id]) && array_key_exists($i+1,$diff_array_rs[$rsval->id]))
                                $dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
                            else
                                $dif=0;

                            if ($max == $dif) {
                                if ($i + 1 < ceil(count($diff_array_rs[$rsval->id]) / 2)) {
                                    $last=$i+1;
                                    for ($j = $i; $j >= 0; $j--) {
                                        if(array_key_exists($j,$diff_array_rs[$rsval->id]))
                                            if (array_key_exists($diff_array_rs[$rsval->id][$j], $td)) {
                                                if (array_key_exists($j, $diff_array_rs[$rsval->id])) {
                                                    if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                        //														$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED ".$rsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$rsval->name]);
                                                        $rs_shortage[$rsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }


                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED " . $rsval->name] = -1;
                                                        }
                                                        unset($diff_array_rs[$rsval->id][$j]);
//

                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_rs[$rsval->id])) {
                                                    if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED ".$rsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$rsval->name]);
                                                        $rs_shortage[$rsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED " . $rsval->name] = -1;
                                                        }
                                                        unset($diff_array_rs[$rsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_rs[$rsval->id])) {
                                                    if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED ".$rsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$rsval->name]);
                                                        $rs_shortage[$rsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED " . $rsval->name] = -1;
                                                        }
                                                        unset($diff_array_rs[$rsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_rs[$rsval->id])) {
                                                    if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED ".$rsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$rsval->name]);
                                                        $rs_shortage[$rsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED " . $rsval->name] = -1;
                                                        }
                                                        unset($diff_array_rs[$rsval->id][$j]);
                                                    }
                                                }
                                            }
                                    }
                                } else {
                                    for ($j = $i + 1; $j < count($diff_array_rs[$rsval->id]); $j++) {
                                        if (array_key_exists($diff_array_rs[$rsval->id][$j], $td)) {
                                            if (array_key_exists($j, $diff_array_rs[$rsval->id]))
                                                if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
//														$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED ".$rsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$rsval->name]);
                                                    $rs_shortage[$rsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }


                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED " . $rsval->name] = -1;
                                                    }
                                                    unset($diff_array_rs[$rsval->id][$j]);

                                                }
                                            if (array_key_exists($j, $diff_array_rs[$rsval->id]))
                                                if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED ".$rsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$rsval->name]);
                                                    $rs_shortage[$rsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED " . $rsval->name] = -1;
                                                    }
                                                    unset($diff_array_rs[$rsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_rs[$rsval->id]))
                                                if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED ".$rsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$rsval->name]);
                                                    $rs_shortage[$rsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED " . $rsval->name] = -1;
                                                    }
                                                    unset($diff_array_rs[$rsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_rs[$rsval->id]))
                                                if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED ".$rsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$rsval->name]);
                                                    $rs_shortage[$rsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                        $rs_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                            $diff_array_rs[$fVal] = array();
                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal,$rs_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                    for ($x = 0; $x <= $this->data["rs_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                            $rs_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                $diff_array_rs[$fVal] = array();
                                                                                            $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED " . $rsval->name] = -1;
                                                    }
                                                    unset($diff_array_rs[$rsval->id][$j]);
                                                }
                                        }
                                    }
                                }


                            }

                        }
                }

                $sh_cnt = 0;
                $rs_id_name_pair = array();
                foreach($RS as $rsval){
                    $rs_id_name_pair[$rsval->id] = $rsval->name;
                    asort($diff_array_rs[$rsval->id]);
                    $diff_array_rs[$rsval->id] = array_values($diff_array_rs[$rsval->id]);
                    if (!array_key_exists(count($diff_array_rs[$rsval->id]), $duty_arr_rs)) {
                        $duty_arr_rs[count($diff_array_rs[$rsval->id])] = array();
                    }

                    $duty_arr_rs[count($diff_array_rs[$rsval->id])][] = $rsval->id;
                    $sh_cnt+=$rs_shortage[$rsval->id];
                }

                $rs_fac_duty=array();
                foreach ($duty_arr_rs as $key => $val) {
                    $cnt = count($val);
                    $rs_fac_duty[$key] = $cnt;
                }
                ksort($rs_fac_duty);

                $txt = "";
                $txt_ctr=0;
                foreach($rs_fac_duty as $dty_cnt => $num_fac) {
                    foreach ($duty_arr_rs[$dty_cnt] as $fac_id) {
                        if (count($diff_array_rs[$fac_id]) < $this->data["rs_max_duty"] && !array_key_exists($fac_id,$rs_ex_fac)) {
                            $req = $this->data["rs_max_duty"] - count($diff_array_rs[$fac_id]) -1;
                            $rs_flg=0;
                            for ($b = 0; $b < $req; $b++){
                                $rs_flg=0;
                                if($rs_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rs_flg=0;
                                        if ($req>0 && $rs_flg==0) {
                                            asort($diff_array_rs[$fac_id]);
                                            $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                            if (array_key_exists(0, $diff_array_rs[$fac_id])){
                                                $first = $diff_array_rs[$fac_id][0];
                                                if (array_key_exists($first - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"]) && $rs_flg == 0) {
                                                            for ($x = $this->data["rs_max_duty"] + 2; $x >= $this->data["rs_max_duty"]; $x--) {
                                                                if ($rs_flg == 0 && count($diff_array_rs[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(First) Unset-->".$asKey."(".count($diff_array_rs[$asVal]).") Set--->".$rs_id_name_pair[$fac_id]."(".count($diff_array_rs[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"][$rs_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rs[$fac_id][] = $first - $i;
                                                                    $rs_shortage[$fac_id]++;
                                                                    asort($diff_array_rs[$fac_id]);
                                                                    $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                                    unset($diff_array_rs[$asVal][array_search($first - $i,$diff_array_rs[$asVal])]);
                                                                    asort($diff_array_rs[$asVal]);
                                                                    $diff_array_rs[$asVal] = array_values($diff_array_rs[$asVal]);
                                                                    $rs_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $rs_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if($rs_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rs_flg=0;
                                        if ($req>0 && $rs_flg==0) {
                                            asort($diff_array_rs[$fac_id]);
                                            if (array_key_exists(count($diff_array_rs[$fac_id]) - 1, $diff_array_rs[$fac_id])){
                                                $last = $diff_array_rs[$fac_id][count($diff_array_rs[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"]) && $rs_flg == 0) {
                                                            for ($x = $this->data["rs_max_duty"] + 2; $x >= $this->data["rs_max_duty"]; $x--) {
                                                                if ($rs_flg == 0 && count($diff_array_rs[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Last) Unset-->".$asKey."(".count($diff_array_rs[$asVal]).") Set--->".$rs_id_name_pair[$fac_id]."(".count($diff_array_rs[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"][$rs_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rs[$fac_id][] = $last + $i;
                                                                    $rs_shortage[$fac_id]++;
                                                                    asort($diff_array_rs[$fac_id]);
                                                                    $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                                    unset($diff_array_rs[$asVal][array_search($last + $i,$diff_array_rs[$asVal])]);
                                                                    $diff_array_rs[$asVal] = array_values($diff_array_rs[$asVal]);
                                                                    asort($diff_array_rs[$asVal]);
                                                                    $rs_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $rs_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if($rs_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rs_flg=0;
                                        if ($req>0 && $rs_flg==0) {
                                            asort($diff_array_rs[$fac_id]);
                                            $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                            if (array_key_exists(0, $diff_array_rs[$fac_id])){
                                                $first = $diff_array_rs[$fac_id][0];
                                                if (array_key_exists($first - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"]) && $rs_flg == 0) {
                                                            for ($x = $this->data["rs_max_duty"] + 2; $x >= $this->data["rs_max_duty"]; $x--) {
                                                                if ($rs_flg == 0 && count($diff_array_rs[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(First) Unset-->".$asKey."(".count($diff_array_rs[$asVal]).") Set--->".$rs_id_name_pair[$fac_id]."(".count($diff_array_rs[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"][$rs_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rs[$fac_id][] = $first - $i;
                                                                    $rs_shortage[$fac_id]++;
                                                                    asort($diff_array_rs[$fac_id]);
                                                                    $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                                    unset($diff_array_rs[$asVal][array_search($first - $i,$diff_array_rs[$asVal])]);
                                                                    asort($diff_array_rs[$asVal]);
                                                                    $diff_array_rs[$asVal] = array_values($diff_array_rs[$asVal]);
                                                                    $rs_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $rs_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if($rs_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rs_flg=0;
                                        if ($req>0 && $rs_flg==0) {
                                            asort($diff_array_rs[$fac_id]);
                                            if (array_key_exists(count($diff_array_rs[$fac_id]) - 1, $diff_array_rs[$fac_id])){
                                                $last = $diff_array_rs[$fac_id][count($diff_array_rs[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"]) && $rs_flg == 0) {
                                                            for ($x = $this->data["rs_max_duty"] + 2; $x >= $this->data["rs_max_duty"]; $x--) {
                                                                if ($rs_flg == 0 && count($diff_array_rs[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Last) Unset-->".$asKey."(".count($diff_array_rs[$asVal]).") Set--->".$rs_id_name_pair[$fac_id]."(".count($diff_array_rs[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"][$rs_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rs[$fac_id][] = $last + $i;
                                                                    $rs_shortage[$fac_id]++;
                                                                    asort($diff_array_rs[$fac_id]);
                                                                    $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                                    unset($diff_array_rs[$asVal][array_search($last + $i,$diff_array_rs[$asVal])]);
                                                                    $diff_array_rs[$asVal] = array_values($diff_array_rs[$asVal]);
                                                                    asort($diff_array_rs[$asVal]);
                                                                    $rs_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $rs_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }


                            }
                        }
                    }
                }


                $max_arr=array();
                $diff_array_rs = array();
                $counter = 1;
                $gap_str_rs = "";
                $duty_arr_rs = array();
                foreach ($RS as $rskey => $rsval) {

                    if (!array_key_exists($rsval->id, $diff_array_rs))
                        $diff_array_rs[$rsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m3"] as $asKey => $asVal) {
                            if ($rsval->id == $asVal) {
                                $diff_array_rs[$rsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m4"] as $asKey => $asVal) {
                            if ($rsval->id == $asVal) {
                                $diff_array_rs[$rsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a3"] as $asKey => $asVal) {
                            if ($rsval->id == $asVal) {
                                $diff_array_rs[$rsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a4"] as $asKey => $asVal) {
                            if ($rsval->id == $asVal) {
                                $diff_array_rs[$rsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_rs[$rsval->id]);
                    $diff_array_rs[$rsval->id] = array_values($diff_array_rs[$rsval->id]);
                    for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
                        if ($max < $dif){
                            $max = $dif;
                        }
                    }

                    $max_arr[$rsval->id] = $max;


                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_rs .= "<tr><td>{$counter}</td><td>{$rsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }




                }


                $sh_cnt = 0;
                $duty_arr_rs = array();
                foreach($RS as $rsval){
                    $rs_id_name_pair[$rsval->id] = $rsval->name;
                    asort($diff_array_rs[$rsval->id]);
                    $diff_array_rs[$rsval->id] = array_values($diff_array_rs[$rsval->id]);
                    if (!array_key_exists(count($diff_array_rs[$rsval->id]), $duty_arr_rs)) {
                        $duty_arr_rs[count($diff_array_rs[$rsval->id])] = array();
                    }

                    $duty_arr_rs[count($diff_array_rs[$rsval->id])][] = $rsval->id;
                    $sh_cnt+=$rs_shortage[$rsval->id];
                }

                $duty_ctr_str_rs = "";
                $rs_sum_duty=0;
                foreach ($duty_arr_rs as $key => $val) {
                    $ct = count($val);
                    $duty_ctr_str_rs .= "<tr><td>{$ct}</td><td>{$key}</td></tr>";
                    $rs_sum_duty+=$ct*$key;
                }
                $duty_ctr_str_rs .= "<tr><td>Total</td><td>{$rs_sum_duty}</td></tr>";
                if($rs_sum_duty != $this->data["rs_count"]){
                    $duty_ctr_str_rs .= "<tr  style='background:red;' class='blink' ><td>Difference</td><td>{($this->data['rs_count']-$rs_sum_duty)}</td></tr>";
                }

                if ($counter + count($duty_arr_rs) <= $sum_min) {
                    $sum_min = $counter + count($duty_arr_rs);
                    //$final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs, count($duty_arr_rs), $counter, $sum_min,$c_arr[0],$c_arr[1],$c_arr[2]);
                    $to_test .= $rs_one . " " . $rs_two . " " . $rs_three . " " . $rs_four . " -> " . $sum_min . "<br>";
                }

                foreach ($a4_rs_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][0][1]["a3"] as $k => $v) {
                        if ($ctr != $this->data["a4_rs_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][0][1]["a4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][0][1]["a3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach ($m4_rs_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][0][0]["m3"] as $k => $v) {
                        if ($ctr != $this->data["m4_rs_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][0][0]["m4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][0][0]["m3"][$k]);
                            $ctr++;
                        }
                    }
                }


            }


//-------------------------------------------------------RLS-----------------------------------------------------------
            if ($req_flag == "ls" || $gen_flag) {
                $rls_allowed = array();
                $rls_shortage = array();
                $rls_last = array();

                $allocation = 0;
                $rls_total_duty = 0;
                $rls_index = 0;

                $rls_pri_fac = array();
                $rls_ex_fac = array();
                foreach ($RLS as $rls_rand) {
                    if(!array_key_exists($rls_rand->id,$ex_dates)){
                        $ex_dates[$rls_rand->id] = array();
                    } else {
                        $rls_ex_fac[$rls_rand->id] = $rls_rand->id;
                    }
                    $rls_allowed[$rls_rand->id] = 0;


                    if ($rls_rand->priority && $rls_priority_duty >= 1 && $rls_priority_duty < $this->data["rls_max_duty"]) {
                        $rls_max_duty = $rls_priority_duty;
                        $rls_pri_fac[$rls_rand->id] = $rls_priority_duty;
                    } else
                        $rls_max_duty = $this->data["rls_max_duty"];
                    $duty_counter = 0;
                    $mr_counter = 0;
                    $aft_counter = 0;
                    $rls_index++;
                    $aft_share = round($rls_max_duty * 25 / 100);
                    $mr_share = $rls_max_duty - $aft_share;
                    foreach ($td as $tdKey => $time_data) {

                        $m3_flag = true;
                        $a3_flag = true;
//							if($duty_counter != $rls_max_duty && $mr_share!=0){
//								if($m3_rls_count[$mr_counter] != 0 && $duty_counter != $rls_max_duty){
//									$master[$this->getDateTag($time_data->date)][1][0]["m3"][$rls_rand->name] = $rls_rand->id;
//									$duty_counter++;
//									$m3_rls_count[$mr_counter]--;
//									$m3_flag=false;
//									$rls_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($rls_rand->id,$rls_last))
//										$rls_last[$rls_rand->id] = $tdKey;
//
//								}
//							}
//
//							if($duty_counter != $rls_max_duty && $aft_share!=0){
//
//
//									if($a3_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty){
//										$master[$this->getDateTag($time_data->date)][1][1]["a3"][$rls_rand->name] = $rls_rand->id;
//										$duty_counter++;
//										$a3_rls_count[$aft_counter]--;
//										$a3_flag=false;
//										$rls_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($rls_rand->id,$rls_last))
//											$rls_last[$rls_rand->id] = $tdKey;
//
//									}
//
//							}

                        if ($duty_counter != $rls_max_duty && $m3_flag && !in_array($time_data->db_date,$ex_dates[$rls_rand->id])) {
                            if ($m3_rls_count[$mr_counter] != 0 && $duty_counter != $rls_max_duty) {
                                $master[$this->getDateTag($time_data->date)][1][0]["m3"][$rls_rand->name] = $rls_rand->id;
                                $duty_counter++;
                                $m3_rls_count[$mr_counter]--;
                                $rls_total_duty++;
                                $allocation++;
                                $mr_share--;
                                if (!array_key_exists($rls_rand->id, $rls_last))
                                    $rls_last[$rls_rand->id] = $tdKey;

                            }
                        }

                        if ($duty_counter != $rls_max_duty && $a3_flag && !in_array($time_data->db_date,$ex_dates[$rls_rand->id])) {
                            if ($a3_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty) {
                                $master[$this->getDateTag($time_data->date)][1][1]["a3"][$rls_rand->name] = $rls_rand->id;
                                $duty_counter++;
                                $a3_rls_count[$aft_counter]--;
                                $rls_total_duty++;
                                $allocation++;
                                $aft_share--;
                                if (!array_key_exists($rls_rand->id, $rls_last))
                                    $rls_last[$rls_rand->id] = $tdKey;

                            }

                        }

                        $mr_counter++;
                        $aft_counter++;
                    }

                    $rls_shortage[$rls_rand->id] = $duty_counter;
                    if (!array_key_exists($rls_rand->id, $rls_last)) {
                        $rls_last[$rls_rand->id] = count($td);
                    }
                    if ($duty_counter <= $this->data["rls_max_duty"] - 1 || in_array($rls_rand, $RLS_pri))
                        $rls_allowed[$rls_rand->id] = 0;

                }


                foreach ($a3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][1][0]["m3"], $master[$this->getDateTag($td[$j]->date)][1][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][1][1]["a3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rls_shortage[$bval] <= $this->data["rls_max_duty"] && !array_key_exists($bval,$rls_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][1][1]["a3"][$bkey] = $bval;
                                            $rls_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $a3_rls_count[$key]--;
                                            $rls_allowed[$bval]++;

                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($m3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][1][0]["m3"], $master[$this->getDateTag($td[$j]->date)][1][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][1][0]["m3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rls_shortage[$bval] <= $this->data["rls_max_duty"] && !array_key_exists($bval,$rls_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][1][0]["m3"][$bkey] = $bval;
                                            $rls_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $m3_rls_count[$key]--;
                                            $rls_allowed[$bval]++;


                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($a3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][1][1]["a3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($m3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][1][0]["m3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                $to_test = "";
                $final_arr = array($master, $gap_str_rls, $duty_ctr_str_rls);
                $sum_min = PHP_INT_MAX;
                $master_copy = $master;
                $rls_shortage_copy = $rls_shortage;
                $rls_allowed_cpy = $rls_allowed;
                $duty_ctr_str_rls = "";
                $gap_str_rls = "";
                set_time_limit(0);

                foreach ($RLS as $allowKey => $alloVal) {
                    if ($rls_shortage[$alloVal->id] != 0) {
                        if ($allowKey % ($rls_four) != 0)
                            $rls_allowed[$alloVal->id] = $rls_allowed[$alloVal->id] + $rls_one;
                        else
                            $rls_allowed[$alloVal->id] = $rls_allowed[$alloVal->id] + $rls_two;
                    } else {
                        $rls_allowed[$alloVal->id] = 0;
                    }
                }


                foreach (array_reverse($RLS) as $rlskey => $rlsp) {
                    if ($rls_shortage[$rlsp->id] <= $this->data["rls_max_duty"] - $rls_three && !array_key_exists($rlsp->id,$rls_ex_fac)) {
                        $pos = 1;

                        if (array_key_exists($rlsp->id, $rls_pri_fac))
                            $req = $rls_pri_fac[$rlsp->id] - $rls_shortage[$rlsp->id];
                        else {
                            $req = $this->data["rls_max_duty"] - $rls_shortage[$rlsp->id];
                            if ($req == $this->data["rls_max_duty"]) {
                                //$req = $this->data["rls_max_duty"] - 1;
                            }
                        }


                        $req_counter = 0;

                        while (array_key_exists($rls_last[$rlsp->id] - $pos, $td) && $req_counter != $req) {
                            $got = 0;

                            $date_tag = $td[$rls_last[$rlsp->id] - $pos]->date;


                            foreach (array_merge($master[$this->getDateTag($date_tag)][1][0]["m3"], $master[$this->getDateTag($date_tag)][1][1]["a3"]) as $pt => $idVal) {
                                if ($got == 0 && $rls_allowed[$idVal] != 0 && !isset($master[$this->getDateTag($date_tag)][1][0]["m3"][$rlsp->name]) && !array_key_exists($idVal,$rls_ex_fac)) {

                                    for ($j = $this->data["rls_max_duty"] + 4; $j > 0; $j--) {
                                        if ($got == 0)
                                            if (array_key_exists($idVal, $rls_shortage) && !array_key_exists($rlsp->name, $master[$this->getDateTag($date_tag)][1][0]["m3"])) {
                                                if ($rls_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rls_allowed) && $rls_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][1][0]["m3"])) {
                                                        $master[$this->getDateTag($date_tag)][1][0]["m3"][$rlsp->name] = $rlsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][1][0]["m3"][$pt]);
                                                        $rls_shortage[$idVal]--;
                                                        $rls_shortage[$rlsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt."---->".$rlsp->name."------->".$date_tag."<br>";
                                                        $rls_allowed[$idVal]--;
                                                        $got++;
                                                    }

                                                }
                                            }

                                        if ($got == 0)
                                            if (array_key_exists($idVal, $rls_shortage) && !array_key_exists($rlsp->name, $master[$this->getDateTag($date_tag)][1][1]["a3"])) {
                                                if ($rls_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rls_allowed) && $rls_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][1][1]["a3"])) {
                                                        $master[$this->getDateTag($date_tag)][1][1]["a3"][$rlsp->name] = $rlsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][1][1]["a3"][$pt]);
                                                        $rls_shortage[$idVal]--;
                                                        $rls_shortage[$rlsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt . "---->" . $rlsp->name . "------->" . $date_tag . "<br>";
                                                        $rls_allowed[$idVal]--;
                                                        $got++;
                                                    }
                                                }
                                            }
                                    }
                                }
                            }


                            if ($got == 0) {
                                //echo "<h3>Skipped {$date_tag}</h3><br>";
                            }
                            $pos++;
                        }
                    }

                }


                $max_arr=array();
                $diff_array_rls = array();
                $counter = 1;
                $gap_str_rls = "";
                $duty_arr_rls = array();
                foreach ($RLS as $rlskey => $rlsval) {

                    if (!array_key_exists($rlsval->id, $diff_array_rls))
                        $diff_array_rls[$rlsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][0]["m3"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][0]["m4"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][1]["a3"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][1]["a4"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_rls[$rlsval->id]);
                    $diff_array_rls[$rlsval->id] = array_values($diff_array_rls[$rlsval->id]);
                    for ($i = 0; $i < count($diff_array_rls[$rlsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_rls[$rlsval->id][$i] - $diff_array_rls[$rlsval->id][$i + 1]);
                        if ($max < $dif){
                            $max = $dif;
                        }
                    }

                    if(!array_key_exists($rlsval->id,$rls_ex_fac))
                        $max_arr[$rlsval->id] = $max;
                    else
                        $max_arr[$rlsval->id] = 0;

                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_rls .= "<tr><td>{$counter}</td><td>{$rlsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }




                }

                $check_fg="";
                foreach($RLS as $rlskey => $rlsval){
                    $last = 0;
                    $max = $max_arr[$rlsval->id];
                    if ($max - 1 >= 3)
                        for ($i = 0; $i < count($diff_array_rls[$rlsval->id]) - 1; $i++) {
                            if(array_key_exists($i,$diff_array_rls[$rlsval->id]) && array_key_exists($i+1,$diff_array_rls[$rlsval->id]))
                                $dif = abs($diff_array_rls[$rlsval->id][$i] - $diff_array_rls[$rlsval->id][$i + 1]);
                            else
                                $dif=0;

                            if ($max == $dif) {
                                if ($i + 1 < ceil(count($diff_array_rls[$rlsval->id]) / 2)) {
                                    $last=$i+1;
                                    for ($j = $i; $j >= 0; $j--) {
                                        if(array_key_exists($j,$diff_array_rls[$rlsval->id]))
                                            if (array_key_exists($diff_array_rls[$rlsval->id][$j], $td)) {
                                                if (array_key_exists($j, $diff_array_rls[$rlsval->id])) {
                                                    if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                        //														$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"]["TO BE ADDED ".$rlsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$rlsval->name]);
                                                        $rls_shortage[$rlsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }


                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"]["TO BE ADDED " . $rlsval->name] = -1;
                                                        }
                                                        unset($diff_array_rls[$rlsval->id][$j]);
//

                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_rls[$rlsval->id])) {
                                                    if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"]["TO BE ADDED ".$rlsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$rlsval->name]);
                                                        $rls_shortage[$rlsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"]["TO BE ADDED " . $rlsval->name] = -1;
                                                        }
                                                        unset($diff_array_rls[$rlsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_rls[$rlsval->id])) {
                                                    if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"]["TO BE ADDED ".$rlsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$rlsval->name]);
                                                        $rls_shortage[$rlsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"]["TO BE ADDED " . $rlsval->name] = -1;
                                                        }
                                                        unset($diff_array_rls[$rlsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_rls[$rlsval->id])) {
                                                    if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"]["TO BE ADDED ".$rlsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$rlsval->name]);
                                                        $rls_shortage[$rlsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"]["TO BE ADDED " . $rlsval->name] = -1;
                                                        }
                                                        unset($diff_array_rls[$rlsval->id][$j]);
                                                    }
                                                }
                                            }
                                    }
                                } else {
                                    for ($j = $i + 1; $j < count($diff_array_rls[$rlsval->id]); $j++) {
                                        if (array_key_exists($diff_array_rls[$rlsval->id][$j], $td)) {
                                            if (array_key_exists($j, $diff_array_rls[$rlsval->id]))
                                                if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
//														$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"]["TO BE ADDED ".$rlsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$rlsval->name]);
                                                    $rls_shortage[$rlsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }


                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"]["TO BE ADDED " . $rlsval->name] = -1;
                                                    }
                                                    unset($diff_array_rls[$rlsval->id][$j]);

                                                }
                                            if (array_key_exists($j, $diff_array_rls[$rlsval->id]))
                                                if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"]["TO BE ADDED ".$rlsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$rlsval->name]);
                                                    $rls_shortage[$rlsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"]["TO BE ADDED " . $rlsval->name] = -1;
                                                    }
                                                    unset($diff_array_rls[$rlsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_rls[$rlsval->id]))
                                                if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"]["TO BE ADDED ".$rlsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$rlsval->name]);
                                                    $rls_shortage[$rlsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"]["TO BE ADDED " . $rlsval->name] = -1;
                                                    }
                                                    unset($diff_array_rls[$rlsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_rls[$rlsval->id]))
                                                if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"]["TO BE ADDED ".$rlsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$rlsval->name]);
                                                    $rls_shortage[$rlsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal,$rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"]["TO BE ADDED " . $rlsval->name] = -1;
                                                    }
                                                    unset($diff_array_rls[$rlsval->id][$j]);
                                                }
                                        }
                                    }
                                }


                            }

                        }
                }

                $sh_cnt = 0;
                $rls_id_name_pair = array();
                foreach($RLS as $rlsval){
                    $rls_id_name_pair[$rlsval->id] = $rlsval->name;
                    asort($diff_array_rls[$rlsval->id]);
                    $diff_array_rls[$rlsval->id] = array_values($diff_array_rls[$rlsval->id]);
                    if (!array_key_exists(count($diff_array_rls[$rlsval->id]), $duty_arr_rls)) {
                        $duty_arr_rls[count($diff_array_rls[$rlsval->id])] = array();
                    }

                    $duty_arr_rls[count($diff_array_rls[$rlsval->id])][] = $rlsval->id;
                    $sh_cnt+=$rls_shortage[$rlsval->id];
                }

                $rls_fac_duty=array();
                foreach ($duty_arr_rls as $key => $val) {
                    $cnt = count($val);
                    $rls_fac_duty[$key] = $cnt;
                }
                ksort($rls_fac_duty);

                $txt = "";
                $txt_ctr=0;
                foreach($rls_fac_duty as $dty_cnt => $num_fac) {
                    foreach ($duty_arr_rls[$dty_cnt] as $fac_id) {
                        if (count($diff_array_rls[$fac_id]) < $this->data["rls_max_duty"] && !array_key_exists($fac_id,$rls_ex_fac)) {
                            $req = $this->data["rls_max_duty"] - count($diff_array_rls[$fac_id]) -1;
                            $rls_flg=0;
                            for ($b = 0; $b < $req; $b++){
                                $rls_flg=0;
                                if($rls_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rls_flg=0;
                                        if ($req>0 && $rls_flg==0) {
                                            asort($diff_array_rls[$fac_id]);
                                            $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                            if (array_key_exists(0, $diff_array_rls[$fac_id])){
                                                $firlst = $diff_array_rls[$fac_id][0];
                                                if (array_key_exists($firlst - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"]) && $rls_flg == 0) {
                                                            for ($x = $this->data["rls_max_duty"] + 2; $x >= $this->data["rls_max_duty"]; $x--) {
                                                                if ($rls_flg == 0 && count($diff_array_rls[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Firlst) Unset-->".$asKey."(".count($diff_array_rls[$asVal]).") Set--->".$rls_id_name_pair[$fac_id]."(".count($diff_array_rls[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"][$rls_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rls[$fac_id][] = $firlst - $i;
                                                                    $rls_shortage[$fac_id]++;
                                                                    asort($diff_array_rls[$fac_id]);
                                                                    $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                                                    unset($diff_array_rls[$asVal][array_search($firlst - $i,$diff_array_rls[$asVal])]);
                                                                    asort($diff_array_rls[$asVal]);
                                                                    $diff_array_rls[$asVal] = array_values($diff_array_rls[$asVal]);
                                                                    $rls_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $rls_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if($rls_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rls_flg=0;
                                        if ($req>0 && $rls_flg==0) {
                                            asort($diff_array_rls[$fac_id]);
                                            if (array_key_exists(count($diff_array_rls[$fac_id]) - 1, $diff_array_rls[$fac_id])){
                                                $last = $diff_array_rls[$fac_id][count($diff_array_rls[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"]) && $rls_flg == 0) {
                                                            for ($x = $this->data["rls_max_duty"] + 2; $x >= $this->data["rls_max_duty"]; $x--) {
                                                                if ($rls_flg == 0 && count($diff_array_rls[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Last) Unset-->".$asKey."(".count($diff_array_rls[$asVal]).") Set--->".$rls_id_name_pair[$fac_id]."(".count($diff_array_rls[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"][$rls_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rls[$fac_id][] = $last + $i;
                                                                    $rls_shortage[$fac_id]++;
                                                                    asort($diff_array_rls[$fac_id]);
                                                                    $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                                                    unset($diff_array_rls[$asVal][array_search($last + $i,$diff_array_rls[$asVal])]);
                                                                    $diff_array_rls[$asVal] = array_values($diff_array_rls[$asVal]);
                                                                    asort($diff_array_rls[$asVal]);
                                                                    $rls_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $rls_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if($rls_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rls_flg=0;
                                        if ($req>0 && $rls_flg==0) {
                                            asort($diff_array_rls[$fac_id]);
                                            $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                            if (array_key_exists(0, $diff_array_rls[$fac_id])){
                                                $firlst = $diff_array_rls[$fac_id][0];
                                                if (array_key_exists($firlst - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"]) && $rls_flg == 0) {
                                                            for ($x = $this->data["rls_max_duty"] + 2; $x >= $this->data["rls_max_duty"]; $x--) {
                                                                if ($rls_flg == 0 && count($diff_array_rls[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Firlst) Unset-->".$asKey."(".count($diff_array_rls[$asVal]).") Set--->".$rls_id_name_pair[$fac_id]."(".count($diff_array_rls[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"][$rls_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rls[$fac_id][] = $firlst - $i;
                                                                    $rls_shortage[$fac_id]++;
                                                                    asort($diff_array_rls[$fac_id]);
                                                                    $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                                                    unset($diff_array_rls[$asVal][array_search($firlst - $i,$diff_array_rls[$asVal])]);
                                                                    asort($diff_array_rls[$asVal]);
                                                                    $diff_array_rls[$asVal] = array_values($diff_array_rls[$asVal]);
                                                                    $rls_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $rls_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if($rls_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rls_flg=0;
                                        if ($req>0 && $rls_flg==0) {
                                            asort($diff_array_rls[$fac_id]);
                                            if (array_key_exists(count($diff_array_rls[$fac_id]) - 1, $diff_array_rls[$fac_id])){
                                                $last = $diff_array_rls[$fac_id][count($diff_array_rls[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"]) && $rls_flg == 0) {
                                                            for ($x = $this->data["rls_max_duty"] + 2; $x >= $this->data["rls_max_duty"]; $x--) {
                                                                if ($rls_flg == 0 && count($diff_array_rls[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Last) Unset-->".$asKey."(".count($diff_array_rls[$asVal]).") Set--->".$rls_id_name_pair[$fac_id]."(".count($diff_array_rls[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"][$rls_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rls[$fac_id][] = $last + $i;
                                                                    $rls_shortage[$fac_id]++;
                                                                    asort($diff_array_rls[$fac_id]);
                                                                    $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                                                    unset($diff_array_rls[$asVal][array_search($last + $i,$diff_array_rls[$asVal])]);
                                                                    $diff_array_rls[$asVal] = array_values($diff_array_rls[$asVal]);
                                                                    asort($diff_array_rls[$asVal]);
                                                                    $rls_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $rls_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }


                            }
                        }
                    }
                }


                $max_arr=array();
                $diff_array_rls = array();
                $counter = 1;
                $gap_str_rls = "";
                $duty_arr_rls = array();
                foreach ($RLS as $rlskey => $rlsval) {

                    if (!array_key_exists($rlsval->id, $diff_array_rls))
                        $diff_array_rls[$rlsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][0]["m3"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][0]["m4"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][1]["a3"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][1]["a4"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_rls[$rlsval->id]);
                    $diff_array_rls[$rlsval->id] = array_values($diff_array_rls[$rlsval->id]);
                    for ($i = 0; $i < count($diff_array_rls[$rlsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_rls[$rlsval->id][$i] - $diff_array_rls[$rlsval->id][$i + 1]);
                        if ($max < $dif){
                            $max = $dif;
                        }
                    }

                    $max_arr[$rlsval->id] = $max;


                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_rls .= "<tr><td>{$counter}</td><td>{$rlsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }




                }


                $sh_cnt = 0;
                $duty_arr_rls = array();
                foreach($RLS as $rlsval){
                    $rls_id_name_pair[$rlsval->id] = $rlsval->name;
                    asort($diff_array_rls[$rlsval->id]);
                    $diff_array_rls[$rlsval->id] = array_values($diff_array_rls[$rlsval->id]);
                    if (!array_key_exists(count($diff_array_rls[$rlsval->id]), $duty_arr_rls)) {
                        $duty_arr_rls[count($diff_array_rls[$rlsval->id])] = array();
                    }

                    $duty_arr_rls[count($diff_array_rls[$rlsval->id])][] = $rlsval->id;
                    $sh_cnt+=$rls_shortage[$rlsval->id];
                }

                $duty_ctr_str_rls = "";
                $rls_sum_duty=0;
                foreach ($duty_arr_rls as $key => $val) {
                    $ct = count($val);
                    $duty_ctr_str_rls .= "<tr><td>{$ct}</td><td>{$key}</td></tr>";
                    $rls_sum_duty+=$ct*$key;
                }
                $duty_ctr_str_rls .= "<tr><td>Total</td><td>{$rls_sum_duty}</td></tr>";
                if($rls_sum_duty != $this->data["rls_count"]){
                    $duty_ctr_str_rls .= "<tr  style='background:red;' class='blink' ><td>Difference</td><td>{($this->data['rls_count']-$rls_sum_duty)}</td></tr>";
                }

                if ($counter + count($duty_arr_rls) <= $sum_min) {
                    $sum_min = $counter + count($duty_arr_rls);
                    //$final_arr = array($master, $gap_str_rls, $duty_ctr_str_rls, count($duty_arr_rls), $counter, $sum_min,$c_arr[0],$c_arr[1],$c_arr[2]);
                    $to_test .= $rls_one . " " . $rls_two . " " . $rls_three . " " . $rls_four . " -> " . $sum_min . "<br>";
                }

                foreach ($a4_rls_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][1][1]["a3"] as $k => $v) {
                        if ($ctr != $this->data["a4_rls_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][1][1]["a4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][1][1]["a3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach ($m4_rls_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][1][0]["m3"] as $k => $v) {
                        if ($ctr != $this->data["m4_rls_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][1][0]["m4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][1][0]["m3"][$k]);
                            $ctr++;
                        }
                    }
                }


            }

//-------------------------------------------------------DS--------------------------------------------------------------
            if ($req_flag == "ds" || $gen_flag) {
                $ds_allowed = array();
                $ds_shortage = array();
                $ds_last = array();

                $allocation = 0;
                $ds_total_duty = 0;
                $ds_index = 0;

                $ds_pri_fac = array();
                $ds_ex_fac = array();
                foreach ($DS as $ds_rand) {
                    if(!array_key_exists($ds_rand->id,$ex_dates)){
                        $ex_dates[$ds_rand->id] = array();
                    } else {
                        $ds_ex_fac[$ds_rand->id] = $ds_rand->id;
                    }
                    $ds_allowed[$ds_rand->id] = 0;


                    if ($ds_rand->priority && $ds_priority_duty >= 1 && $ds_priority_duty < $this->data["ds_max_duty"]) {
                        $ds_max_duty = $ds_priority_duty;
                        $ds_pri_fac[$ds_rand->id] = $ds_priority_duty;
                    } else
                        $ds_max_duty = $this->data["ds_max_duty"];
                    $duty_counter = 0;
                    $mr_counter = 0;
                    $aft_counter = 0;
                    $ds_index++;
                    $aft_share = round($ds_max_duty * 25 / 100);
                    $mr_share = $ds_max_duty - $aft_share;
                    foreach ($td as $tdKey => $time_data) {

                        $m3_flag = true;
                        $a3_flag = true;
//							if($duty_counter != $ds_max_duty && $mr_share!=0){
//								if($m3_ds_count[$mr_counter] != 0 && $duty_counter != $ds_max_duty){
//									$master[$this->getDateTag($time_data->date)][2][0]["m3"][$ds_rand->name] = $ds_rand->id;
//									$duty_counter++;
//									$m3_ds_count[$mr_counter]--;
//									$m3_flag=false;
//									$ds_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($ds_rand->id,$ds_last))
//										$ds_last[$ds_rand->id] = $tdKey;
//
//								}
//							}
//
//							if($duty_counter != $ds_max_duty && $aft_share!=0){
//
//
//									if($a3_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty){
//										$master[$this->getDateTag($time_data->date)][2][1]["a3"][$ds_rand->name] = $ds_rand->id;
//										$duty_counter++;
//										$a3_ds_count[$aft_counter]--;
//										$a3_flag=false;
//										$ds_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($ds_rand->id,$ds_last))
//											$ds_last[$ds_rand->id] = $tdKey;
//
//									}
//
//							}

                        if ($duty_counter != $ds_max_duty && $m3_flag && !in_array($time_data->db_date,$ex_dates[$ds_rand->id])) {
                            if ($m3_ds_count[$mr_counter] != 0 && $duty_counter != $ds_max_duty) {
                                $master[$this->getDateTag($time_data->date)][2][0]["m3"][$ds_rand->name] = $ds_rand->id;
                                $duty_counter++;
                                $m3_ds_count[$mr_counter]--;
                                $ds_total_duty++;
                                $allocation++;
                                $mr_share--;
                                if (!array_key_exists($ds_rand->id, $ds_last))
                                    $ds_last[$ds_rand->id] = $tdKey;

                            }
                        }

                        if ($duty_counter != $ds_max_duty && $a3_flag && !in_array($time_data->db_date,$ex_dates[$ds_rand->id])) {
                            if ($a3_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty) {
                                $master[$this->getDateTag($time_data->date)][2][1]["a3"][$ds_rand->name] = $ds_rand->id;
                                $duty_counter++;
                                $a3_ds_count[$aft_counter]--;
                                $ds_total_duty++;
                                $allocation++;
                                $aft_share--;
                                if (!array_key_exists($ds_rand->id, $ds_last))
                                    $ds_last[$ds_rand->id] = $tdKey;

                            }

                        }

                        $mr_counter++;
                        $aft_counter++;
                    }

                    $ds_shortage[$ds_rand->id] = $duty_counter;
                    if (!array_key_exists($ds_rand->id, $ds_last)) {
                        $ds_last[$ds_rand->id] = count($td);
                    }
                    if ($duty_counter <= $this->data["ds_max_duty"] - 1 || in_array($ds_rand, $DS_pri))
                        $ds_allowed[$ds_rand->id] = 0;

                }


                foreach ($a3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][2][0]["m3"], $master[$this->getDateTag($td[$j]->date)][2][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][2][1]["a3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $ds_shortage[$bval] <= $this->data["ds_max_duty"] && !array_key_exists($bval,$ds_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][2][1]["a3"][$bkey] = $bval;
                                            $ds_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $a3_ds_count[$key]--;
                                            $ds_allowed[$bval]++;

                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($m3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][2][0]["m3"], $master[$this->getDateTag($td[$j]->date)][2][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][2][0]["m3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $ds_shortage[$bval] <= $this->data["ds_max_duty"] && !array_key_exists($bval,$ds_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][2][0]["m3"][$bkey] = $bval;
                                            $ds_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $m3_ds_count[$key]--;
                                            $ds_allowed[$bval]++;


                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($a3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][2][1]["a3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($m3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][2][0]["m3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                $to_test = "";
                $final_arr = array($master, $gap_str_ds, $duty_ctr_str_ds);
                $sum_min = PHP_INT_MAX;
                $master_copy = $master;
                $ds_shortage_copy = $ds_shortage;
                $ds_allowed_cpy = $ds_allowed;
                $duty_ctr_str_ds = "";
                $gap_str_ds = "";
                set_time_limit(0);

                foreach ($DS as $allowKey => $alloVal) {
                    if ($ds_shortage[$alloVal->id] != 0) {
                        if ($allowKey % ($ds_four) != 0)
                            $ds_allowed[$alloVal->id] = $ds_allowed[$alloVal->id] + $ds_one;
                        else
                            $ds_allowed[$alloVal->id] = $ds_allowed[$alloVal->id] + $ds_two;
                    } else {
                        $ds_allowed[$alloVal->id] = 0;
                    }
                }


                foreach (array_reverse($DS) as $dskey => $dsp) {
                    if ($ds_shortage[$dsp->id] <= $this->data["ds_max_duty"] - $ds_three && !array_key_exists($dsp->id,$ds_ex_fac)) {
                        $pos = 1;

                        if (array_key_exists($dsp->id, $ds_pri_fac))
                            $req = $ds_pri_fac[$dsp->id] - $ds_shortage[$dsp->id];
                        else {
                            $req = $this->data["ds_max_duty"] - $ds_shortage[$dsp->id];
                            if ($req == $this->data["ds_max_duty"]) {
                                //$req = $this->data["ds_max_duty"] - 1;
                            }
                        }


                        $req_counter = 0;

                        while (array_key_exists($ds_last[$dsp->id] - $pos, $td) && $req_counter != $req) {
                            $got = 0;

                            $date_tag = $td[$ds_last[$dsp->id] - $pos]->date;


                            foreach (array_merge($master[$this->getDateTag($date_tag)][2][0]["m3"], $master[$this->getDateTag($date_tag)][2][1]["a3"]) as $pt => $idVal) {
                                if ($got == 0 && $ds_allowed[$idVal] != 0 && !isset($master[$this->getDateTag($date_tag)][2][0]["m3"][$dsp->name]) && !array_key_exists($idVal,$ds_ex_fac)) {

                                    for ($j = $this->data["ds_max_duty"] + 4; $j > 0; $j--) {
                                        if ($got == 0)
                                            if (array_key_exists($idVal, $ds_shortage) && !array_key_exists($dsp->name, $master[$this->getDateTag($date_tag)][2][0]["m3"])) {
                                                if ($ds_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $ds_allowed) && $ds_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][2][0]["m3"])) {
                                                        $master[$this->getDateTag($date_tag)][2][0]["m3"][$dsp->name] = $dsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][2][0]["m3"][$pt]);
                                                        $ds_shortage[$idVal]--;
                                                        $ds_shortage[$dsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt."---->".$dsp->name."------->".$date_tag."<br>";
                                                        $ds_allowed[$idVal]--;
                                                        $got++;
                                                    }

                                                }
                                            }

                                        if ($got == 0)
                                            if (array_key_exists($idVal, $ds_shortage) && !array_key_exists($dsp->name, $master[$this->getDateTag($date_tag)][2][1]["a3"])) {
                                                if ($ds_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $ds_allowed) && $ds_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][2][1]["a3"])) {
                                                        $master[$this->getDateTag($date_tag)][2][1]["a3"][$dsp->name] = $dsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][2][1]["a3"][$pt]);
                                                        $ds_shortage[$idVal]--;
                                                        $ds_shortage[$dsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt . "---->" . $dsp->name . "------->" . $date_tag . "<br>";
                                                        $ds_allowed[$idVal]--;
                                                        $got++;
                                                    }
                                                }
                                            }
                                    }
                                }
                            }


                            if ($got == 0) {
                                //echo "<h3>Skipped {$date_tag}</h3><br>";
                            }
                            $pos++;
                        }
                    }

                }


                $max_arr=array();
                $diff_array_ds = array();
                $counter = 1;
                $gap_str_ds = "";
                $duty_arr_ds = array();
                foreach ($DS as $dskey => $dsval) {

                    if (!array_key_exists($dsval->id, $diff_array_ds))
                        $diff_array_ds[$dsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][0]["m3"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][0]["m4"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][1]["a3"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][1]["a4"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_ds[$dsval->id]);
                    $diff_array_ds[$dsval->id] = array_values($diff_array_ds[$dsval->id]);
                    for ($i = 0; $i < count($diff_array_ds[$dsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_ds[$dsval->id][$i] - $diff_array_ds[$dsval->id][$i + 1]);
                        if ($max < $dif){
                            $max = $dif;
                        }
                    }

                    if(!array_key_exists($dsval->id,$ds_ex_fac))
                        $max_arr[$dsval->id] = $max;
                    else
                        $max_arr[$dsval->id] = 0;

                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_ds .= "<tr><td>{$counter}</td><td>{$dsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }




                }

                $check_fg="";
                foreach($DS as $dskey => $dsval){
                    $last = 0;
                    $max = $max_arr[$dsval->id];
                    if ($max - 1 >= 3)
                        for ($i = 0; $i < count($diff_array_ds[$dsval->id]) - 1; $i++) {
                            if(array_key_exists($i,$diff_array_ds[$dsval->id]) && array_key_exists($i+1,$diff_array_ds[$dsval->id]))
                                $dif = abs($diff_array_ds[$dsval->id][$i] - $diff_array_ds[$dsval->id][$i + 1]);
                            else
                                $dif=0;

                            if ($max == $dif) {
                                if ($i + 1 < ceil(count($diff_array_ds[$dsval->id]) / 2)) {
                                    $last=$i+1;
                                    for ($j = $i; $j >= 0; $j--) {
                                        if(array_key_exists($j,$diff_array_ds[$dsval->id]))
                                            if (array_key_exists($diff_array_ds[$dsval->id][$j], $td)) {
                                                if (array_key_exists($j, $diff_array_ds[$dsval->id])) {
                                                    if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                        //														$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"]["TO BE ADDED ".$dsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$dsval->name]);
                                                        $ds_shortage[$dsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }


                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"]["TO BE ADDED " . $dsval->name] = -1;
                                                        }
                                                        unset($diff_array_ds[$dsval->id][$j]);
//

                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_ds[$dsval->id])) {
                                                    if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"]["TO BE ADDED ".$dsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$dsval->name]);
                                                        $ds_shortage[$dsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"]["TO BE ADDED " . $dsval->name] = -1;
                                                        }
                                                        unset($diff_array_ds[$dsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_ds[$dsval->id])) {
                                                    if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"]["TO BE ADDED ".$dsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$dsval->name]);
                                                        $ds_shortage[$dsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"]["TO BE ADDED " . $dsval->name] = -1;
                                                        }
                                                        unset($diff_array_ds[$dsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_ds[$dsval->id])) {
                                                    if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"]["TO BE ADDED ".$dsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$dsval->name]);
                                                        $ds_shortage[$dsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"]["TO BE ADDED " . $dsval->name] = -1;
                                                        }
                                                        unset($diff_array_ds[$dsval->id][$j]);
                                                    }
                                                }
                                            }
                                    }
                                } else {
                                    for ($j = $i + 1; $j < count($diff_array_ds[$dsval->id]); $j++) {
                                        if (array_key_exists($diff_array_ds[$dsval->id][$j], $td)) {
                                            if (array_key_exists($j, $diff_array_ds[$dsval->id]))
                                                if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
//														$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"]["TO BE ADDED ".$dsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$dsval->name]);
                                                    $ds_shortage[$dsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }


                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"]["TO BE ADDED " . $dsval->name] = -1;
                                                    }
                                                    unset($diff_array_ds[$dsval->id][$j]);

                                                }
                                            if (array_key_exists($j, $diff_array_ds[$dsval->id]))
                                                if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"]["TO BE ADDED ".$dsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$dsval->name]);
                                                    $ds_shortage[$dsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"]["TO BE ADDED " . $dsval->name] = -1;
                                                    }
                                                    unset($diff_array_ds[$dsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_ds[$dsval->id]))
                                                if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"]["TO BE ADDED ".$dsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$dsval->name]);
                                                    $ds_shortage[$dsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"]["TO BE ADDED " . $dsval->name] = -1;
                                                    }
                                                    unset($diff_array_ds[$dsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_ds[$dsval->id]))
                                                if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"]["TO BE ADDED ".$dsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$dsval->name]);
                                                    $ds_shortage[$dsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal,$ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"]+1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"]["TO BE ADDED " . $dsval->name] = -1;
                                                    }
                                                    unset($diff_array_ds[$dsval->id][$j]);
                                                }
                                        }
                                    }
                                }


                            }

                        }
                }

                $sh_cnt = 0;
                $ds_id_name_pair = array();
                foreach($DS as $dsval){
                    $ds_id_name_pair[$dsval->id] = $dsval->name;
                    asort($diff_array_ds[$dsval->id]);
                    $diff_array_ds[$dsval->id] = array_values($diff_array_ds[$dsval->id]);
                    if (!array_key_exists(count($diff_array_ds[$dsval->id]), $duty_arr_ds)) {
                        $duty_arr_ds[count($diff_array_ds[$dsval->id])] = array();
                    }

                    $duty_arr_ds[count($diff_array_ds[$dsval->id])][] = $dsval->id;
                    $sh_cnt+=$ds_shortage[$dsval->id];
                }

                $ds_fac_duty=array();
                foreach ($duty_arr_ds as $key => $val) {
                    $cnt = count($val);
                    $ds_fac_duty[$key] = $cnt;
                }
                ksort($ds_fac_duty);

                $txt = "";
                $txt_ctr=0;
                foreach($ds_fac_duty as $dty_cnt => $num_fac) {
                    foreach ($duty_arr_ds[$dty_cnt] as $fac_id) {
                        if (count($diff_array_ds[$fac_id]) < $this->data["ds_max_duty"] && !array_key_exists($fac_id,$ds_ex_fac)) {
                            $req = $this->data["ds_max_duty"] - count($diff_array_ds[$fac_id]) -1;
                            $ds_flg=0;
                            for ($b = 0; $b < $req; $b++){
                                $ds_flg=0;
                                if($ds_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$ds_flg=0;
                                        if ($req>0 && $ds_flg==0) {
                                            asort($diff_array_ds[$fac_id]);
                                            $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                            if (array_key_exists(0, $diff_array_ds[$fac_id])){
                                                $fidst = $diff_array_ds[$fac_id][0];
                                                if (array_key_exists($fidst - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"]) && $ds_flg == 0) {
                                                            for ($x = $this->data["ds_max_duty"] + 2; $x >= $this->data["ds_max_duty"]; $x--) {
                                                                if ($ds_flg == 0 && count($diff_array_ds[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Fidst) Unset-->".$asKey."(".count($diff_array_ds[$asVal]).") Set--->".$ds_id_name_pair[$fac_id]."(".count($diff_array_ds[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"][$ds_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_ds[$fac_id][] = $fidst - $i;
                                                                    $ds_shortage[$fac_id]++;
                                                                    asort($diff_array_ds[$fac_id]);
                                                                    $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                                                    unset($diff_array_ds[$asVal][array_search($fidst - $i,$diff_array_ds[$asVal])]);
                                                                    asort($diff_array_ds[$asVal]);
                                                                    $diff_array_ds[$asVal] = array_values($diff_array_ds[$asVal]);
                                                                    $ds_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $ds_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if($ds_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$ds_flg=0;
                                        if ($req>0 && $ds_flg==0) {
                                            asort($diff_array_ds[$fac_id]);
                                            if (array_key_exists(count($diff_array_ds[$fac_id]) - 1, $diff_array_ds[$fac_id])){
                                                $last = $diff_array_ds[$fac_id][count($diff_array_ds[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"]) && $ds_flg == 0) {
                                                            for ($x = $this->data["ds_max_duty"] + 2; $x >= $this->data["ds_max_duty"]; $x--) {
                                                                if ($ds_flg == 0 && count($diff_array_ds[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Last) Unset-->".$asKey."(".count($diff_array_ds[$asVal]).") Set--->".$ds_id_name_pair[$fac_id]."(".count($diff_array_ds[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"][$ds_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_ds[$fac_id][] = $last + $i;
                                                                    $ds_shortage[$fac_id]++;
                                                                    asort($diff_array_ds[$fac_id]);
                                                                    $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                                                    unset($diff_array_ds[$asVal][array_search($last + $i,$diff_array_ds[$asVal])]);
                                                                    $diff_array_ds[$asVal] = array_values($diff_array_ds[$asVal]);
                                                                    asort($diff_array_ds[$asVal]);
                                                                    $ds_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $ds_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if($ds_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$ds_flg=0;
                                        if ($req>0 && $ds_flg==0) {
                                            asort($diff_array_ds[$fac_id]);
                                            $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                            if (array_key_exists(0, $diff_array_ds[$fac_id])){
                                                $fidst = $diff_array_ds[$fac_id][0];
                                                if (array_key_exists($fidst - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"]) && $ds_flg == 0) {
                                                            for ($x = $this->data["ds_max_duty"] + 2; $x >= $this->data["ds_max_duty"]; $x--) {
                                                                if ($ds_flg == 0 && count($diff_array_ds[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Fidst) Unset-->".$asKey."(".count($diff_array_ds[$asVal]).") Set--->".$ds_id_name_pair[$fac_id]."(".count($diff_array_ds[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"][$ds_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_ds[$fac_id][] = $fidst - $i;
                                                                    $ds_shortage[$fac_id]++;
                                                                    asort($diff_array_ds[$fac_id]);
                                                                    $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                                                    unset($diff_array_ds[$asVal][array_search($fidst - $i,$diff_array_ds[$asVal])]);
                                                                    asort($diff_array_ds[$asVal]);
                                                                    $diff_array_ds[$asVal] = array_values($diff_array_ds[$asVal]);
                                                                    $ds_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $ds_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if($ds_flg==0 && $req>0){
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$ds_flg=0;
                                        if ($req>0 && $ds_flg==0) {
                                            asort($diff_array_ds[$fac_id]);
                                            if (array_key_exists(count($diff_array_ds[$fac_id]) - 1, $diff_array_ds[$fac_id])){
                                                $last = $diff_array_ds[$fac_id][count($diff_array_ds[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"]) && $ds_flg == 0) {
                                                            for ($x = $this->data["ds_max_duty"] + 2; $x >= $this->data["ds_max_duty"]; $x--) {
                                                                if ($ds_flg == 0 && count($diff_array_ds[$asVal]) == $x && $req>0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt.=$txt_ctr.")(Last) Unset-->".$asKey."(".count($diff_array_ds[$asVal]).") Set--->".$ds_id_name_pair[$fac_id]."(".count($diff_array_ds[$fac_id]).")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"][$ds_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_ds[$fac_id][] = $last + $i;
                                                                    $ds_shortage[$fac_id]++;
                                                                    asort($diff_array_ds[$fac_id]);
                                                                    $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                                                    unset($diff_array_ds[$asVal][array_search($last + $i,$diff_array_ds[$asVal])]);
                                                                    $diff_array_ds[$asVal] = array_values($diff_array_ds[$asVal]);
                                                                    asort($diff_array_ds[$asVal]);
                                                                    $ds_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $ds_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }


                            }
                        }
                    }
                }


                $max_arr=array();
                $diff_array_ds = array();
                $counter = 1;
                $gap_str_ds = "";
                $duty_arr_ds = array();
                foreach ($DS as $dskey => $dsval) {

                    if (!array_key_exists($dsval->id, $diff_array_ds))
                        $diff_array_ds[$dsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][0]["m3"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][0]["m4"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][1]["a3"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][1]["a4"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_ds[$dsval->id]);
                    $diff_array_ds[$dsval->id] = array_values($diff_array_ds[$dsval->id]);
                    for ($i = 0; $i < count($diff_array_ds[$dsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_ds[$dsval->id][$i] - $diff_array_ds[$dsval->id][$i + 1]);
                        if ($max < $dif){
                            $max = $dif;
                        }
                    }

                    $max_arr[$dsval->id] = $max;


                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_ds .= "<tr><td>{$counter}</td><td>{$dsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }




                }


                $sh_cnt = 0;
                $duty_arr_ds = array();
                foreach($DS as $dsval){
                    $ds_id_name_pair[$dsval->id] = $dsval->name;
                    asort($diff_array_ds[$dsval->id]);
                    $diff_array_ds[$dsval->id] = array_values($diff_array_ds[$dsval->id]);
                    if (!array_key_exists(count($diff_array_ds[$dsval->id]), $duty_arr_ds)) {
                        $duty_arr_ds[count($diff_array_ds[$dsval->id])] = array();
                    }

                    $duty_arr_ds[count($diff_array_ds[$dsval->id])][] = $dsval->id;
                    $sh_cnt+=$ds_shortage[$dsval->id];
                }

                $duty_ctr_str_ds = "";
                $ds_sum_duty=0;
                foreach ($duty_arr_ds as $key => $val) {
                    $ct = count($val);
                    $duty_ctr_str_ds .= "<tr><td>{$ct}</td><td>{$key}</td></tr>";
                    $ds_sum_duty+=$ct*$key;
                }
                $duty_ctr_str_ds .= "<tr><td>Total</td><td>{$ds_sum_duty}</td></tr>";
                if($ds_sum_duty != $this->data["ds_count"]){
                    $duty_ctr_str_ds .= "<tr  style='background:red;' class='blink' ><td>Difference</td><td>{($this->data['ds_count']-$ds_sum_duty)}</td></tr>";
                }

                if ($counter + count($duty_arr_ds) <= $sum_min) {
                    $sum_min = $counter + count($duty_arr_ds);
                    //$final_arr = array($master, $gap_str_ds, $duty_ctr_str_ds, count($duty_arr_ds), $counter, $sum_min,$c_arr[0],$c_arr[1],$c_arr[2]);
                    $to_test .= $ds_one . " " . $ds_two . " " . $ds_three . " " . $ds_four . " -> " . $sum_min . "<br>";
                }

                foreach ($a4_ds_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][2][1]["a3"] as $k => $v) {
                        if ($ctr != $this->data["a4_ds_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][2][1]["a4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][2][1]["a3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach ($m4_ds_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][2][0]["m3"] as $k => $v) {
                        if ($ctr != $this->data["m4_ds_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][2][0]["m4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][2][0]["m3"][$k]);
                            $ctr++;
                        }
                    }
                }


            }
            $this->data["populate"] = $master;

            $this->data["m3_str"] = $m3_str;
            $this->data["m4_str"] = $m4_str;
            $this->data["a3_str"] = $a3_str;
            $this->data["a4_str"] = $a4_str;
            
            if ($gen_flag) {
                $str = $this->load->view("assign_duty_ajax", $this->data, true);
            }
            //echo "<pre>".print_r($master,true)."</pre>";
            echo json_encode(array($gap_str_rs, $duty_ctr_str_rs, $gap_str_rls, $duty_ctr_str_rls, $gap_str_ds, $duty_ctr_str_ds, $str));
        }

    }

    function combinations($arr, $n)
    {
        $res = array();

        foreach ($arr[$n] as $item) {
            if ($n == count($arr) - 1)
                $res[] = $item;
            else {
                $combs = $this->combinations($arr, $n + 1);

                foreach ($combs as $comb) {
                    $res[] = "$item $comb";
                }
            }
        }
        return $res;
    }

    function tst()
    {
        $words = array(array('0', '1', '2'), array('0', '1', '2'), array('1', '2', '3'));
        $combos = $this->combinations($words, 0);
        print_r(explode(" ", $combos[0]));
    }



    function tick()
    {
        if ($this->session->userdata('BMSAdmin')) {
            $det = $this->home_db->getdetails($this->session->userdata('BMSAdmin'));
            if ($det[0]->login_type != "US") {
                $exam_id = $this->input->post("exam");
                $flag_check = $this->master_db->getRecords("exam_id", array("exam_id" => $exam_id, "informed" => 1));
                if (is_array($flag_check) && count($flag_check) >= 1) {
                    $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Do Not Act Smart..:-) Invalid Operation..!!</div>');
                    redirect("master/timetable");
                } else {
                    $exam = $exam_id;
                    $dept = $this->input->post("dept");
                    $desig = $this->input->post("desig");
                    $d_desig = $this->input->post("d_desig");
                    $ex_date = $this->input->post("ex_date");
                    $session = $this->input->post("session");
                    $master = array();

                    $sql = "SELECT a.exam_id, a.date, e.m3start_time, e.m4start_time, e.a3start_time, e.a4start_time,a.m3, a.m4, a.a3, a.a4, a.m3_designation, a.m4_designation, a.a3_designation, a.a4_designation, b.name AS name,b.id AS prof_id, b.phone, c.name AS desig_name, d.name AS dept_name
                                FROM assigned_duties_{$exam} a, prof_{$exam} b, designation c, dept d, time_table_{$exam} e
                                WHERE a.prof_id = b.id
                                AND b.designation = c.id
                                AND b.dept = d.id
                                AND a.exam_id = e.exam_id
                                AND a.date = e.date
                                AND a.exam_id = '{$exam}'
                                AND a.date = '{$ex_date}'";
                    $where = "";

                    $where .= " ORDER BY b.dept ";
                    $main_data = $this->master_db->execSQL($sql . $where);
                    $tick_data = $this->master_db->getRecords("receipt_{$exam}",array("date"=>$this->getDateTag($ex_date)));
                    $pre_tick = array();
                    $pre_tick["m3"] = array();
                    $pre_tick["m4"] = array();
                    $pre_tick["a3"] = array();
                    $pre_tick["a4"] = array();

                    if(is_array($tick_data) && count($tick_data)>=1){
                        foreach($tick_data as $val){
                            $pre_tick[$val->session][] = $val->date."-".$val->session."-".$val->duty_desig."-".$val->prof_id."-".$val->name;
                        }
                    }



                    foreach ($main_data as $main) {

                        if ($main->m3 == 1 && $main->m3_designation == "RS") {
                            $master[$this->getDateTag($ex_date)][0][0]["m3"][$main->name] = $main->prof_id;
                        }
                        if ($main->m4 == 1 && $main->m4_designation == "RS") {
                            $master[$this->getDateTag($ex_date)][0][0]["m4"][$main->name] = $main->prof_id;
                        }

                        if ($main->a3 == 1 && $main->a3_designation == "RS") {
                            $master[$this->getDateTag($ex_date)][0][1]["a3"][$main->name] = $main->prof_id;
                        }

                        if ($main->a4 == 1 && $main->a4_designation == "RS") {
                            $master[$this->getDateTag($ex_date)][0][1]["a4"][$main->name] = $main->prof_id;
                        }

                        if ($main->m3 == 1 && $main->m3_designation == "RLS") {
                            $master[$this->getDateTag($ex_date)][1][0]["m3"][$main->name] = $main->prof_id;
                        }
                        if ($main->m4 == 1 && $main->m4_designation == "RLS") {
                            $master[$this->getDateTag($ex_date)][1][0]["m4"][$main->name] = $main->prof_id;
                        }

                        if ($main->a3 == 1 && $main->a3_designation == "RLS") {
                            $master[$this->getDateTag($ex_date)][1][1]["a3"][$main->name] = $main->prof_id;
                        }

                        if ($main->a4 == 1 && $main->a4_designation == "RLS") {
                            $master[$this->getDateTag($ex_date)][1][1]["a4"][$main->name] = $main->prof_id;
                        }


                        if ($main->m3 == 1 && $main->m3_designation == "DS") {
                            $master[$this->getDateTag($ex_date)][2][0]["m3"][$main->name] = $main->prof_id;
                        }
                        if ($main->m4 == 1 && $main->m4_designation == "DS") {
                            $master[$this->getDateTag($ex_date)][2][0]["m4"][$main->name] = $main->prof_id;
                        }

                        if ($main->a3 == 1 && $main->a3_designation == "DS") {
                            $master[$this->getDateTag($ex_date)][2][1]["a3"][$main->name] = $main->prof_id;
                        }

                        if ($main->a4 == 1 && $main->a4_designation == "DS") {
                            $master[$this->getDateTag($ex_date)][2][1]["a4"][$main->name] = $main->prof_id;
                        }
                    }



                    $this->data["pre_tick"] = $pre_tick;
                    $this->data["populate"] = $master;
                    $this->data["exam_id"] = $exam_id;
                    $this->data["table_data"] = $this->master_db->execSQL("select * from time_table_{$exam_id} where date='{$ex_date}'");
                    $this->load->view("tick_assign_duty", $this->data);
                    
                }
            } else {
                $this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>You Are Not Admin</div>');
                redirect("master/timetable");
            }
        }
    }

    function tick_save(){
        $tick_arr = $this->input->post("ticked_fac");
        $tick_ex_id = $this->input->post("tick_ex_id");
        $tick_ex_date = $this->input->post("tick_ex_date");
        $this->master_db->runSQL("delete FROM `receipt_{$tick_ex_id}` WHERE date = '{$tick_ex_date}'");

        if(is_array($tick_arr) && count($tick_arr)>=1){
            foreach($tick_arr as $val){
                $arr = explode("-",$val);
                $this->master_db->insertRecord("receipt_{$tick_ex_id}", array("date" => $arr[0],"session"=>$arr[1],"duty_desig"=>$arr[2],"prof_id"=>$arr[3],"name"=>$arr[4]));
            }
        }
        $this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissable"><button class="close" aria-hidden="true" data-dismiss="alert" type="button">&times;</button>Successful..!!!</div>');
        redirect("master/timetable");
    }

    function print_receipt(){
        $this->data["ex_id"] = $ex_id = $this->input->get("exam_id");
        $this->data["settings"] = $this->master_db->getRecords("settings", array()," rs_remuneration , rls_remuneration, ds_remuneration ");
        $fac_duty = $this->master_db->execSQL("SELECT r.*,p.name as p_name, p.acc_num, d.name as dept_name FROM receipt_{$ex_id} r, prof_{$ex_id} p,dept d WHERE r.prof_id=p.id and p.dept = d.id order by d.name");
        if(is_array($fac_duty) && count($fac_duty)>=1){
            $this->data["fac_duty"] = $fac_duty;
        } else {
            $this->data["fac_duty"] = array();
        }
        $this->load->view("print_duty_receipt",$this->data);
    }



    public function ana()
    {

        {
            $gen_flag = false;
            $gap_str_rs = $duty_ctr_str_rs = $gap_str_rls = $duty_ctr_str_rls = $gap_str_ds = $duty_ctr_str_ds = $str = "";
            $req_flag = $this->input->post("req_flag");
            $rs_one = $this->input->post("rs_one");
            $rs_two = $this->input->post("rs_two");
            $rs_three = $this->input->post("rs_three");
            $rs_four = $this->input->post("rs_four");

            $rls_one = $this->input->post("rls_one");
            $rls_two = $this->input->post("rls_two");
            $rls_three = $this->input->post("rls_three");
            $rls_four = $this->input->post("rls_four");

            $ds_one = $this->input->post("ds_one");
            $ds_two = $this->input->post("ds_two");
            $ds_three = $this->input->post("ds_three");
            $ds_four = $this->input->post("ds_four");

            if (!$this->session->userdata('opmiz_ajax')) {
                $this->data['table_data'] = $td = $this->master_db->getRecords("time_table_{$exam_id}", array("exam_id" => $this->input->post("id")), '*', 'id asc');
                $RS = $this->master_db->getRecords("prof_{$exam_id}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
                $RLS = $this->master_db->getRecords("prof_{$exam_id}", array("designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
                $DS = $this->master_db->getRecords("prof_{$exam_id}", array("designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');
                $settings = $this->master_db->getRecords("settings", array());
                if (is_array($RS) && count($RS) >= 1)
                    shuffle($RS);
                else
                    $RS = array();
                if (is_array($RLS) && count($RLS) >= 1)
                    shuffle($RLS);
                else
                    $RLS = array();
                if (is_array($DS) && count($DS) >= 1)
                    shuffle($DS);
                else
                    $DS = array();

                $RS_pri = $this->master_db->getRecords("prof_{$exam_id}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 1));
                $RLS_pri = $this->master_db->getRecords("prof_{$exam_id}", array("designation" => 2, "status" => 1, "priority" => 1));
                $DS_pri = $this->master_db->getRecords("prof_{$exam_id}", array("designation" => 3, "status" => 1, "priority" => 1));

                if (is_array($RS_pri) && count($RS_pri) >= 1)
                    shuffle($RS_pri);
                else
                    $RS_pri = array();
                if (is_array($RLS_pri) && count($RLS_pri) >= 1)
                    shuffle($RLS_pri);
                else
                    $RLS_pri = array();
                if (is_array($DS_pri) && count($DS_pri) >= 1)
                    shuffle($DS_pri);
                else
                    $DS_pri = array();

                //if(is_array($RS_pri) && count($RS_pri))
                $RS = array_merge($RS, $RS_pri);
                //if(is_array($RLS_pri) && count($RLS_pri))
                $RLS = array_merge($RLS_pri, $RLS);
                //if(is_array($DS_pri) && count($DS_pri))
                $DS = array_merge($DS_pri, $DS);

                $this->data['RS'] = $RS;
                $this->data['RLS'] = $RLS;
                $this->data['DS'] = $DS;
                $this->session->set_userdata("opmiz_ajax", "1");
                $this->session->set_userdata("td", $td);
                $this->session->set_userdata("RS", $RS);
                $this->session->set_userdata("RLS", $RLS);
                $this->session->set_userdata("DS", $DS);
                $this->session->set_userdata("RS_pri", $RS_pri);
                $this->session->set_userdata("RLS_pri", $RLS_pri);
                $this->session->set_userdata("DS_pri", $DS_pri);
                $this->session->set_userdata("settings", $settings);
            } else {
                $this->data['table_data'] = $td = $this->session->userdata('td');
                $RS = $this->data['RS'] = $this->session->userdata('RS');
                $RLS = $this->data['RLS'] = $this->session->userdata('RLS');
                $DS = $this->data['DS'] = $this->session->userdata('DS');
                $RS_pri = $this->session->userdata('RS_pri');
                $RLS_pri = $this->session->userdata('RLS_pri');
                $DS_pri = $this->session->userdata('DS_pri');
                $settings = $this->session->userdata('settings');
            }

            $m3_str = array();
            $m4_str = array();
            $a3_str = array();
            $a4_str = array();


            $m3_rs_count = array();
            $m3_rls_count = array();
            $m3_ds_count = array();

            $m4_rs_count = array();
            $m4_rls_count = array();
            $m4_ds_count = array();

            $a3_rs_count = array();
            $a3_rls_count = array();
            $a3_ds_count = array();

            $a4_rs_count = array();
            $a4_rls_count = array();
            $a4_ds_count = array();

            $rs_max_duty = 0;
            $rls_max_duty = 0;
            $ds_max_duty = 0;

            $counter = 0;
            $master = array();
            $this->initalize_master($master, $td);

            foreach ($td as $key => $row) {
                $m3 = 0;
                $m4 = 0;
                $a3 = 0;
                $a4 = 0;
                $m3_str[] = $row->m3strength;
                $m4_str[] = $row->m4strength;
                $a3_str[] = $row->a3strength;
                $a4_str[] = $row->a4strength;
                if ($row->m3strength != -1) {
                    $m3 += $row->m3strength;
                }

                if ($row->m4strength != -1) {
                    $m4 += $row->m4strength;
                }

                if ($row->a3strength != -1) {
                    $a3 += $row->a3strength;
                }

                if ($row->a4strength != -1) {
                    $a4 += $row->a4strength;
                }

                if ($m3 < 30) {
                    $m3_rs_count[] = ceil($m3 / 30);

                } else {
                    $m3_rs_count[] = round($m3 / 30);

                }
                if ($a3 < 30) {
                    $a3_rs_count[] = ceil($a3 / 30);

                } else {
                    $a3_rs_count[] = round($a3 / 30);

                }
                if ($m4 < 30) {
                    $m4_rs_count[] = ceil($m4 / 30);

                } else {
                    $m4_rs_count[] = round($m4 / 30);

                }
                if ($a4 < 30) {
                    $a4_rs_count[] = ceil($a4 / 30);

                } else {
                    $a4_rs_count[] = round($a4 / 30);

                }

                if ($m3 >= 76) {
                    if ($m3_rs_count[$counter] < 5)
                        $m3_rls_count[] = ceil(($m3_rs_count[$counter]) / 5);
                    else
                        $m3_rls_count[] = round(($m3_rs_count[$counter]) / 5);
                } else {
                    $m3_rls_count[] = 0;
                }

                if ($a3 >= 76) {
                    if ($a3_rs_count[$counter] < 5)
                        $a3_rls_count[] = ceil(($a3_rs_count[$counter]) / 5);
                    else
                        $a3_rls_count[] = round(($a3_rs_count[$counter]) / 5);
                } else {
                    $a3_rls_count[] = 0;
                }

                if ($m4 >= 76) {
                    if ($m4_rs_count[$counter] < 5)
                        $m4_rls_count[] = ceil(($m4_rs_count[$counter]) / 5);
                    else
                        $m4_rls_count[] = round(($m4_rs_count[$counter]) / 5);
                } else {
                    $m4_rls_count[] = 0;
                }

                if ($a4 >= 76) {
                    if ($a4_rs_count[$counter] < 5)
                        $a4_rls_count[] = ceil(($a4_rs_count[$counter]) / 5);
                    else
                        $a4_rls_count[] = round(($a4_rs_count[$counter]) / 5);
                } else {
                    $a4_rls_count[] = 0;
                }


                if ($m3 < 250) {

                    $m3_ds_count[] = ceil(($m3) / 250);
                } else {

                    $m3_ds_count[] = round(($m3) / 250);
                }
                if ($a3 < 250) {

                    $a3_ds_count[] = ceil(($a3) / 250);
                } else {

                    $a3_ds_count[] = round(($a3) / 250);
                }
                if ($m4 < 250) {

                    $m4_ds_count[] = ceil(($m4) / 250);
                } else {

                    $m4_ds_count[] = round(($m4) / 250);
                }
                if ($a4 < 250) {

                    $a4_ds_count[] = ceil(($a4) / 250);
                } else {

                    $a4_ds_count[] = round(($a4) / 250);
                }

                $rs_max_duty += $m3_rs_count[$counter] + $a3_rs_count[$counter] + $m4_rs_count[$counter] + $a4_rs_count[$counter];
                $rls_max_duty += $m3_rls_count[$counter] + $a3_rls_count[$counter] + $m4_rls_count[$counter] + $a4_rls_count[$counter];
                $ds_max_duty += $m3_ds_count[$counter] + $a3_ds_count[$counter] + $m4_ds_count[$counter] + $a4_ds_count[$counter];

                $counter++;

            }

            $this->data["m3_rs_count"] = $m3_rs_count;
            $this->data["a3_rs_count"] = $a3_rs_count;

            $this->data["m4_rs_count"] = $m4_rs_count;
            $this->data["a4_rs_count"] = $a4_rs_count;


            $this->data["m3_rls_count"] = $m3_rls_count;
            $this->data["a3_rls_count"] = $a3_rls_count;

            $this->data["m4_rls_count"] = $m4_rls_count;
            $this->data["a4_rls_count"] = $a4_rls_count;

            $this->data["m3_ds_count"] = $m3_ds_count;
            $this->data["a3_ds_count"] = $a3_ds_count;

            $this->data["m4_ds_count"] = $m4_ds_count;
            $this->data["a4_ds_count"] = $a4_ds_count;

            foreach ($td as $key => $val) {
                $m3_rs_count[$key] += $m4_rs_count[$key];
                $a3_rs_count[$key] += $a4_rs_count[$key];

                $m3_rls_count[$key] += $m4_rls_count[$key];
                $a3_rls_count[$key] += $a4_rls_count[$key];

                $m3_ds_count[$key] += $m4_ds_count[$key];
                $a3_ds_count[$key] += $a4_ds_count[$key];
            }


            $this->data["rs_count"] = $rs_max_duty;
            $this->data["rls_count"] = $rls_max_duty;
            $this->data["ds_count"] = $ds_max_duty;


            $rs_priority_duty = $settings[0]->rs_priority_duty;
            $rls_priority_duty = $settings[0]->rls_priority_duty;
            $ds_priority_duty = $settings[0]->ds_priority_duty;


            $rs_max_duty_temp = ceil($rs_max_duty / count($RS));
            $rls_max_duty_temp = ceil($rls_max_duty / count($RLS));
            $ds_max_duty_temp = ceil($ds_max_duty / count($DS));

            if ($rs_priority_duty < $rs_max_duty_temp && is_array($RS_pri) && count($RS_pri) >= 1 && $rs_priority_duty >= 1) {
                $this->data["rs_max_duty"] = $rs_max_duty = ceil(($rs_max_duty + (($rs_max_duty_temp - $rs_priority_duty) * count($RS_pri))) / count($RS));
            } else {
                $this->data["rs_max_duty"] = $rs_max_duty = ceil($rs_max_duty / count($RS));
            }

            if ($rls_priority_duty < $rls_max_duty_temp && is_array($RLS_pri) && count($RLS_pri) >= 1 && $rls_priority_duty >= 1) {
                $this->data["rls_max_duty"] = $rls_max_duty = ceil(($rls_max_duty + (($rls_max_duty_temp - $rls_priority_duty) * count($RLS_pri))) / count($RLS));
            } else {
                $this->data["rls_max_duty"] = $rls_max_duty = ceil($rls_max_duty / count($RLS));
            }


            if ($ds_priority_duty < $ds_max_duty_temp && is_array($DS_pri) && count($DS_pri) >= 1 && $ds_priority_duty >= 1) {
                $this->data["ds_max_duty"] = $ds_max_duty = ceil(($ds_max_duty + (($ds_max_duty_temp - $ds_priority_duty) * count($DS_pri))) / count($DS));
            } else {
                $this->data["ds_max_duty"] = $ds_max_duty = ceil($ds_max_duty / count($DS));
            }


//---------------------------------------------------RS------------------------------------------------------------
            if ($req_flag == "rs" || $gen_flag) {
                $rs_allowed = array();
                $rs_shortage = array();
                $rs_last = array();

                $allocation = 0;
                $rs_total_duty = 0;
                $rs_index = 0;

                $rs_pri_fac = array();
                foreach ($RS as $rs_rand) {
                    $rs_allowed[$rs_rand->id] = 0;


                    if ($rs_rand->priority && $rs_priority_duty >= 1 && $rs_priority_duty < $this->data["rs_max_duty"]) {
                        $rs_max_duty = $rs_priority_duty;
                        $rs_pri_fac[$rs_rand->id] = $rs_priority_duty;
                    } else
                        $rs_max_duty = $this->data["rs_max_duty"];
                    $duty_counter = 0;
                    $mr_counter = 0;
                    $aft_counter = 0;
                    $rs_index++;
                    $aft_share = round($rs_max_duty * 25 / 100);
                    $mr_share = $rs_max_duty - $aft_share;
                    foreach ($td as $tdKey => $time_data) {

                        $m3_flag = true;
                        $a3_flag = true;
//							if($duty_counter != $rs_max_duty && $mr_share!=0){
//								if($m3_rs_count[$mr_counter] != 0 && $duty_counter != $rs_max_duty){
//									$master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
//									$duty_counter++;
//									$m3_rs_count[$mr_counter]--;
//									$m3_flag=false;
//									$rs_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($rs_rand->id,$rs_last))
//										$rs_last[$rs_rand->id] = $tdKey;
//
//								}
//							}
//
//							if($duty_counter != $rs_max_duty && $aft_share!=0){
//
//
//									if($a3_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty){
//										$master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
//										$duty_counter++;
//										$a3_rs_count[$aft_counter]--;
//										$a3_flag=false;
//										$rs_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($rs_rand->id,$rs_last))
//											$rs_last[$rs_rand->id] = $tdKey;
//
//									}
//
//							}

                        if ($duty_counter != $rs_max_duty && $m3_flag) {
                            if ($m3_rs_count[$mr_counter] != 0 && $duty_counter != $rs_max_duty) {
                                $master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
                                $duty_counter++;
                                $m3_rs_count[$mr_counter]--;
                                $rs_total_duty++;
                                $allocation++;
                                $mr_share--;
                                if (!array_key_exists($rs_rand->id, $rs_last))
                                    $rs_last[$rs_rand->id] = $tdKey;

                            }
                        }

                        if ($duty_counter != $rs_max_duty && $a3_flag) {


                            if ($a3_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty) {
                                $master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
                                $duty_counter++;
                                $a3_rs_count[$aft_counter]--;
                                $rs_total_duty++;
                                $allocation++;
                                $aft_share--;
                                if (!array_key_exists($rs_rand->id, $rs_last))
                                    $rs_last[$rs_rand->id] = $tdKey;

                            }

                        }

                        $mr_counter++;
                        $aft_counter++;
                    }

                    $rs_shortage[$rs_rand->id] = $duty_counter;
                    if (!array_key_exists($rs_rand->id, $rs_last)) {
                        $rs_last[$rs_rand->id] = count($td);
                    }
                    if ($duty_counter <= $this->data["rs_max_duty"] - 1 || in_array($rs_rand, $RS_pri))
                        $rs_allowed[$rs_rand->id] = 0;

                }


                foreach ($a3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][0][0]["m3"], $master[$this->getDateTag($td[$j]->date)][0][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][0][1]["a3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rs_shortage[$bval] <= $this->data["rs_max_duty"]) {
                                            $master[$this->getDateTag($td[$key]->date)][0][1]["a3"][$bkey] = $bval;
                                            $rs_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $a3_rs_count[$key]--;
                                            $rs_allowed[$bval]++;

                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($m3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][0][0]["m3"], $master[$this->getDateTag($td[$j]->date)][0][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][0][0]["m3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rs_shortage[$bval] <= $this->data["rs_max_duty"]) {
                                            $master[$this->getDateTag($td[$key]->date)][0][0]["m3"][$bkey] = $bval;
                                            $rs_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $m3_rs_count[$key]--;
                                            $rs_allowed[$bval]++;


                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($a3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][0][1]["a3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($m3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][0][0]["m3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($a4_rs_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][0][1]["a3"] as $k => $v) {
                        if ($ctr != $this->data["a4_rs_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][0][1]["a4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][0][1]["a3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach ($m4_rs_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][0][0]["m3"] as $k => $v) {
                        if ($ctr != $this->data["m4_rs_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][0][0]["m4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][0][0]["m3"][$k]);
                            $ctr++;
                        }
                    }
                }

                $to_test = "";
                $final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs);
                $sum_min = PHP_INT_MAX;
                $master_copy = $master;
                $rs_shortage_copy = $rs_shortage;
                $rs_allowed_copy = $rs_allowed;
                $duty_ctr_str_rs = "";
                $gap_str_rs = "";
                set_time_limit(0);
                $words = array(array('0', '1', '2'), array('0', '1', '2'), array('1', '2', '3'));
                $combos = $this->combinations($words, 0);

                foreach ($combos as $pKey => $pVal) {
                    $c_arr = explode(" ", $pVal);
                    foreach ($RS as $rKey => $rVal) {
                        $master = $master_copy;
                        $rs_shortage = $rs_shortage_copy;
                        $rs_allowed = $rs_allowed_copy;
                        foreach ($RS as $allowKey => $alloVal) {
                            if ($allowKey % ($rKey + 1) != 0)
                                $rs_allowed[$alloVal->id] = $rs_allowed[$alloVal->id] + $c_arr[0];
                            else
                                $rs_allowed[$alloVal->id] = $rs_allowed[$alloVal->id] + $c_arr[1];
                        }
                        foreach (array_reverse($RS) as $rskey => $rsp) {
                            if ($rs_shortage[$rsp->id] <= $this->data["rs_max_duty"] - $c_arr[2]) {
                                $pos = 1;

                                if (array_key_exists($rsp->id, $rs_pri_fac))
                                    $req = $rs_pri_fac[$rsp->id] - $rs_shortage[$rsp->id];
                                else {
                                    $req = $this->data["rs_max_duty"] - $rs_shortage[$rsp->id];
                                    if ($req == $this->data["rs_max_duty"]) {
                                        $req = $this->data["rs_max_duty"] - 1;
                                    }
                                }


                                $req_counter = 0;

                                while (array_key_exists($rs_last[$rsp->id] - $pos, $td) && $req_counter != $req) {
                                    $got = 0;

                                    $date_tag = $td[$rs_last[$rsp->id] - $pos]->date;


                                    foreach (array_merge($master[$this->getDateTag($date_tag)][0][0]["m3"], $master[$this->getDateTag($date_tag)][0][1]["a3"]) as $pt => $idVal) {
                                        if ($got == 0 && $rs_allowed[$idVal] != 0 && !isset($master[$this->getDateTag($date_tag)][0][0]["m3"][$rsp->name])) {

                                            for ($j = $this->data["rs_max_duty"] + 4; $j > 0; $j--) {
                                                if ($got == 0)
                                                    if (array_key_exists($idVal, $rs_shortage) && !array_key_exists($rsp->name, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                                        if ($rs_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rs_allowed) && $rs_allowed[$idVal] != 0) {

                                                            if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                                                $master[$this->getDateTag($date_tag)][0][0]["m3"][$rsp->name] = $rsp->id;
                                                                unset($master[$this->getDateTag($date_tag)][0][0]["m3"][$pt]);
                                                                $rs_shortage[$idVal]--;
                                                                $rs_shortage[$rsp->id]++;
                                                                $req_counter++;
                                                                //echo $pt."---->".$rsp->name."------->".$date_tag."<br>";
                                                                $rs_allowed[$idVal]--;
                                                                $got++;
                                                            }

                                                        }
                                                    }

                                                if ($got == 0)
                                                    if (array_key_exists($idVal, $rs_shortage) && !array_key_exists($rsp->name, $master[$this->getDateTag($date_tag)][0][1]["a3"])) {
                                                        if ($rs_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rs_allowed) && $rs_allowed[$idVal] != 0) {

                                                            if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                                                $master[$this->getDateTag($date_tag)][0][1]["a3"][$rsp->name] = $rsp->id;
                                                                unset($master[$this->getDateTag($date_tag)][0][1]["a3"][$pt]);
                                                                $rs_shortage[$idVal]--;
                                                                $rs_shortage[$rsp->id]++;
                                                                $req_counter++;
                                                                //echo $pt . "---->" . $rsp->name . "------->" . $date_tag . "<br>";
                                                                $rs_allowed[$idVal]--;
                                                                $got++;
                                                            }
                                                        }
                                                    }
                                            }
                                        }
                                    }


                                    if ($got == 0) {
                                        //echo "<h3>Skipped {$date_tag}</h3><br>";
                                    }
                                    $pos++;
                                }
                            }

                        }


                        $diff_array_rs = array();
                        $counter = 1;
                        $gap_str_rs = "";
                        $duty_arr_rs = array();
                        foreach ($RS as $rskey => $rsval) {

                            $diff_array_rs[$rsval->id] = array();
                            foreach ($td as $tdKey => $tdVal) {
                                foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m3"], $master[$this->getDateTag($td[$tdKey]->date)][0][0]["m4"]) as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }
                                foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a3"], $master[$this->getDateTag($td[$tdKey]->date)][0][1]["a4"]) as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }
                            }
                            $max = 0;

                            for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
                                $dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
                                if ($max < $dif)
                                    $max = $dif;

                            }


                            if ($max != 0)
                                $max--;
                            if ($max >= 3) {
                                //echo "<br>{$counter}Long Gap(2)-->".$rsval->name."($max)";
                                $gap_str_rs .= "<tr><td>{$counter}</td><td>{$rsval->name}</td><td>{$max}</td></tr>";
                                $counter++;
                                //echo "<pre>".print_r($diff_array_rs[$rsval->id],true)."</pre>";
                            }

                            if (!array_key_exists(count($diff_array_rs[$rsval->id]), $duty_arr_rs)) {
                                $duty_arr_rs[count($diff_array_rs[$rsval->id])] = array();
                            }

                            $duty_arr_rs[count($diff_array_rs[$rsval->id])][] = $rsval->id;


                        }

                        $duty_ctr_str_rs = "";
                        foreach ($duty_arr_rs as $key => $val) {
                            $cnt = count($val);
                            $duty_ctr_str_rs .= "<tr><td>{$cnt}</td><td>{$key}</td></tr>";
                        }

                        if ($counter + count($duty_arr_rs) <= $sum_min) {
                            $sum_min = $counter + count($duty_arr_rs);
                            $final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs, count($duty_arr_rs), $counter, $sum_min, $c_arr[0], $c_arr[1], $c_arr[2]);
                            $to_test .= $pVal . " " . ($rKey + 1) . "-->" . ($sum_min - 1) . "<br>";
                        }

//					if($sum_min !=PHP_INT_MAX) {
//						if ($counter + count($duty_arr_rs) == $sum_min) {
//							$final_arr_cpy = $final_arr;
//							$sum_min = $rKey + 1;
//							$final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs, count($duty_arr_rs), $counter, $sum_min,$c_arr[0],$c_arr[1],$c_arr[2]);
//							if (count($duty_arr_rs) > $final_arr_cpy[3]) {
//								$final_arr = $final_arr_cpy;
//								$sum_min = $final_arr[5];
//							}
//						} else if ($counter + count($duty_arr_rs) < $sum_min) {
//							$final_arr_cpy = $final_arr;
//							$sum_min = $rKey + 1;
//							$final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs, count($duty_arr_rs), $counter, $sum_min,$c_arr[0],$c_arr[1],$c_arr[2]);
//							if (count($duty_arr_rs) > $final_arr_cpy[3]) {
//								$final_arr = $final_arr_cpy;
//								$sum_min = $final_arr[5];
//							}
//
//							if (count($duty_arr_rs) <= 3 && !array_key_exists(0, $duty_arr_rs)) {
//								$sum_min = $rKey + 1;
//								$final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs, count($duty_arr_rs), $counter, $sum_min,$c_arr[0],$c_arr[1],$c_arr[2]);
//							}
//						}
//					} else {
//						$sum_min = $rKey + 1;
//						$final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs, count($duty_arr_rs), $counter, $sum_min,$c_arr[0],$c_arr[1],$c_arr[2]);
//					}
                    }
                }
                $master = $final_arr[0];
                $gap_str_rs = $final_arr[1];
                $duty_ctr_str_rs = $final_arr[2];
            }


//-------------------------------------------------------RLS-----------------------------------------------------------
            if ($req_flag == "ls" || $gen_flag) {
                $rls_allowed = array();
                $rls_shortage = array();
                $rls_last = array();

                $allocation = 0;
                $rls_total_duty = 0;
                $rls_index = 0;

                $rls_pri_fac = array();
                foreach ($RLS as $rls_rand) {
                    if ($rls_index % $rls_four != 0)
                        $rls_allowed[$rls_rand->id] = $rls_one;
                    else
                        $rls_allowed[$rls_rand->id] = $rls_two;

                    if ($rls_rand->priority && $rls_priority_duty >= 1 && $rls_priority_duty < $this->data["rls_max_duty"]) {
                        $rls_max_duty = $rls_priority_duty;
                        $rls_pri_fac[$rls_rand->id] = $rls_priority_duty;
                    } else
                        $rls_max_duty = $this->data["rls_max_duty"];
                    $duty_counter = 0;
                    $mr_counter = 0;
                    $aft_counter = 0;
                    $rls_index++;
                    $aft_share = round($rls_max_duty * 25 / 100);
                    $mr_share = $rls_max_duty - $aft_share;
                    foreach ($td as $tdKey => $time_data) {

                        $m3_flag = true;
                        $a3_flag = true;
//							if($duty_counter != $rls_max_duty && $mr_share!=0){
//								if($m3_rls_count[$mr_counter] != 0 && $duty_counter != $rls_max_duty){
//									$master[$this->getDateTag($time_data->date)][1][0]["m3"][$rls_rand->name] = $rls_rand->id;
//									$duty_counter++;
//									$m3_rls_count[$mr_counter]--;
//									$m3_flag=false;
//									$rls_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($rls_rand->id,$rls_last))
//										$rls_last[$rls_rand->id] = $tdKey;
//
//								}
//							}
//
//							if($duty_counter != $rls_max_duty && $aft_share!=0){
//
//
//									if($a3_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty){
//										$master[$this->getDateTag($time_data->date)][1][1]["a3"][$rls_rand->name] = $rls_rand->id;
//										$duty_counter++;
//										$a3_rls_count[$aft_counter]--;
//										$a3_flag=false;
//										$rls_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($rls_rand->id,$rls_last))
//											$rls_last[$rls_rand->id] = $tdKey;
//
//									}
//
//							}

                        if ($duty_counter != $rls_max_duty && $m3_flag) {
                            if ($m3_rls_count[$mr_counter] != 0 && $duty_counter != $rls_max_duty) {
                                $master[$this->getDateTag($time_data->date)][1][0]["m3"][$rls_rand->name] = $rls_rand->id;
                                $duty_counter++;
                                $m3_rls_count[$mr_counter]--;
                                $rls_total_duty++;
                                $allocation++;
                                $mr_share--;
                                if (!array_key_exists($rls_rand->id, $rls_last))
                                    $rls_last[$rls_rand->id] = $tdKey;

                            }
                        }

                        if ($duty_counter != $rls_max_duty && $a3_flag) {


                            if ($a3_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty) {
                                $master[$this->getDateTag($time_data->date)][1][1]["a3"][$rls_rand->name] = $rls_rand->id;
                                $duty_counter++;
                                $a3_rls_count[$aft_counter]--;
                                $rls_total_duty++;
                                $allocation++;
                                $aft_share--;
                                if (!array_key_exists($rls_rand->id, $rls_last))
                                    $rls_last[$rls_rand->id] = $tdKey;

                            }

                        }

                        $mr_counter++;
                        $aft_counter++;
                    }

                    $rls_shortage[$rls_rand->id] = $duty_counter;
                    if (!array_key_exists($rls_rand->id, $rls_last)) {
                        $rls_last[$rls_rand->id] = count($td);
                    }
                    if ($duty_counter <= $this->data["rls_max_duty"] - 1 || in_array($rls_rand, $RLS_pri))
                        $rls_allowed[$rls_rand->id] = 0;

                }


                foreach ($a3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][1][0]["m3"], $master[$this->getDateTag($td[$j]->date)][1][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][1][1]["a3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rls_shortage[$bval] <= $this->data["rls_max_duty"]) {
                                            $master[$this->getDateTag($td[$key]->date)][1][1]["a3"][$bkey] = $bval;
                                            $rls_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $a3_rls_count[$key]--;
                                            $rls_allowed[$bval]++;

                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($m3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][1][0]["m3"], $master[$this->getDateTag($td[$j]->date)][1][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][1][0]["m3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rls_shortage[$bval] <= $this->data["rls_max_duty"]) {
                                            $master[$this->getDateTag($td[$key]->date)][1][0]["m3"][$bkey] = $bval;
                                            $rls_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $m3_rls_count[$key]--;
                                            $rls_allowed[$bval]++;


                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($a3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][1][1]["a3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($m3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][1][0]["m3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($a4_rls_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][1][1]["a3"] as $k => $v) {
                        if ($ctr != $this->data["a4_rls_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][1][1]["a4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][1][1]["a3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach ($m4_rls_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][1][0]["m3"] as $k => $v) {
                        if ($ctr != $this->data["m4_rls_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][1][0]["m4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][1][0]["m3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach (array_reverse($RLS) as $rlskey => $rlsp) {
                    if ($rls_shortage[$rlsp->id] <= $this->data["rls_max_duty"] - $rls_three) {
                        $pos = 1;

                        if (array_key_exists($rlsp->id, $rls_pri_fac))
                            $req = $rls_pri_fac[$rlsp->id] - $rls_shortage[$rlsp->id];
                        else {
                            $req = $this->data["rls_max_duty"] - $rls_shortage[$rlsp->id];
                            if ($req == $this->data["rls_max_duty"]) {
                                $req = $this->data["rls_max_duty"] - 1;
                            }
                        }


                        $req_counter = 0;

                        while (array_key_exists($rls_last[$rlsp->id] - $pos, $td) && $req_counter != $req) {
                            $got = 0;

                            $date_tag = $td[$rls_last[$rlsp->id] - $pos]->date;


                            foreach (array_merge($master[$this->getDateTag($date_tag)][1][0]["m3"], $master[$this->getDateTag($date_tag)][1][1]["a3"]) as $pt => $idVal) {
                                if ($got == 0 && $rls_allowed[$idVal] != 0) {

                                    for ($j = $this->data["rls_max_duty"] + 4; $j > 0; $j--) {

                                        if (array_key_exists($idVal, $rls_shortage) && !array_key_exists($rlsp->name, $master[$this->getDateTag($date_tag)][1][0]["m3"])) {
                                            if ($rls_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rls_allowed) && $rls_allowed[$idVal] != 0) {

                                                if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][1][0]["m3"])) {
                                                    $master[$this->getDateTag($date_tag)][1][0]["m3"][$rlsp->name] = $rlsp->id;
                                                    unset($master[$this->getDateTag($date_tag)][1][0]["m3"][$pt]);
                                                    $rls_shortage[$idVal]--;
                                                    $rls_shortage[$rlsp->id]++;
                                                    $req_counter++;
                                                    //echo $pt."---->".$rlsp->name."------->".$date_tag."<br>";
                                                    $rls_allowed[$idVal]--;
                                                    $got++;
                                                }

                                            }
                                        }

                                        if (array_key_exists($idVal, $rls_shortage) && !array_key_exists($rlsp->name, $master[$this->getDateTag($date_tag)][1][1]["a3"])) {
                                            if ($rls_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rls_allowed) && $rls_allowed[$idVal] != 0) {

                                                if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][1][0]["m3"])) {
                                                    $master[$this->getDateTag($date_tag)][1][1]["a3"][$rlsp->name] = $rlsp->id;
                                                    unset($master[$this->getDateTag($date_tag)][1][1]["a3"][$pt]);
                                                    $rls_shortage[$idVal]--;
                                                    $rls_shortage[$rlsp->id]++;
                                                    $req_counter++;
                                                    //echo $pt . "---->" . $rlsp->name . "------->" . $date_tag . "<br>";
                                                    $rls_allowed[$idVal]--;
                                                    $got++;
                                                }
                                            }
                                        }
                                    }
                                }
                            }


                            if ($got == 0) {
                                //echo "<h3>Skipped {$date_tag}</h3><br>";
                            }
                            $pos++;
                        }
                    }

                }

                $diff_array_rls = array();
                $counter = 1;
                $gap_str_rls = "";
                $duty_arr_rls = array();
                foreach ($RLS as $rlskey => $rlsval) {

                    $diff_array_rls[$rlsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][1][0]["m3"], $master[$this->getDateTag($td[$tdKey]->date)][1][0]["m4"]) as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }
                        foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][1][1]["a3"], $master[$this->getDateTag($td[$tdKey]->date)][1][1]["a4"]) as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;

                    for ($i = 0; $i < count($diff_array_rls[$rlsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_rls[$rlsval->id][$i] - $diff_array_rls[$rlsval->id][$i + 1]);
                        if ($max < $dif)
                            $max = $dif;

                    }


                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        //echo "<br>{$counter}Long Gap(2)-->".$rlsval->name."($max)";
                        $gap_str_rls .= "<tr><td>{$counter}</td><td>{$rlsval->name}</td><td>{$max}</td></tr>";
                        $counter++;
                        //echo "<pre>".print_r($diff_array_rls[$rlsval->id],true)."</pre>";
                    }

                    if (!array_key_exists(count($diff_array_rls[$rlsval->id]), $duty_arr_rls)) {
                        $duty_arr_rls[count($diff_array_rls[$rlsval->id])] = array();
                    }

                    $duty_arr_rls[count($diff_array_rls[$rlsval->id])][] = $rlsval->id;


                }

                $duty_ctr_str_rls = "";
                foreach ($duty_arr_rls as $key => $val) {
                    $cnt = count($val);
                    $duty_ctr_str_rls .= "<tr><td>{$cnt}</td><td>{$key}</td></tr>";
                }
            }

//-------------------------------------------------------DS--------------------------------------------------------------
            if ($req_flag == "ds" || $gen_flag) {
                $ds_allowed = array();
                $ds_shortage = array();
                $ds_last = array();

                $allocation = 0;
                $ds_total_duty = 0;
                $ds_index = 0;
                $ds_ctr = 0;
                $ds_pri_fac = array();
                foreach ($DS as $ds_rand) {
                    $ds_allowed[$ds_rand->id] = 0;
                    if ($ds_index % $ds_four != 0)
                        $ds_allowed[$ds_rand->id] = $ds_one;
                    else
                        $ds_allowed[$ds_rand->id] = $ds_two;

//				if($ds_ctr!=$ds_four){
//					if($ds_index%2!=0)
//						$ds_allowed[$ds_rand->id] =$ds_one;
//					else
//						$ds_allowed[$ds_rand->id] =$ds_two;
//				}

                    if ($ds_rand->priority && $ds_priority_duty >= 1 && $ds_priority_duty < $this->data["ds_max_duty"]) {
                        $ds_max_duty = $ds_priority_duty;
                        $ds_pri_fac[$ds_rand->id] = $ds_priority_duty;
                    } else
                        $ds_max_duty = $this->data["ds_max_duty"];
                    $duty_counter = 0;
                    $mr_counter = 0;
                    $aft_counter = 0;
                    $ds_index++;
                    $aft_share = round($ds_max_duty * 25 / 100);
                    $mr_share = $ds_max_duty - $aft_share;
                    foreach ($td as $tdKey => $time_data) {

                        $m3_flag = true;
                        $a3_flag = true;
//							if($duty_counter != $ds_max_duty && $mr_share!=0){
//								if($m3_ds_count[$mr_counter] != 0 && $duty_counter != $ds_max_duty){
//									$master[$this->getDateTag($time_data->date)][2][0]["m3"][$ds_rand->name] = $ds_rand->id;
//									$duty_counter++;
//									$m3_ds_count[$mr_counter]--;
//									$m3_flag=false;
//									$ds_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($ds_rand->id,$ds_last))
//										$ds_last[$ds_rand->id] = $tdKey;
//
//								}
//							}
//
//							if($duty_counter != $ds_max_duty && $aft_share!=0){
//
//
//									if($a3_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty){
//										$master[$this->getDateTag($time_data->date)][2][1]["a3"][$ds_rand->name] = $ds_rand->id;
//										$duty_counter++;
//										$a3_ds_count[$aft_counter]--;
//										$a3_flag=false;
//										$ds_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($ds_rand->id,$ds_last))
//											$ds_last[$ds_rand->id] = $tdKey;
//
//									}
//
//							}

                        if ($duty_counter != $ds_max_duty && $m3_flag) {
                            if ($m3_ds_count[$mr_counter] != 0 && $duty_counter != $ds_max_duty) {
                                $master[$this->getDateTag($time_data->date)][2][0]["m3"][$ds_rand->name] = $ds_rand->id;
                                $duty_counter++;
                                $m3_ds_count[$mr_counter]--;
                                $ds_total_duty++;
                                $allocation++;
                                $mr_share--;
                                if (!array_key_exists($ds_rand->id, $ds_last))
                                    $ds_last[$ds_rand->id] = $tdKey;

                            }
                        }

                        if ($duty_counter != $ds_max_duty && $a3_flag) {


                            if ($a3_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty) {
                                $master[$this->getDateTag($time_data->date)][2][1]["a3"][$ds_rand->name] = $ds_rand->id;
                                $duty_counter++;
                                $a3_ds_count[$aft_counter]--;
                                $ds_total_duty++;
                                $allocation++;
                                $aft_share--;
                                if (!array_key_exists($ds_rand->id, $ds_last))
                                    $ds_last[$ds_rand->id] = $tdKey;

                            }

                        }

                        $mr_counter++;
                        $aft_counter++;
                    }

                    $ds_shortage[$ds_rand->id] = $duty_counter;
                    if (!array_key_exists($ds_rand->id, $ds_last)) {
                        $ds_last[$ds_rand->id] = count($td);
                    }
                    if ($duty_counter <= $this->data["ds_max_duty"] - 1 || in_array($ds_rand, $DS_pri))
                        $ds_allowed[$ds_rand->id] = 0;

                }

                foreach ($a3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][2][0]["m3"], $master[$this->getDateTag($td[$j]->date)][2][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][2][1]["a3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $ds_shortage[$bval] <= $this->data["ds_max_duty"]) {
                                            $master[$this->getDateTag($td[$key]->date)][2][1]["a3"][$bkey] = $bval;
                                            $ds_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $a3_ds_count[$key]--;
                                            $ds_allowed[$bval]++;

                                        }
                                    }
                                }
                            }

                        }
                    }
                }

                foreach ($m3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][2][0]["m3"], $master[$this->getDateTag($td[$j]->date)][2][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][2][0]["m3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $ds_shortage[$bval] <= $this->data["ds_max_duty"]) {
                                            $master[$this->getDateTag($td[$key]->date)][2][0]["m3"][$bkey] = $bval;
                                            $ds_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $m3_ds_count[$key]--;
                                            $ds_allowed[$bval]++;


                                        }
                                    }
                                }
                            }

                        }
                    }
                }

                foreach ($a3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][2][1]["a3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }

                foreach ($m3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][2][0]["m3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }

                foreach ($a4_ds_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][2][1]["a3"] as $k => $v) {
                        if ($ctr != $this->data["a4_ds_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][2][1]["a4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][2][1]["a3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach ($m4_ds_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][2][0]["m3"] as $k => $v) {
                        if ($ctr != $this->data["m4_ds_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][2][0]["m4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][2][0]["m3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach (array_reverse($DS) as $dskey => $dsp) {
                    if ($ds_shortage[$dsp->id] <= $this->data["ds_max_duty"] - $ds_three) {
                        $pos = 1;

                        if (array_key_exists($dsp->id, $ds_pri_fac))
                            $req = $ds_pri_fac[$dsp->id] - $ds_shortage[$dsp->id];
                        else {
                            $req = $this->data["ds_max_duty"] - $ds_shortage[$dsp->id];
                            if ($req == $this->data["ds_max_duty"]) {
                                $req = $this->data["ds_max_duty"] - 1;
                            }
                        }


                        $req_counter = 0;

                        while (array_key_exists($ds_last[$dsp->id] - $pos, $td) && $req_counter != $req) {
                            $got = 0;

                            $date_tag = $td[$ds_last[$dsp->id] - $pos]->date;


                            foreach (array_merge($master[$this->getDateTag($date_tag)][2][0]["m3"], $master[$this->getDateTag($date_tag)][2][1]["a3"]) as $pt => $idVal) {
                                if ($got == 0 && $ds_allowed[$idVal] != 0) {

                                    for ($j = $this->data["ds_max_duty"] + 4; $j > 0; $j--) {

                                        if (array_key_exists($idVal, $ds_shortage) && !array_key_exists($dsp->name, $master[$this->getDateTag($date_tag)][2][0]["m3"])) {
                                            if ($ds_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $ds_allowed) && $ds_allowed[$idVal] != 0) {

                                                if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][2][0]["m3"])) {
                                                    $master[$this->getDateTag($date_tag)][2][0]["m3"][$dsp->name] = $dsp->id;
                                                    unset($master[$this->getDateTag($date_tag)][2][0]["m3"][$pt]);
                                                    $ds_shortage[$idVal]--;
                                                    $ds_shortage[$dsp->id]++;
                                                    $req_counter++;
                                                    //echo $pt."---->".$dsp->name."------->".$date_tag."<br>";
                                                    $ds_allowed[$idVal]--;
                                                    $got++;
                                                }

                                            }
                                        }

                                        if (array_key_exists($idVal, $ds_shortage) && !array_key_exists($dsp->name, $master[$this->getDateTag($date_tag)][2][1]["a3"])) {
                                            if ($ds_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $ds_allowed) && $ds_allowed[$idVal] != 0) {

                                                if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][2][0]["m3"])) {
                                                    $master[$this->getDateTag($date_tag)][2][1]["a3"][$dsp->name] = $dsp->id;
                                                    unset($master[$this->getDateTag($date_tag)][2][1]["a3"][$pt]);
                                                    $ds_shortage[$idVal]--;
                                                    $ds_shortage[$dsp->id]++;
                                                    $req_counter++;
                                                    //echo $pt . "---->" . $dsp->name . "------->" . $date_tag . "<br>";
                                                    $ds_allowed[$idVal]--;
                                                    $got++;
                                                }
                                            }
                                        }
                                    }
                                }
                            }


                            if ($got == 0) {
                                //echo "<h3>Skipped {$date_tag}</h3><br>";
                            }
                            $pos++;
                        }
                    }

                }

                $diff_array_ds = array();
                $counter = 1;
                $gap_str_ds = "";
                $duty_arr_ds = array();
                foreach ($DS as $dskey => $dsval) {

                    $diff_array_ds[$dsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][2][0]["m3"], $master[$this->getDateTag($td[$tdKey]->date)][2][0]["m4"]) as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }
                        foreach (array_merge($master[$this->getDateTag($td[$tdKey]->date)][2][1]["a3"], $master[$this->getDateTag($td[$tdKey]->date)][2][1]["a4"]) as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;

                    for ($i = 0; $i < count($diff_array_ds[$dsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_ds[$dsval->id][$i] - $diff_array_ds[$dsval->id][$i + 1]);
                        if ($max < $dif)
                            $max = $dif;

                    }


                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        //echo "<br>{$counter}Long Gap(2)-->".$dsval->name."($max)";
                        $gap_str_ds .= "<tr><td>{$counter}</td><td>{$dsval->name}</td><td>{$max}</td></tr>";
                        $counter++;
                        //echo "<pre>".print_r($diff_array_ds[$dsval->id],true)."</pre>";
                    }

                    if (!array_key_exists(count($diff_array_ds[$dsval->id]), $duty_arr_ds)) {
                        $duty_arr_ds[count($diff_array_ds[$dsval->id])] = array();
                    }

                    $duty_arr_ds[count($diff_array_ds[$dsval->id])][] = $dsval->id;


                }

                $duty_ctr_str_ds = "";
                foreach ($duty_arr_ds as $key => $val) {
                    $cnt = count($val);
                    $duty_ctr_str_ds .= "<tr><td>{$cnt}</td><td>{$key}</td></tr>";
                }
            }
            $this->data["populate"] = $master;
            $this->data["populate"] = $master;
            $this->data["m3_str"] = $m3_str;
            $this->data["m4_str"] = $m4_str;
            $this->data["a3_str"] = $a3_str;
            $this->data["a4_str"] = $a4_str;
            
            if ($gen_flag) {
                $str = $this->load->view("assign_duty_ajax", $this->data, true);
            }
            //echo "<pre>".print_r($master,true)."</pre>";
            echo json_encode(array($gap_str_rs, $duty_ctr_str_rs, $gap_str_rls, $duty_ctr_str_rls, $gap_str_ds, $duty_ctr_str_ds, $str, $to_test));
        }

    }

    public function ana3()
    {

        {
            $gen_flag = true;
            $gap_str_rs = $duty_ctr_str_rs = $gap_str_rls = $duty_ctr_str_rls = $gap_str_ds = $duty_ctr_str_ds = $str = "";
            $req_flag = $this->input->post("req_flag");
            $rs_one = $this->input->post("rs_one");
            $rs_two = $this->input->post("rs_two");
            $rs_three = $this->input->post("rs_three");
            $rs_four = $this->input->post("rs_four");

            $rls_one = $this->input->post("rls_one");
            $rls_two = $this->input->post("rls_two");
            $rls_three = $this->input->post("rls_three");
            $rls_four = $this->input->post("rls_four");

            $ds_one = $this->input->post("ds_one");
            $ds_two = $this->input->post("ds_two");
            $ds_three = $this->input->post("ds_three");
            $ds_four = $this->input->post("ds_four");
            $ex_id = $this->input->post("id");

//            if (!$this->session->userdata('opmiz_ajax')) {
            $settings = $this->master_db->getRecords("settings", array());
            $this->data['table_data'] = $td = $this->master_db->getRecords("time_table_{$ex_id}", array("exam_id" => $ex_id), '*', 'id asc');
            $RS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
            $RLS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
            $DS = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 0, "designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

            if (is_array($RS) && count($RS) >= 1) ;
            //shuffle($RS);
            else
                $RS = array();
            if (is_array($RLS) && count($RLS) >= 1) ;
            //shuffle($RLS);
            else
                $RLS = array();
            if (is_array($DS) && count($DS) >= 1) ;
            //shuffle($DS);
            else
                $DS = array();

            $RS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 0), '*', 'id asc');
            $RLS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation" => 2, "status" => 1, "priority" => 0), '*', 'id asc');
            $DS_ex = $this->master_db->getRecords("prof_{$ex_id}", array("have_exclude_date" => 1, "designation" => 3, "status" => 1, "priority" => 0), '*', 'id asc');

            if (is_array($RS_ex) && count($RS_ex) >= 1) ;
            //shuffle($RS_ex);
            else
                $RS_ex = array();
            if (is_array($RLS_ex) && count($RLS_ex) >= 1) ;
            //shuffle($RLS_ex);
            else
                $RLS_ex = array();
            if (is_array($DS_ex) && count($DS_ex) >= 1) ;
            //shuffle($DS_ex);
            else
                $DS_ex = array();


            $RS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation !=" => 2, "designation != " => 3, "status" => 1, "priority" => 1));
            $RLS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 2, "status" => 1, "priority" => 1));
            $DS_pri = $this->master_db->getRecords("prof_{$ex_id}", array("designation" => 3, "status" => 1, "priority" => 1));

            if (is_array($RS_pri) && count($RS_pri) >= 1) ;
            //shuffle($RS_pri);
            else
                $RS_pri = array();
            if (is_array($RLS_pri) && count($RLS_pri) >= 1) ;
            //shuffle($RLS_pri);
            else
                $RLS_pri = array();
            if (is_array($DS_pri) && count($DS_pri) >= 1) ;
            //shuffle($DS_pri);
            else
                $DS_pri = array();

            //if(is_array($RS_pri) && count($RS_pri))
            $RS = array_merge($RS_ex, array_merge($RS_pri, $RS));
            //if(is_array($RLS_pri) && count($RLS_pri))
            $RLS = array_merge($RLS_ex, array_merge($RLS_pri, $RLS));
            //if(is_array($DS_pri) && count($DS_pri))
            $DS = array_merge($DS_ex, array_merge($DS_pri, $DS));
            $ex_dates = array();
            $ex_dates_db = $this->master_db->getRecords("exclude_date_{$ex_id}", array());
            if (is_array($ex_dates_db) && count($ex_dates_db) >= 1) {
                foreach ($ex_dates_db as $val) {
                    if (!array_key_exists($val->prof_id, $ex_dates)) {
                        $ex_dates[$val->prof_id] = array();
                    }
                    $ex_dates[$val->prof_id][] = $val->date;
                }
            }

            $this->data['RS'] = $RS;
            $this->data['RLS'] = $RLS;
            $this->data['DS'] = $DS;
            $this->session->set_userdata("opmiz_ajax", "1");
            $this->session->set_userdata("td", $td);
            $this->session->set_userdata("RS", $RS);
            $this->session->set_userdata("RLS", $RLS);
            $this->session->set_userdata("DS", $DS);
            $this->session->set_userdata("RS_pri", $RS_pri);
            $this->session->set_userdata("RLS_pri", $RLS_pri);
            $this->session->set_userdata("DS_pri", $DS_pri);
            $this->session->set_userdata("settings", $settings);
//            } else {
//                $this->data['table_data'] = $td = $this->session->userdata('td');
//                $RS = $this->data['RS'] = $this->session->userdata('RS');
//                $RLS = $this->data['RLS'] = $this->session->userdata('RLS');
//                $DS = $this->data['DS'] = $this->session->userdata('DS');
//                $RS_pri = $this->session->userdata('RS_pri');
//                $RLS_pri = $this->session->userdata('RLS_pri');
//                $DS_pri = $this->session->userdata('DS_pri');
//                $settings = $this->session->userdata('settings');
//            }

            $m3_str = array();
            $m4_str = array();
            $a3_str = array();
            $a4_str = array();


            $m3_rs_count = array();
            $m3_rls_count = array();
            $m3_ds_count = array();

            $m4_rs_count = array();
            $m4_rls_count = array();
            $m4_ds_count = array();

            $a3_rs_count = array();
            $a3_rls_count = array();
            $a3_ds_count = array();

            $a4_rs_count = array();
            $a4_rls_count = array();
            $a4_ds_count = array();

            $rs_max_duty = 0;
            $rls_max_duty = 0;
            $ds_max_duty = 0;

            $counter = 0;
            $master = array();
            $this->initalize_master($master, $td);

            foreach ($td as $key => $row) {
                $m3 = 0;
                $m4 = 0;
                $a3 = 0;
                $a4 = 0;
                $m3_str[] = $row->m3strength;
                $m4_str[] = $row->m4strength;
                $a3_str[] = $row->a3strength;
                $a4_str[] = $row->a4strength;
                if ($row->m3strength != -1) {
                    $m3 += $row->m3strength;
                }

                if ($row->m4strength != -1) {
                    $m4 += $row->m4strength;
                }

                if ($row->a3strength != -1) {
                    $a3 += $row->a3strength;
                }

                if ($row->a4strength != -1) {
                    $a4 += $row->a4strength;
                }

                if ($m3 < 30) {
                    $m3_rs_count[] = ceil($m3 / 30);

                } else {
                    $m3_rs_count[] = round($m3 / 30);

                }
                if ($a3 < 30) {
                    $a3_rs_count[] = ceil($a3 / 30);

                } else {
                    $a3_rs_count[] = round($a3 / 30);

                }
                if ($m4 < 30) {
                    $m4_rs_count[] = ceil($m4 / 30);

                } else {
                    $m4_rs_count[] = round($m4 / 30);

                }
                if ($a4 < 30) {
                    $a4_rs_count[] = ceil($a4 / 30);

                } else {
                    $a4_rs_count[] = round($a4 / 30);

                }

                if ($m3 >= 76) {
                    if ($m3_rs_count[$counter] < 5)
                        $m3_rls_count[] = ceil(($m3_rs_count[$counter]) / 5);
                    else
                        $m3_rls_count[] = round(($m3_rs_count[$counter]) / 5);
                } else {
                    $m3_rls_count[] = 0;
                }

                if ($a3 >= 76) {
                    if ($a3_rs_count[$counter] < 5)
                        $a3_rls_count[] = ceil(($a3_rs_count[$counter]) / 5);
                    else
                        $a3_rls_count[] = round(($a3_rs_count[$counter]) / 5);
                } else {
                    $a3_rls_count[] = 0;
                }

                if ($m4 >= 76) {
                    if ($m4_rs_count[$counter] < 5)
                        $m4_rls_count[] = ceil(($m4_rs_count[$counter]) / 5);
                    else
                        $m4_rls_count[] = round(($m4_rs_count[$counter]) / 5);
                } else {
                    $m4_rls_count[] = 0;
                }

                if ($a4 >= 76) {
                    if ($a4_rs_count[$counter] < 5)
                        $a4_rls_count[] = ceil(($a4_rs_count[$counter]) / 5);
                    else
                        $a4_rls_count[] = round(($a4_rs_count[$counter]) / 5);
                } else {
                    $a4_rls_count[] = 0;
                }


                if ($m3 < 250) {

                    $m3_ds_count[] = ceil(($m3) / 250);
                } else {

                    $m3_ds_count[] = round(($m3) / 250);
                }
                if ($a3 < 250) {

                    $a3_ds_count[] = ceil(($a3) / 250);
                } else {

                    $a3_ds_count[] = round(($a3) / 250);
                }
                if ($m4 < 250) {

                    $m4_ds_count[] = ceil(($m4) / 250);
                } else {

                    $m4_ds_count[] = round(($m4) / 250);
                }
                if ($a4 < 250) {

                    $a4_ds_count[] = ceil(($a4) / 250);
                } else {

                    $a4_ds_count[] = round(($a4) / 250);
                }

                $rs_max_duty += $m3_rs_count[$counter] + $a3_rs_count[$counter] + $m4_rs_count[$counter] + $a4_rs_count[$counter];
                $rls_max_duty += $m3_rls_count[$counter] + $a3_rls_count[$counter] + $m4_rls_count[$counter] + $a4_rls_count[$counter];
                $ds_max_duty += $m3_ds_count[$counter] + $a3_ds_count[$counter] + $m4_ds_count[$counter] + $a4_ds_count[$counter];

                $counter++;

            }

            $this->data["m3_rs_count"] = $m3_rs_count;
            $this->data["a3_rs_count"] = $a3_rs_count;

            $this->data["m4_rs_count"] = $m4_rs_count;
            $this->data["a4_rs_count"] = $a4_rs_count;


            $this->data["m3_rls_count"] = $m3_rls_count;
            $this->data["a3_rls_count"] = $a3_rls_count;

            $this->data["m4_rls_count"] = $m4_rls_count;
            $this->data["a4_rls_count"] = $a4_rls_count;

            $this->data["m3_ds_count"] = $m3_ds_count;
            $this->data["a3_ds_count"] = $a3_ds_count;

            $this->data["m4_ds_count"] = $m4_ds_count;
            $this->data["a4_ds_count"] = $a4_ds_count;

            foreach ($td as $key => $val) {
                $m3_rs_count[$key] += $m4_rs_count[$key];
                $a3_rs_count[$key] += $a4_rs_count[$key];

                $m3_rls_count[$key] += $m4_rls_count[$key];
                $a3_rls_count[$key] += $a4_rls_count[$key];

                $m3_ds_count[$key] += $m4_ds_count[$key];
                $a3_ds_count[$key] += $a4_ds_count[$key];
            }


            $this->data["rs_count"] = $rs_max_duty;
            $this->data["rls_count"] = $rls_max_duty;
            $this->data["ds_count"] = $ds_max_duty;


            $rs_priority_duty = $settings[0]->rs_priority_duty;
            $rls_priority_duty = $settings[0]->rls_priority_duty;
            $ds_priority_duty = $settings[0]->ds_priority_duty;


            $rs_max_duty_temp = ceil($rs_max_duty / count($RS));
            $rls_max_duty_temp = ceil($rls_max_duty / count($RLS));
            $ds_max_duty_temp = ceil($ds_max_duty / count($DS));

            if ($rs_priority_duty < $rs_max_duty_temp && is_array($RS_pri) && count($RS_pri) >= 1 && $rs_priority_duty >= 1) {
                $this->data["rs_max_duty"] = $rs_max_duty = ceil(($rs_max_duty + (($rs_max_duty_temp - $rs_priority_duty) * count($RS_pri))) / count($RS));
            } else {
                $this->data["rs_max_duty"] = $rs_max_duty = ceil($rs_max_duty / count($RS));
            }

            if ($rls_priority_duty < $rls_max_duty_temp && is_array($RLS_pri) && count($RLS_pri) >= 1 && $rls_priority_duty >= 1) {
                $this->data["rls_max_duty"] = $rls_max_duty = ceil(($rls_max_duty + (($rls_max_duty_temp - $rls_priority_duty) * count($RLS_pri))) / count($RLS));
            } else {
                $this->data["rls_max_duty"] = $rls_max_duty = ceil($rls_max_duty / count($RLS));
            }


            if ($ds_priority_duty < $ds_max_duty_temp && is_array($DS_pri) && count($DS_pri) >= 1 && $ds_priority_duty >= 1) {
                $this->data["ds_max_duty"] = $ds_max_duty = ceil(($ds_max_duty + (($ds_max_duty_temp - $ds_priority_duty) * count($DS_pri))) / count($DS));
            } else {
                $this->data["ds_max_duty"] = $ds_max_duty = ceil($ds_max_duty / count($DS));
            }


//---------------------------------------------------RS------------------------------------------------------------
            if ($req_flag == "rs" || $gen_flag) {
                $rs_allowed = array();
                $rs_shortage = array();
                $rs_last = array();

                $allocation = 0;
                $rs_total_duty = 0;
                $rs_index = 0;

                $rs_pri_fac = array();
                $rs_ex_fac = array();
                foreach ($RS as $rs_rand) {
                    if (!array_key_exists($rs_rand->id, $ex_dates)) {
                        $ex_dates[$rs_rand->id] = array();
                    } else {
                        $rs_ex_fac[$rs_rand->id] = $rs_rand->id;
                    }
                    $rs_allowed[$rs_rand->id] = 0;


                    if ($rs_rand->priority && $rs_priority_duty >= 1 && $rs_priority_duty < $this->data["rs_max_duty"]) {
                        $rs_max_duty = $rs_priority_duty;
                        $rs_pri_fac[$rs_rand->id] = $rs_priority_duty;
                    } else
                        $rs_max_duty = $this->data["rs_max_duty"];
                    $duty_counter = 0;
                    $mr_counter = 0;
                    $aft_counter = 0;
                    $rs_index++;
                    $aft_share = round($rs_max_duty * 25 / 100);
                    $mr_share = $rs_max_duty - $aft_share;
                    foreach ($td as $tdKey => $time_data) {

                        $m3_flag = true;
                        $a3_flag = true;
//							if($duty_counter != $rs_max_duty && $mr_share!=0){
//								if($m3_rs_count[$mr_counter] != 0 && $duty_counter != $rs_max_duty){
//									$master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
//									$duty_counter++;
//									$m3_rs_count[$mr_counter]--;
//									$m3_flag=false;
//									$rs_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($rs_rand->id,$rs_last))
//										$rs_last[$rs_rand->id] = $tdKey;
//
//								}
//							}
//
//							if($duty_counter != $rs_max_duty && $aft_share!=0){
//
//
//									if($a3_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty){
//										$master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
//										$duty_counter++;
//										$a3_rs_count[$aft_counter]--;
//										$a3_flag=false;
//										$rs_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($rs_rand->id,$rs_last))
//											$rs_last[$rs_rand->id] = $tdKey;
//
//									}
//
//							}

                        if ($duty_counter != $rs_max_duty && $m3_flag && !in_array($time_data->db_date, $ex_dates[$rs_rand->id])) {
                            if ($m3_rs_count[$mr_counter] != 0 && $duty_counter != $rs_max_duty) {
                                $master[$this->getDateTag($time_data->date)][0][0]["m3"][$rs_rand->name] = $rs_rand->id;
                                $duty_counter++;
                                $m3_rs_count[$mr_counter]--;
                                $rs_total_duty++;
                                $allocation++;
                                $mr_share--;
                                if (!array_key_exists($rs_rand->id, $rs_last))
                                    $rs_last[$rs_rand->id] = $tdKey;

                            }
                        }

                        if ($duty_counter != $rs_max_duty && $a3_flag && !in_array($time_data->db_date, $ex_dates[$rs_rand->id])) {
                            if ($a3_rs_count[$aft_counter] != 0 && $duty_counter != $rs_max_duty) {
                                $master[$this->getDateTag($time_data->date)][0][1]["a3"][$rs_rand->name] = $rs_rand->id;
                                $duty_counter++;
                                $a3_rs_count[$aft_counter]--;
                                $rs_total_duty++;
                                $allocation++;
                                $aft_share--;
                                if (!array_key_exists($rs_rand->id, $rs_last))
                                    $rs_last[$rs_rand->id] = $tdKey;

                            }

                        }

                        $mr_counter++;
                        $aft_counter++;
                    }

                    $rs_shortage[$rs_rand->id] = $duty_counter;
                    if (!array_key_exists($rs_rand->id, $rs_last)) {
                        $rs_last[$rs_rand->id] = count($td);
                    }
                    if ($duty_counter <= $this->data["rs_max_duty"] - 1 || in_array($rs_rand, $RS_pri))
                        $rs_allowed[$rs_rand->id] = 0;

                }


                foreach ($a3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][0][0]["m3"], $master[$this->getDateTag($td[$j]->date)][0][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][0][1]["a3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rs_shortage[$bval] <= $this->data["rs_max_duty"] && !array_key_exists($bval, $rs_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][0][1]["a3"][$bkey] = $bval;
                                            $rs_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $a3_rs_count[$key]--;
                                            $rs_allowed[$bval]++;

                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($m3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][0][0]["m3"], $master[$this->getDateTag($td[$j]->date)][0][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][0][0]["m3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rs_shortage[$bval] <= $this->data["rs_max_duty"] && !array_key_exists($bval, $rs_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][0][0]["m3"][$bkey] = $bval;
                                            $rs_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $m3_rs_count[$key]--;
                                            $rs_allowed[$bval]++;


                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($a3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][0][1]["a3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($m3_rs_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][0][0]["m3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                $to_test = "";
                $final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs);
                $sum_min = PHP_INT_MAX;
                $master_copy = $master;
                $rs_shortage_copy = $rs_shortage;
                $rs_allowed_copy = $rs_allowed;
                $duty_ctr_str_rs = "";
                $gap_str_rs = "";
                set_time_limit(0);
                $words = array(array('0', '1', '2','3'), array('0', '1', '2','3'), array('0','1', '2', '3'));
                $combos = $this->combinations($words, 0);
                foreach ($combos as $pKey => $pVal) {
                    $c_arr = explode(" ", $pVal);
                    $master = $master_copy;
                    $rs_shortage = $rs_shortage_copy;
                    $rs_allowed = $rs_allowed_copy;
                    foreach ($RS as $rKey => $rVal) {
                        $master = $master_copy;
                        $rs_shortage = $rs_shortage_copy;
                        $rs_allowed = $rs_allowed_copy;
                        foreach ($RS as $allowKey => $alloVal) {
                            if ($rs_shortage[$alloVal->id] != 0) {
                                if (($allowKey+1) % ($rKey + 1) != 0)
                                    $rs_allowed[$alloVal->id] = $rs_allowed[$alloVal->id] + $c_arr[0];
                                else
                                    $rs_allowed[$alloVal->id] = $rs_allowed[$alloVal->id] + $c_arr[1];
                            } else {
                                $rs_allowed[$alloVal->id] = 0;
                            }
                        }
                        foreach (array_reverse($RS) as $rskey => $rsp) {
                            if ($rs_shortage[$rsp->id] <= $this->data["rs_max_duty"] - $c_arr[2] && !array_key_exists($rsp->id, $rs_ex_fac)) {
                                $pos = 1;

                                if (array_key_exists($rsp->id, $rs_pri_fac))
                                    $req = $rs_pri_fac[$rsp->id] - $rs_shortage[$rsp->id];
                                else {
                                    $req = $this->data["rs_max_duty"] - $rs_shortage[$rsp->id];
                                    if ($req == $this->data["rs_max_duty"]) {
                                        //$req = $this->data["rs_max_duty"] - 1;
                                    }
                                }


                                $req_counter = 0;

                                while (array_key_exists($rs_last[$rsp->id] - $pos, $td) && $req_counter != $req) {
                                    $got = 0;

                                    $date_tag = $td[$rs_last[$rsp->id] - $pos]->date;


                                    foreach (array_merge($master[$this->getDateTag($date_tag)][0][0]["m3"], $master[$this->getDateTag($date_tag)][0][1]["a3"]) as $pt => $idVal) {
                                        if ($got == 0 && $rs_allowed[$idVal] != 0 && !isset($master[$this->getDateTag($date_tag)][0][0]["m3"][$rsp->name]) && !array_key_exists($idVal, $rs_ex_fac)) {

                                            for ($j = $this->data["rs_max_duty"] + 4; $j > 0; $j--) {
                                                if ($got == 0)
                                                    if (array_key_exists($idVal, $rs_shortage) && !array_key_exists($rsp->name, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                                        if ($rs_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rs_allowed) && $rs_allowed[$idVal] != 0) {

                                                            if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][0][0]["m3"])) {
                                                                $master[$this->getDateTag($date_tag)][0][0]["m3"][$rsp->name] = $rsp->id;
                                                                unset($master[$this->getDateTag($date_tag)][0][0]["m3"][$pt]);
                                                                $rs_shortage[$idVal]--;
                                                                $rs_shortage[$rsp->id]++;
                                                                $req_counter++;
                                                                //echo $pt."---->".$rsp->name."------->".$date_tag."<br>";
                                                                $rs_allowed[$idVal]--;
                                                                $got++;
                                                            }

                                                        }
                                                    }

                                                if ($got == 0)
                                                    if (array_key_exists($idVal, $rs_shortage) && !array_key_exists($rsp->name, $master[$this->getDateTag($date_tag)][0][1]["a3"])) {
                                                        if ($rs_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rs_allowed) && $rs_allowed[$idVal] != 0) {

                                                            if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][0][1]["a3"])) {
                                                                $master[$this->getDateTag($date_tag)][0][1]["a3"][$rsp->name] = $rsp->id;
                                                                unset($master[$this->getDateTag($date_tag)][0][1]["a3"][$pt]);
                                                                $rs_shortage[$idVal]--;
                                                                $rs_shortage[$rsp->id]++;
                                                                $req_counter++;
                                                                //echo $pt . "---->" . $rsp->name . "------->" . $date_tag . "<br>";
                                                                $rs_allowed[$idVal]--;
                                                                $got++;
                                                            }
                                                        }
                                                    }
                                            }
                                        }
                                    }


                                    if ($got == 0) {
                                        //echo "<h3>Skipped {$date_tag}</h3><br>";
                                    }
                                    $pos++;
                                }
                            }

                        }


                        $max_arr = array();
                        $diff_array_rs = array();
                        $counter = 1;
                        $gap_str_rs = "";
                        $duty_arr_rs = array();
                        foreach ($RS as $rskey => $rsval) {

                            if (!array_key_exists($rsval->id, $diff_array_rs))
                                $diff_array_rs[$rsval->id] = array();
                            foreach ($td as $tdKey => $tdVal) {
                                foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m3"] as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }

                                foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m4"] as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }

                                foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a3"] as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }

                                foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a4"] as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }
                            }
                            $max = 0;
                            asort($diff_array_rs[$rsval->id]);
                            $diff_array_rs[$rsval->id] = array_values($diff_array_rs[$rsval->id]);
                            for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
                                $dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
                                if ($max < $dif) {
                                    $max = $dif;
                                }
                            }

                            if (!array_key_exists($rsval->id, $rs_ex_fac))
                                $max_arr[$rsval->id] = $max;
                            else
                                $max_arr[$rsval->id] = 0;

                            if ($max != 0)
                                $max--;
                            if ($max >= 3) {
                                $gap_str_rs .= "<tr><td>{$counter}</td><td>{$rsval->name}</td><td>{$max}</td></tr>";
                                $counter++;

                            }


                        }

                        $check_fg = "";
                        foreach ($RS as $rskey => $rsval) {
                            $last = 0;
                            $max = $max_arr[$rsval->id];
                            if ($max - 1 >= 3)
                                for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
                                    if (array_key_exists($i, $diff_array_rs[$rsval->id]) && array_key_exists($i + 1, $diff_array_rs[$rsval->id]))
                                        $dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
                                    else
                                        $dif = 0;

                                    if ($max == $dif) {
                                        if ($i + 1 < ceil(count($diff_array_rs[$rsval->id]) / 2)) {
                                            $last = $i + 1;
                                            for ($j = $i; $j >= 0; $j--) {
                                                if (array_key_exists($j, $diff_array_rs[$rsval->id]))
                                                    if (array_key_exists($diff_array_rs[$rsval->id][$j], $td)) {
                                                        if (array_key_exists($j, $diff_array_rs[$rsval->id])) {
                                                            if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                //														$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED ".$rsval->name]=-1;
                                                                unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$rsval->name]);
                                                                $rs_shortage[$rsval->id]--;
                                                                $gt = 0;
                                                                for ($m = 0; $m <= 2; $m++) {
                                                                    if ($gt == 0) {
                                                                        if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }


                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    for ($m = 0; $m <= 2; $m++) {
                                                                        if ($gt == 0) {
                                                                            if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }


                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }


                                                                if ($gt == 0) {
                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED " . $rsval->name] = -1;
                                                                }
                                                                unset($diff_array_rs[$rsval->id][$j]);
//

                                                            }
                                                        }
                                                        if (array_key_exists($j, $diff_array_rs[$rsval->id])) {
                                                            if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED ".$rsval->name]=-1;
                                                                unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$rsval->name]);
                                                                $rs_shortage[$rsval->id]--;
                                                                $gt = 0;
                                                                for ($m = 0; $m <= 2; $m++) {
                                                                    if ($gt == 0) {
                                                                        if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    for ($m = 0; $m <= 2; $m++) {
                                                                        if ($gt == 0) {
                                                                            if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED " . $rsval->name] = -1;
                                                                }
                                                                unset($diff_array_rs[$rsval->id][$j]);
                                                            }
                                                        }
                                                        if (array_key_exists($j, $diff_array_rs[$rsval->id])) {
                                                            if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED ".$rsval->name]=-1;
                                                                unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$rsval->name]);
                                                                $rs_shortage[$rsval->id]--;
                                                                $gt = 0;
                                                                for ($m = 0; $m <= 2; $m++) {
                                                                    if ($gt == 0) {
                                                                        if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    for ($m = 0; $m <= 2; $m++) {
                                                                        if ($gt == 0) {
                                                                            if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED " . $rsval->name] = -1;
                                                                }
                                                                unset($diff_array_rs[$rsval->id][$j]);
                                                            }
                                                        }
                                                        if (array_key_exists($j, $diff_array_rs[$rsval->id])) {
                                                            if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED ".$rsval->name]=-1;
                                                                unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$rsval->name]);
                                                                $rs_shortage[$rsval->id]--;
                                                                $gt = 0;
                                                                for ($m = 0; $m <= 2; $m++) {
                                                                    if ($gt == 0) {
                                                                        if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    for ($m = 0; $m <= 2; $m++) {
                                                                        if ($gt == 0) {
                                                                            if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }

                                                                                if ($gt == 0) {
                                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                        if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                            if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                                for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                    if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                        $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                        $rs_shortage[$fVal]++;
                                                                                                        $gt++;
                                                                                                        if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                            $diff_array_rs[$fVal] = array();
                                                                                                        $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }


                                                                if ($gt == 0) {
                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED " . $rsval->name] = -1;
                                                                }
                                                                unset($diff_array_rs[$rsval->id][$j]);
                                                            }
                                                        }
                                                    }
                                            }
                                        } else {
                                            for ($j = $i + 1; $j < count($diff_array_rs[$rsval->id]); $j++) {
                                                if (array_key_exists($diff_array_rs[$rsval->id][$j], $td)) {
                                                    if (array_key_exists($j, $diff_array_rs[$rsval->id]))
                                                        if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
//														$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED ".$rsval->name]=-1;
                                                            unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$rsval->name]);
                                                            $rs_shortage[$rsval->id]--;
                                                            $gt = 0;
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }


                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            if ($gt == 0) {
                                                                for ($m = 0; $m <= 2; $m++) {
                                                                    if ($gt == 0) {
                                                                        if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }


                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }


                                                            if ($gt == 0) {
                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m3"]["TO BE ADDED " . $rsval->name] = -1;
                                                            }
                                                            unset($diff_array_rs[$rsval->id][$j]);

                                                        }
                                                    if (array_key_exists($j, $diff_array_rs[$rsval->id]))
                                                        if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                            //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED ".$rsval->name]=-1;
                                                            unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$rsval->name]);
                                                            $rs_shortage[$rsval->id]--;
                                                            $gt = 0;
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            if ($gt == 0) {
                                                                for ($m = 0; $m <= 2; $m++) {
                                                                    if ($gt == 0) {
                                                                        if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            if ($gt == 0) {
                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][0]["m4"]["TO BE ADDED " . $rsval->name] = -1;
                                                            }
                                                            unset($diff_array_rs[$rsval->id][$j]);
                                                        }
                                                    if (array_key_exists($j, $diff_array_rs[$rsval->id]))
                                                        if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                            //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED ".$rsval->name]=-1;
                                                            unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$rsval->name]);
                                                            $rs_shortage[$rsval->id]--;
                                                            $gt = 0;
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            if ($gt == 0) {
                                                                for ($m = 0; $m <= 2; $m++) {
                                                                    if ($gt == 0) {
                                                                        if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            if ($gt == 0) {
                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a3"]["TO BE ADDED " . $rsval->name] = -1;
                                                            }
                                                            unset($diff_array_rs[$rsval->id][$j]);
                                                        }
                                                    if (array_key_exists($j, $diff_array_rs[$rsval->id]))
                                                        if (array_key_exists($rsval->name, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                            //$master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED ".$rsval->name]=-1;
                                                            unset($master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$rsval->name]);
                                                            $rs_shortage[$rsval->id]--;
                                                            $gt = 0;
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rs[$rsval->id][$j]) - $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) - $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                        for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                $rs_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                    $diff_array_rs[$fVal] = array();
                                                                                                $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            if ($gt == 0) {
                                                                for ($m = 0; $m <= 2; $m++) {
                                                                    if ($gt == 0) {
                                                                        if (array_key_exists(($diff_array_rs[$rsval->id][$j]) + $m, $td)) {
                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][0]["m4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a3"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }

                                                                            if ($gt == 0) {
                                                                                foreach ($master[$this->getDateTag($td[($diff_array_rs[$rsval->id][$j]) + $m]->date)][0][1]["a4"] as $fKey => $fVal)
                                                                                    if (array_key_exists($fVal, $rs_shortage) && !array_key_exists($fVal, $rs_ex_fac))
                                                                                        if (true || array_key_exists($fVal, $diff_array_rs))
                                                                                            for ($x = 0; $x <= $this->data["rs_max_duty"] + 1; $x++)
                                                                                                if ($gt == 0 && $rs_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"])) {
                                                                                                    $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"][$fKey] = $fVal;
                                                                                                    $rs_shortage[$fVal]++;
                                                                                                    $gt++;
                                                                                                    if (!array_key_exists($fVal, $diff_array_rs))
                                                                                                        $diff_array_rs[$fVal] = array();
                                                                                                    $diff_array_rs[$fVal][] = $diff_array_rs[$rsval->id][$j];
                                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }


                                                            if ($gt == 0) {
                                                                $master[$this->getDateTag($td[$diff_array_rs[$rsval->id][$j]]->date)][0][1]["a4"]["TO BE ADDED " . $rsval->name] = -1;
                                                            }
                                                            unset($diff_array_rs[$rsval->id][$j]);
                                                        }
                                                }
                                            }
                                        }


                                    }

                                }
                        }

                        $sh_cnt = 0;
                        $rs_id_name_pair = array();
                        foreach ($RS as $rsval) {
                            $rs_id_name_pair[$rsval->id] = $rsval->name;
                            asort($diff_array_rs[$rsval->id]);
                            $diff_array_rs[$rsval->id] = array_values($diff_array_rs[$rsval->id]);
                            if (!array_key_exists(count($diff_array_rs[$rsval->id]), $duty_arr_rs)) {
                                $duty_arr_rs[count($diff_array_rs[$rsval->id])] = array();
                            }

                            $duty_arr_rs[count($diff_array_rs[$rsval->id])][] = $rsval->id;
                            $sh_cnt += $rs_shortage[$rsval->id];
                        }

                        $rs_fac_duty = array();
                        foreach ($duty_arr_rs as $key => $val) {
                            $cnt = count($val);
                            $rs_fac_duty[$key] = $cnt;
                        }
                        ksort($rs_fac_duty);

                        $txt = "";
                        $txt_ctr = 0;
                        foreach ($rs_fac_duty as $dty_cnt => $num_fac) {
                            foreach ($duty_arr_rs[$dty_cnt] as $fac_id) {
                                if (count($diff_array_rs[$fac_id]) < $this->data["rs_max_duty"] && !array_key_exists($fac_id, $rs_ex_fac)) {
                                    $req = $this->data["rs_max_duty"] - count($diff_array_rs[$fac_id]) - 1;
                                    $rs_flg = 0;
                                    for ($b = 0; $b < $req; $b++) {
                                        $rs_flg = 0;
                                        if ($rs_flg == 0 && $req > 0) {
                                            for ($i = 0; $i <= 2; $i++) {
                                                //$rs_flg=0;
                                                if ($req > 0 && $rs_flg == 0) {
                                                    asort($diff_array_rs[$fac_id]);
                                                    $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                    if (array_key_exists(0, $diff_array_rs[$fac_id])) {
                                                        $first = $diff_array_rs[$fac_id][0];
                                                        if (array_key_exists($first - $i, $td)) {
                                                            foreach ($master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"] as $asKey => $asVal) {
                                                                if (!in_array($fac_id, $master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"]) && $rs_flg == 0) {
                                                                    for ($x = $this->data["rs_max_duty"] + 2; $x >= $this->data["rs_max_duty"]; $x--) {
                                                                        if ($rs_flg == 0 && count($diff_array_rs[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"])) {
                                                                            $txt_ctr++;
                                                                            $txt .= $txt_ctr . ")(First) Unset-->" . $asKey . "(" . count($diff_array_rs[$asVal]) . ") Set--->" . $rs_id_name_pair[$fac_id] . "(" . count($diff_array_rs[$fac_id]) . ")<br>";
                                                                            $master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"][$rs_id_name_pair[$fac_id]] = $fac_id;
                                                                            $diff_array_rs[$fac_id][] = $first - $i;
                                                                            $rs_shortage[$fac_id]++;
                                                                            asort($diff_array_rs[$fac_id]);
                                                                            $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                                            unset($diff_array_rs[$asVal][array_search($first - $i, $diff_array_rs[$asVal])]);
                                                                            asort($diff_array_rs[$asVal]);
                                                                            $diff_array_rs[$asVal] = array_values($diff_array_rs[$asVal]);
                                                                            $rs_shortage[$asVal]--;
                                                                            unset($master[$this->getDateTag($td[$first - $i]->date)][0][0]["m3"][$asKey]);
                                                                            $req--;
                                                                            $rs_flg++;


                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        if ($rs_flg == 0 && $req > 0) {
                                            for ($i = 0; $i <= 2; $i++) {
                                                //$rs_flg=0;
                                                if ($req > 0 && $rs_flg == 0) {
                                                    asort($diff_array_rs[$fac_id]);
                                                    if (array_key_exists(count($diff_array_rs[$fac_id]) - 1, $diff_array_rs[$fac_id])) {
                                                        $last = $diff_array_rs[$fac_id][count($diff_array_rs[$fac_id]) - 1];
                                                        if (array_key_exists($last + $i, $td)) {
                                                            foreach ($master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"] as $asKey => $asVal) {
                                                                if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"]) && $rs_flg == 0) {
                                                                    for ($x = $this->data["rs_max_duty"] + 2; $x >= $this->data["rs_max_duty"]; $x--) {
                                                                        if ($rs_flg == 0 && count($diff_array_rs[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"])) {
                                                                            $txt_ctr++;
                                                                            $txt .= $txt_ctr . ")(Last) Unset-->" . $asKey . "(" . count($diff_array_rs[$asVal]) . ") Set--->" . $rs_id_name_pair[$fac_id] . "(" . count($diff_array_rs[$fac_id]) . ")<br>";
                                                                            $master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"][$rs_id_name_pair[$fac_id]] = $fac_id;
                                                                            $diff_array_rs[$fac_id][] = $last + $i;
                                                                            $rs_shortage[$fac_id]++;
                                                                            asort($diff_array_rs[$fac_id]);
                                                                            $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                                            unset($diff_array_rs[$asVal][array_search($last + $i, $diff_array_rs[$asVal])]);
                                                                            $diff_array_rs[$asVal] = array_values($diff_array_rs[$asVal]);
                                                                            asort($diff_array_rs[$asVal]);
                                                                            $rs_shortage[$asVal]--;
                                                                            unset($master[$this->getDateTag($td[$last + $i]->date)][0][0]["m3"][$asKey]);
                                                                            $req--;
                                                                            $rs_flg++;


                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        if ($rs_flg == 0 && $req > 0) {
                                            for ($i = 0; $i <= 2; $i++) {
                                                //$rs_flg=0;
                                                if ($req > 0 && $rs_flg == 0) {
                                                    asort($diff_array_rs[$fac_id]);
                                                    $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                    if (array_key_exists(0, $diff_array_rs[$fac_id])) {
                                                        $first = $diff_array_rs[$fac_id][0];
                                                        if (array_key_exists($first - $i, $td)) {
                                                            foreach ($master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"] as $asKey => $asVal) {
                                                                if (!in_array($fac_id, $master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"]) && $rs_flg == 0) {
                                                                    for ($x = $this->data["rs_max_duty"] + 2; $x >= $this->data["rs_max_duty"]; $x--) {
                                                                        if ($rs_flg == 0 && count($diff_array_rs[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"])) {
                                                                            $txt_ctr++;
                                                                            $txt .= $txt_ctr . ")(First) Unset-->" . $asKey . "(" . count($diff_array_rs[$asVal]) . ") Set--->" . $rs_id_name_pair[$fac_id] . "(" . count($diff_array_rs[$fac_id]) . ")<br>";
                                                                            $master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"][$rs_id_name_pair[$fac_id]] = $fac_id;
                                                                            $diff_array_rs[$fac_id][] = $first - $i;
                                                                            $rs_shortage[$fac_id]++;
                                                                            asort($diff_array_rs[$fac_id]);
                                                                            $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                                            unset($diff_array_rs[$asVal][array_search($first - $i, $diff_array_rs[$asVal])]);
                                                                            asort($diff_array_rs[$asVal]);
                                                                            $diff_array_rs[$asVal] = array_values($diff_array_rs[$asVal]);
                                                                            $rs_shortage[$asVal]--;
                                                                            unset($master[$this->getDateTag($td[$first - $i]->date)][0][1]["a3"][$asKey]);
                                                                            $req--;
                                                                            $rs_flg++;


                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        if ($rs_flg == 0 && $req > 0) {
                                            for ($i = 0; $i <= 2; $i++) {
                                                //$rs_flg=0;
                                                if ($req > 0 && $rs_flg == 0) {
                                                    asort($diff_array_rs[$fac_id]);
                                                    if (array_key_exists(count($diff_array_rs[$fac_id]) - 1, $diff_array_rs[$fac_id])) {
                                                        $last = $diff_array_rs[$fac_id][count($diff_array_rs[$fac_id]) - 1];
                                                        if (array_key_exists($last + $i, $td)) {
                                                            foreach ($master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"] as $asKey => $asVal) {
                                                                if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"]) && $rs_flg == 0) {
                                                                    for ($x = $this->data["rs_max_duty"] + 2; $x >= $this->data["rs_max_duty"]; $x--) {
                                                                        if ($rs_flg == 0 && count($diff_array_rs[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"])) {
                                                                            $txt_ctr++;
                                                                            $txt .= $txt_ctr . ")(Last) Unset-->" . $asKey . "(" . count($diff_array_rs[$asVal]) . ") Set--->" . $rs_id_name_pair[$fac_id] . "(" . count($diff_array_rs[$fac_id]) . ")<br>";
                                                                            $master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"][$rs_id_name_pair[$fac_id]] = $fac_id;
                                                                            $diff_array_rs[$fac_id][] = $last + $i;
                                                                            $rs_shortage[$fac_id]++;
                                                                            asort($diff_array_rs[$fac_id]);
                                                                            $diff_array_rs[$fac_id] = array_values($diff_array_rs[$fac_id]);
                                                                            unset($diff_array_rs[$asVal][array_search($last + $i, $diff_array_rs[$asVal])]);
                                                                            $diff_array_rs[$asVal] = array_values($diff_array_rs[$asVal]);
                                                                            asort($diff_array_rs[$asVal]);
                                                                            $rs_shortage[$asVal]--;
                                                                            unset($master[$this->getDateTag($td[$last + $i]->date)][0][1]["a3"][$asKey]);
                                                                            $req--;
                                                                            $rs_flg++;


                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }


                                    }
                                }
                            }
                        }


                        $max_arr = array();
                        $diff_array_rs = array();
                        $counter = 1;
                        $gap_str_rs = "";
                        $duty_arr_rs = array();
                        foreach ($RS as $rskey => $rsval) {

                            if (!array_key_exists($rsval->id, $diff_array_rs))
                                $diff_array_rs[$rsval->id] = array();
                            foreach ($td as $tdKey => $tdVal) {
                                foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m3"] as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }

                                foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][0]["m4"] as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }

                                foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a3"] as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }

                                foreach ($master[$this->getDateTag($td[$tdKey]->date)][0][1]["a4"] as $asKey => $asVal) {
                                    if ($rsval->id == $asVal) {
                                        $diff_array_rs[$rsval->id][] = $tdKey;
                                    }
                                }
                            }
                            $max = 0;
                            asort($diff_array_rs[$rsval->id]);
                            $diff_array_rs[$rsval->id] = array_values($diff_array_rs[$rsval->id]);
                            for ($i = 0; $i < count($diff_array_rs[$rsval->id]) - 1; $i++) {
                                $dif = abs($diff_array_rs[$rsval->id][$i] - $diff_array_rs[$rsval->id][$i + 1]);
                                if ($max < $dif) {
                                    $max = $dif;
                                }
                            }

                            $max_arr[$rsval->id] = $max;


                            if ($max != 0)
                                $max--;
                            if ($max >= 3) {
                                $gap_str_rs .= "<tr><td>{$counter}</td><td>{$rsval->name}</td><td>{$max}</td></tr>";
                                $counter++;

                            }


                        }


                        $sh_cnt = 0;
                        $duty_arr_rs = array();
                        foreach ($RS as $rsval) {
                            $rs_id_name_pair[$rsval->id] = $rsval->name;
                            asort($diff_array_rs[$rsval->id]);
                            $diff_array_rs[$rsval->id] = array_values($diff_array_rs[$rsval->id]);
                            if (!array_key_exists(count($diff_array_rs[$rsval->id]), $duty_arr_rs)) {
                                $duty_arr_rs[count($diff_array_rs[$rsval->id])] = array();
                            }

                            $duty_arr_rs[count($diff_array_rs[$rsval->id])][] = $rsval->id;
                            $sh_cnt += $rs_shortage[$rsval->id];
                        }

                        $duty_ctr_str_rs = "";
                        $rs_sum_duty = 0;
                        foreach ($duty_arr_rs as $key => $val) {
                            $ct = count($val);
                            $duty_ctr_str_rs .= "<tr><td>{$ct}</td><td>{$key}</td></tr>";
                            $rs_sum_duty += $ct * $key;
                        }
                        $duty_ctr_str_rs .= "<tr><td>Total</td><td>{$rs_sum_duty}</td></tr>";
                        if ($rs_sum_duty != $this->data["rs_count"]) {
                            $duty_ctr_str_rs .= "<tr  style='background:red;' class='blink' ><td>Difference</td><td>{($this->data['rs_count']-$rs_sum_duty)}</td></tr>";
                        }

                        if ($counter + count($duty_arr_rs) <= $sum_min) {
                            $sum_min = $counter + count($duty_arr_rs);
                            $final_arr = array($master, $gap_str_rs, $duty_ctr_str_rs, count($duty_arr_rs), $counter, $sum_min, $c_arr[0], $c_arr[1], $c_arr[2]);
                            $to_test .= $rs_one . " " . $rs_two . " " . $rs_three . " " . $rs_four . " -> " . $sum_min . "<br>";
                        }
                    }
                }
                $master = $final_arr[0];
                $gap_str_rs = $final_arr[1];
                $duty_ctr_str_rs = $final_arr[2];

//--------------------------------------------------------------------------------------------------------------------------------------------


                foreach ($a4_rs_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][0][1]["a3"] as $k => $v) {
                        if ($ctr != $this->data["a4_rs_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][0][1]["a4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][0][1]["a3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach ($m4_rs_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][0][0]["m3"] as $k => $v) {
                        if ($ctr != $this->data["m4_rs_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][0][0]["m4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][0][0]["m3"][$k]);
                            $ctr++;
                        }
                    }
                }


            }


//-------------------------------------------------------RLS-----------------------------------------------------------
            if ($req_flag == "ls" || $gen_flag) {
                $rls_allowed = array();
                $rls_shortage = array();
                $rls_last = array();

                $allocation = 0;
                $rls_total_duty = 0;
                $rls_index = 0;

                $rls_pri_fac = array();
                $rls_ex_fac = array();
                foreach ($RLS as $rls_rand) {
                    if (!array_key_exists($rls_rand->id, $ex_dates)) {
                        $ex_dates[$rls_rand->id] = array();
                    } else {
                        $rls_ex_fac[$rls_rand->id] = $rls_rand->id;
                    }
                    $rls_allowed[$rls_rand->id] = 0;


                    if ($rls_rand->priority && $rls_priority_duty >= 1 && $rls_priority_duty < $this->data["rls_max_duty"]) {
                        $rls_max_duty = $rls_priority_duty;
                        $rls_pri_fac[$rls_rand->id] = $rls_priority_duty;
                    } else
                        $rls_max_duty = $this->data["rls_max_duty"];
                    $duty_counter = 0;
                    $mr_counter = 0;
                    $aft_counter = 0;
                    $rls_index++;
                    $aft_share = round($rls_max_duty * 25 / 100);
                    $mr_share = $rls_max_duty - $aft_share;
                    foreach ($td as $tdKey => $time_data) {

                        $m3_flag = true;
                        $a3_flag = true;
//							if($duty_counter != $rls_max_duty && $mr_share!=0){
//								if($m3_rls_count[$mr_counter] != 0 && $duty_counter != $rls_max_duty){
//									$master[$this->getDateTag($time_data->date)][1][0]["m3"][$rls_rand->name] = $rls_rand->id;
//									$duty_counter++;
//									$m3_rls_count[$mr_counter]--;
//									$m3_flag=false;
//									$rls_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($rls_rand->id,$rls_last))
//										$rls_last[$rls_rand->id] = $tdKey;
//
//								}
//							}
//
//							if($duty_counter != $rls_max_duty && $aft_share!=0){
//
//
//									if($a3_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty){
//										$master[$this->getDateTag($time_data->date)][1][1]["a3"][$rls_rand->name] = $rls_rand->id;
//										$duty_counter++;
//										$a3_rls_count[$aft_counter]--;
//										$a3_flag=false;
//										$rls_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($rls_rand->id,$rls_last))
//											$rls_last[$rls_rand->id] = $tdKey;
//
//									}
//
//							}

                        if ($duty_counter != $rls_max_duty && $m3_flag && !in_array($time_data->db_date, $ex_dates[$rls_rand->id])) {
                            if ($m3_rls_count[$mr_counter] != 0 && $duty_counter != $rls_max_duty) {
                                $master[$this->getDateTag($time_data->date)][1][0]["m3"][$rls_rand->name] = $rls_rand->id;
                                $duty_counter++;
                                $m3_rls_count[$mr_counter]--;
                                $rls_total_duty++;
                                $allocation++;
                                $mr_share--;
                                if (!array_key_exists($rls_rand->id, $rls_last))
                                    $rls_last[$rls_rand->id] = $tdKey;

                            }
                        }

                        if ($duty_counter != $rls_max_duty && $a3_flag && !in_array($time_data->db_date, $ex_dates[$rls_rand->id])) {
                            if ($a3_rls_count[$aft_counter] != 0 && $duty_counter != $rls_max_duty) {
                                $master[$this->getDateTag($time_data->date)][1][1]["a3"][$rls_rand->name] = $rls_rand->id;
                                $duty_counter++;
                                $a3_rls_count[$aft_counter]--;
                                $rls_total_duty++;
                                $allocation++;
                                $aft_share--;
                                if (!array_key_exists($rls_rand->id, $rls_last))
                                    $rls_last[$rls_rand->id] = $tdKey;

                            }

                        }

                        $mr_counter++;
                        $aft_counter++;
                    }

                    $rls_shortage[$rls_rand->id] = $duty_counter;
                    if (!array_key_exists($rls_rand->id, $rls_last)) {
                        $rls_last[$rls_rand->id] = count($td);
                    }
                    if ($duty_counter <= $this->data["rls_max_duty"] - 1 || in_array($rls_rand, $RLS_pri))
                        $rls_allowed[$rls_rand->id] = 0;

                }


                foreach ($a3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][1][0]["m3"], $master[$this->getDateTag($td[$j]->date)][1][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][1][1]["a3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rls_shortage[$bval] <= $this->data["rls_max_duty"] && !array_key_exists($bval, $rls_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][1][1]["a3"][$bkey] = $bval;
                                            $rls_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $a3_rls_count[$key]--;
                                            $rls_allowed[$bval]++;

                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($m3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][1][0]["m3"], $master[$this->getDateTag($td[$j]->date)][1][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][1][0]["m3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $rls_shortage[$bval] <= $this->data["rls_max_duty"] && !array_key_exists($bval, $rls_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][1][0]["m3"][$bkey] = $bval;
                                            $rls_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $m3_rls_count[$key]--;
                                            $rls_allowed[$bval]++;


                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($a3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][1][1]["a3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($m3_rls_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][1][0]["m3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                $to_test = "";
                $final_arr = array($master, $gap_str_rls, $duty_ctr_str_rls);
                $sum_min = PHP_INT_MAX;
                $master_copy = $master;
                $rls_shortage_copy = $rls_shortage;
                $rls_allowed_cpy = $rls_allowed;
                $duty_ctr_str_rls = "";
                $gap_str_rls = "";
                set_time_limit(0);

                foreach ($RLS as $allowKey => $alloVal) {
                    if ($rls_shortage[$alloVal->id] != 0) {
                        if (($allowKey+1) % ($rls_four) != 0)
                            $rls_allowed[$alloVal->id] = $rls_allowed[$alloVal->id] + $rls_one;
                        else
                            $rls_allowed[$alloVal->id] = $rls_allowed[$alloVal->id] + $rls_two;
                    } else {
                        $rls_allowed[$alloVal->id] = 0;
                    }
                }


                foreach (array_reverse($RLS) as $rlskey => $rlsp) {
                    if ($rls_shortage[$rlsp->id] <= $this->data["rls_max_duty"] - $rls_three && !array_key_exists($rlsp->id, $rls_ex_fac)) {
                        $pos = 1;

                        if (array_key_exists($rlsp->id, $rls_pri_fac))
                            $req = $rls_pri_fac[$rlsp->id] - $rls_shortage[$rlsp->id];
                        else {
                            $req = $this->data["rls_max_duty"] - $rls_shortage[$rlsp->id];
                            if ($req == $this->data["rls_max_duty"]) {
                                //$req = $this->data["rls_max_duty"] - 1;
                            }
                        }


                        $req_counter = 0;

                        while (array_key_exists($rls_last[$rlsp->id] - $pos, $td) && $req_counter != $req) {
                            $got = 0;

                            $date_tag = $td[$rls_last[$rlsp->id] - $pos]->date;


                            foreach (array_merge($master[$this->getDateTag($date_tag)][1][0]["m3"], $master[$this->getDateTag($date_tag)][1][1]["a3"]) as $pt => $idVal) {
                                if ($got == 0 && $rls_allowed[$idVal] != 0 && !isset($master[$this->getDateTag($date_tag)][1][0]["m3"][$rlsp->name]) && !array_key_exists($idVal, $rls_ex_fac)) {

                                    for ($j = $this->data["rls_max_duty"] + 4; $j > 0; $j--) {
                                        if ($got == 0)
                                            if (array_key_exists($idVal, $rls_shortage) && !array_key_exists($rlsp->name, $master[$this->getDateTag($date_tag)][1][0]["m3"])) {
                                                if ($rls_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rls_allowed) && $rls_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][1][0]["m3"])) {
                                                        $master[$this->getDateTag($date_tag)][1][0]["m3"][$rlsp->name] = $rlsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][1][0]["m3"][$pt]);
                                                        $rls_shortage[$idVal]--;
                                                        $rls_shortage[$rlsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt."---->".$rlsp->name."------->".$date_tag."<br>";
                                                        $rls_allowed[$idVal]--;
                                                        $got++;
                                                    }

                                                }
                                            }

                                        if ($got == 0)
                                            if (array_key_exists($idVal, $rls_shortage) && !array_key_exists($rlsp->name, $master[$this->getDateTag($date_tag)][1][1]["a3"])) {
                                                if ($rls_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $rls_allowed) && $rls_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][1][1]["a3"])) {
                                                        $master[$this->getDateTag($date_tag)][1][1]["a3"][$rlsp->name] = $rlsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][1][1]["a3"][$pt]);
                                                        $rls_shortage[$idVal]--;
                                                        $rls_shortage[$rlsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt . "---->" . $rlsp->name . "------->" . $date_tag . "<br>";
                                                        $rls_allowed[$idVal]--;
                                                        $got++;
                                                    }
                                                }
                                            }
                                    }
                                }
                            }


                            if ($got == 0) {
                                //echo "<h3>Skipped {$date_tag}</h3><br>";
                            }
                            $pos++;
                        }
                    }

                }


                $max_arr = array();
                $diff_array_rls = array();
                $counter = 1;
                $gap_str_rls = "";
                $duty_arr_rls = array();
                foreach ($RLS as $rlskey => $rlsval) {

                    if (!array_key_exists($rlsval->id, $diff_array_rls))
                        $diff_array_rls[$rlsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][0]["m3"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][0]["m4"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][1]["a3"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][1]["a4"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_rls[$rlsval->id]);
                    $diff_array_rls[$rlsval->id] = array_values($diff_array_rls[$rlsval->id]);
                    for ($i = 0; $i < count($diff_array_rls[$rlsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_rls[$rlsval->id][$i] - $diff_array_rls[$rlsval->id][$i + 1]);
                        if ($max < $dif) {
                            $max = $dif;
                        }
                    }

                    if (!array_key_exists($rlsval->id, $rls_ex_fac))
                        $max_arr[$rlsval->id] = $max;
                    else
                        $max_arr[$rlsval->id] = 0;

                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_rls .= "<tr><td>{$counter}</td><td>{$rlsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }


                }

                $check_fg = "";
                foreach ($RLS as $rlskey => $rlsval) {
                    $last = 0;
                    $max = $max_arr[$rlsval->id];
                    if ($max - 1 >= 3)
                        for ($i = 0; $i < count($diff_array_rls[$rlsval->id]) - 1; $i++) {
                            if (array_key_exists($i, $diff_array_rls[$rlsval->id]) && array_key_exists($i + 1, $diff_array_rls[$rlsval->id]))
                                $dif = abs($diff_array_rls[$rlsval->id][$i] - $diff_array_rls[$rlsval->id][$i + 1]);
                            else
                                $dif = 0;

                            if ($max == $dif) {
                                if ($i + 1 < ceil(count($diff_array_rls[$rlsval->id]) / 2)) {
                                    $last = $i + 1;
                                    for ($j = $i; $j >= 0; $j--) {
                                        if (array_key_exists($j, $diff_array_rls[$rlsval->id]))
                                            if (array_key_exists($diff_array_rls[$rlsval->id][$j], $td)) {
                                                if (array_key_exists($j, $diff_array_rls[$rlsval->id])) {
                                                    if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                        //														$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"]["TO BE ADDED ".$rlsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$rlsval->name]);
                                                        $rls_shortage[$rlsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }


                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"]["TO BE ADDED " . $rlsval->name] = -1;
                                                        }
                                                        unset($diff_array_rls[$rlsval->id][$j]);
//

                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_rls[$rlsval->id])) {
                                                    if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"]["TO BE ADDED ".$rlsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$rlsval->name]);
                                                        $rls_shortage[$rlsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"]["TO BE ADDED " . $rlsval->name] = -1;
                                                        }
                                                        unset($diff_array_rls[$rlsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_rls[$rlsval->id])) {
                                                    if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"]["TO BE ADDED ".$rlsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$rlsval->name]);
                                                        $rls_shortage[$rlsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"]["TO BE ADDED " . $rlsval->name] = -1;
                                                        }
                                                        unset($diff_array_rls[$rlsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_rls[$rlsval->id])) {
                                                    if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"]["TO BE ADDED ".$rlsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$rlsval->name]);
                                                        $rls_shortage[$rlsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                        for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                                $rls_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                    $diff_array_rls[$fVal] = array();
                                                                                                $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"]["TO BE ADDED " . $rlsval->name] = -1;
                                                        }
                                                        unset($diff_array_rls[$rlsval->id][$j]);
                                                    }
                                                }
                                            }
                                    }
                                } else {
                                    for ($j = $i + 1; $j < count($diff_array_rls[$rlsval->id]); $j++) {
                                        if (array_key_exists($diff_array_rls[$rlsval->id][$j], $td)) {
                                            if (array_key_exists($j, $diff_array_rls[$rlsval->id]))
                                                if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
//														$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"]["TO BE ADDED ".$rlsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$rlsval->name]);
                                                    $rls_shortage[$rlsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }


                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m3"]["TO BE ADDED " . $rlsval->name] = -1;
                                                    }
                                                    unset($diff_array_rls[$rlsval->id][$j]);

                                                }
                                            if (array_key_exists($j, $diff_array_rls[$rlsval->id]))
                                                if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"]["TO BE ADDED ".$rlsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$rlsval->name]);
                                                    $rls_shortage[$rlsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][0]["m4"]["TO BE ADDED " . $rlsval->name] = -1;
                                                    }
                                                    unset($diff_array_rls[$rlsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_rls[$rlsval->id]))
                                                if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"]["TO BE ADDED ".$rlsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$rlsval->name]);
                                                    $rls_shortage[$rlsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a3"]["TO BE ADDED " . $rlsval->name] = -1;
                                                    }
                                                    unset($diff_array_rls[$rlsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_rls[$rlsval->id]))
                                                if (array_key_exists($rlsval->name, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"]["TO BE ADDED ".$rlsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$rlsval->name]);
                                                    $rls_shortage[$rlsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) - $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                        $rls_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_rls))
                                                                                            $diff_array_rls[$fVal] = array();
                                                                                        $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_rls[$rlsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_rls[$rlsval->id][$j]) + $m]->date)][1][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $rls_shortage) && !array_key_exists($fVal, $rls_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_rls))
                                                                                    for ($x = 0; $x <= $this->data["rls_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $rls_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"][$fKey] = $fVal;
                                                                                            $rls_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_rls))
                                                                                                $diff_array_rls[$fVal] = array();
                                                                                            $diff_array_rls[$fVal][] = $diff_array_rls[$rlsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_rls[$rlsval->id][$j]]->date)][1][1]["a4"]["TO BE ADDED " . $rlsval->name] = -1;
                                                    }
                                                    unset($diff_array_rls[$rlsval->id][$j]);
                                                }
                                        }
                                    }
                                }


                            }

                        }
                }

                $sh_cnt = 0;
                $rls_id_name_pair = array();
                foreach ($RLS as $rlsval) {
                    $rls_id_name_pair[$rlsval->id] = $rlsval->name;
                    asort($diff_array_rls[$rlsval->id]);
                    $diff_array_rls[$rlsval->id] = array_values($diff_array_rls[$rlsval->id]);
                    if (!array_key_exists(count($diff_array_rls[$rlsval->id]), $duty_arr_rls)) {
                        $duty_arr_rls[count($diff_array_rls[$rlsval->id])] = array();
                    }

                    $duty_arr_rls[count($diff_array_rls[$rlsval->id])][] = $rlsval->id;
                    $sh_cnt += $rls_shortage[$rlsval->id];
                }

                $rls_fac_duty = array();
                foreach ($duty_arr_rls as $key => $val) {
                    $cnt = count($val);
                    $rls_fac_duty[$key] = $cnt;
                }
                ksort($rls_fac_duty);

                $txt = "";
                $txt_ctr = 0;
                foreach ($rls_fac_duty as $dty_cnt => $num_fac) {
                    foreach ($duty_arr_rls[$dty_cnt] as $fac_id) {
                        if (count($diff_array_rls[$fac_id]) < $this->data["rls_max_duty"] && !array_key_exists($fac_id, $rls_ex_fac)) {
                            $req = $this->data["rls_max_duty"] - count($diff_array_rls[$fac_id]) - 1;
                            $rls_flg = 0;
                            for ($b = 0; $b < $req; $b++) {
                                $rls_flg = 0;
                                if ($rls_flg == 0 && $req > 0) {
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rls_flg=0;
                                        if ($req > 0 && $rls_flg == 0) {
                                            asort($diff_array_rls[$fac_id]);
                                            $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                            if (array_key_exists(0, $diff_array_rls[$fac_id])) {
                                                $firlst = $diff_array_rls[$fac_id][0];
                                                if (array_key_exists($firlst - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"]) && $rls_flg == 0) {
                                                            for ($x = $this->data["rls_max_duty"] + 2; $x >= $this->data["rls_max_duty"]; $x--) {
                                                                if ($rls_flg == 0 && count($diff_array_rls[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt .= $txt_ctr . ")(Firlst) Unset-->" . $asKey . "(" . count($diff_array_rls[$asVal]) . ") Set--->" . $rls_id_name_pair[$fac_id] . "(" . count($diff_array_rls[$fac_id]) . ")<br>";
                                                                    $master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"][$rls_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rls[$fac_id][] = $firlst - $i;
                                                                    $rls_shortage[$fac_id]++;
                                                                    asort($diff_array_rls[$fac_id]);
                                                                    $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                                                    unset($diff_array_rls[$asVal][array_search($firlst - $i, $diff_array_rls[$asVal])]);
                                                                    asort($diff_array_rls[$asVal]);
                                                                    $diff_array_rls[$asVal] = array_values($diff_array_rls[$asVal]);
                                                                    $rls_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$firlst - $i]->date)][1][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $rls_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if ($rls_flg == 0 && $req > 0) {
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rls_flg=0;
                                        if ($req > 0 && $rls_flg == 0) {
                                            asort($diff_array_rls[$fac_id]);
                                            if (array_key_exists(count($diff_array_rls[$fac_id]) - 1, $diff_array_rls[$fac_id])) {
                                                $last = $diff_array_rls[$fac_id][count($diff_array_rls[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"]) && $rls_flg == 0) {
                                                            for ($x = $this->data["rls_max_duty"] + 2; $x >= $this->data["rls_max_duty"]; $x--) {
                                                                if ($rls_flg == 0 && count($diff_array_rls[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt .= $txt_ctr . ")(Last) Unset-->" . $asKey . "(" . count($diff_array_rls[$asVal]) . ") Set--->" . $rls_id_name_pair[$fac_id] . "(" . count($diff_array_rls[$fac_id]) . ")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"][$rls_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rls[$fac_id][] = $last + $i;
                                                                    $rls_shortage[$fac_id]++;
                                                                    asort($diff_array_rls[$fac_id]);
                                                                    $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                                                    unset($diff_array_rls[$asVal][array_search($last + $i, $diff_array_rls[$asVal])]);
                                                                    $diff_array_rls[$asVal] = array_values($diff_array_rls[$asVal]);
                                                                    asort($diff_array_rls[$asVal]);
                                                                    $rls_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][1][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $rls_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if ($rls_flg == 0 && $req > 0) {
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rls_flg=0;
                                        if ($req > 0 && $rls_flg == 0) {
                                            asort($diff_array_rls[$fac_id]);
                                            $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                            if (array_key_exists(0, $diff_array_rls[$fac_id])) {
                                                $firlst = $diff_array_rls[$fac_id][0];
                                                if (array_key_exists($firlst - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"]) && $rls_flg == 0) {
                                                            for ($x = $this->data["rls_max_duty"] + 2; $x >= $this->data["rls_max_duty"]; $x--) {
                                                                if ($rls_flg == 0 && count($diff_array_rls[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt .= $txt_ctr . ")(Firlst) Unset-->" . $asKey . "(" . count($diff_array_rls[$asVal]) . ") Set--->" . $rls_id_name_pair[$fac_id] . "(" . count($diff_array_rls[$fac_id]) . ")<br>";
                                                                    $master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"][$rls_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rls[$fac_id][] = $firlst - $i;
                                                                    $rls_shortage[$fac_id]++;
                                                                    asort($diff_array_rls[$fac_id]);
                                                                    $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                                                    unset($diff_array_rls[$asVal][array_search($firlst - $i, $diff_array_rls[$asVal])]);
                                                                    asort($diff_array_rls[$asVal]);
                                                                    $diff_array_rls[$asVal] = array_values($diff_array_rls[$asVal]);
                                                                    $rls_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$firlst - $i]->date)][1][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $rls_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if ($rls_flg == 0 && $req > 0) {
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$rls_flg=0;
                                        if ($req > 0 && $rls_flg == 0) {
                                            asort($diff_array_rls[$fac_id]);
                                            if (array_key_exists(count($diff_array_rls[$fac_id]) - 1, $diff_array_rls[$fac_id])) {
                                                $last = $diff_array_rls[$fac_id][count($diff_array_rls[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"]) && $rls_flg == 0) {
                                                            for ($x = $this->data["rls_max_duty"] + 2; $x >= $this->data["rls_max_duty"]; $x--) {
                                                                if ($rls_flg == 0 && count($diff_array_rls[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt .= $txt_ctr . ")(Last) Unset-->" . $asKey . "(" . count($diff_array_rls[$asVal]) . ") Set--->" . $rls_id_name_pair[$fac_id] . "(" . count($diff_array_rls[$fac_id]) . ")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"][$rls_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_rls[$fac_id][] = $last + $i;
                                                                    $rls_shortage[$fac_id]++;
                                                                    asort($diff_array_rls[$fac_id]);
                                                                    $diff_array_rls[$fac_id] = array_values($diff_array_rls[$fac_id]);
                                                                    unset($diff_array_rls[$asVal][array_search($last + $i, $diff_array_rls[$asVal])]);
                                                                    $diff_array_rls[$asVal] = array_values($diff_array_rls[$asVal]);
                                                                    asort($diff_array_rls[$asVal]);
                                                                    $rls_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][1][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $rls_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }


                            }
                        }
                    }
                }


                $max_arr = array();
                $diff_array_rls = array();
                $counter = 1;
                $gap_str_rls = "";
                $duty_arr_rls = array();
                foreach ($RLS as $rlskey => $rlsval) {

                    if (!array_key_exists($rlsval->id, $diff_array_rls))
                        $diff_array_rls[$rlsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][0]["m3"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][0]["m4"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][1]["a3"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][1][1]["a4"] as $asKey => $asVal) {
                            if ($rlsval->id == $asVal) {
                                $diff_array_rls[$rlsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_rls[$rlsval->id]);
                    $diff_array_rls[$rlsval->id] = array_values($diff_array_rls[$rlsval->id]);
                    for ($i = 0; $i < count($diff_array_rls[$rlsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_rls[$rlsval->id][$i] - $diff_array_rls[$rlsval->id][$i + 1]);
                        if ($max < $dif) {
                            $max = $dif;
                        }
                    }

                    $max_arr[$rlsval->id] = $max;


                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_rls .= "<tr><td>{$counter}</td><td>{$rlsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }


                }


                $sh_cnt = 0;
                $duty_arr_rls = array();
                foreach ($RLS as $rlsval) {
                    $rls_id_name_pair[$rlsval->id] = $rlsval->name;
                    asort($diff_array_rls[$rlsval->id]);
                    $diff_array_rls[$rlsval->id] = array_values($diff_array_rls[$rlsval->id]);
                    if (!array_key_exists(count($diff_array_rls[$rlsval->id]), $duty_arr_rls)) {
                        $duty_arr_rls[count($diff_array_rls[$rlsval->id])] = array();
                    }

                    $duty_arr_rls[count($diff_array_rls[$rlsval->id])][] = $rlsval->id;
                    $sh_cnt += $rls_shortage[$rlsval->id];
                }

                $duty_ctr_str_rls = "";
                $rls_sum_duty = 0;
                foreach ($duty_arr_rls as $key => $val) {
                    $ct = count($val);
                    $duty_ctr_str_rls .= "<tr><td>{$ct}</td><td>{$key}</td></tr>";
                    $rls_sum_duty += $ct * $key;
                }
                $duty_ctr_str_rls .= "<tr><td>Total</td><td>{$rls_sum_duty}</td></tr>";
                if ($rls_sum_duty != $this->data["rls_count"]) {
                    $duty_ctr_str_rls .= "<tr  style='background:red;' class='blink' ><td>Difference</td><td>{($this->data['rls_count']-$rls_sum_duty)}</td></tr>";
                }

                if ($counter + count($duty_arr_rls) <= $sum_min) {
                    $sum_min = $counter + count($duty_arr_rls);
                    //$final_arr = array($master, $gap_str_rls, $duty_ctr_str_rls, count($duty_arr_rls), $counter, $sum_min,$c_arr[0],$c_arr[1],$c_arr[2]);
                    $to_test .= $rls_one . " " . $rls_two . " " . $rls_three . " " . $rls_four . " -> " . $sum_min . "<br>";
                }

                foreach ($a4_rls_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][1][1]["a3"] as $k => $v) {
                        if ($ctr != $this->data["a4_rls_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][1][1]["a4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][1][1]["a3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach ($m4_rls_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][1][0]["m3"] as $k => $v) {
                        if ($ctr != $this->data["m4_rls_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][1][0]["m4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][1][0]["m3"][$k]);
                            $ctr++;
                        }
                    }
                }


            }

//-------------------------------------------------------DS--------------------------------------------------------------
            if ($req_flag == "ds" || $gen_flag) {
                $ds_allowed = array();
                $ds_shortage = array();
                $ds_last = array();

                $allocation = 0;
                $ds_total_duty = 0;
                $ds_index = 0;

                $ds_pri_fac = array();
                $ds_ex_fac = array();
                foreach ($DS as $ds_rand) {
                    if (!array_key_exists($ds_rand->id, $ex_dates)) {
                        $ex_dates[$ds_rand->id] = array();
                    } else {
                        $ds_ex_fac[$ds_rand->id] = $ds_rand->id;
                    }
                    $ds_allowed[$ds_rand->id] = 0;


                    if ($ds_rand->priority && $ds_priority_duty >= 1 && $ds_priority_duty < $this->data["ds_max_duty"]) {
                        $ds_max_duty = $ds_priority_duty;
                        $ds_pri_fac[$ds_rand->id] = $ds_priority_duty;
                    } else
                        $ds_max_duty = $this->data["ds_max_duty"];
                    $duty_counter = 0;
                    $mr_counter = 0;
                    $aft_counter = 0;
                    $ds_index++;
                    $aft_share = round($ds_max_duty * 25 / 100);
                    $mr_share = $ds_max_duty - $aft_share;
                    foreach ($td as $tdKey => $time_data) {

                        $m3_flag = true;
                        $a3_flag = true;
//							if($duty_counter != $ds_max_duty && $mr_share!=0){
//								if($m3_ds_count[$mr_counter] != 0 && $duty_counter != $ds_max_duty){
//									$master[$this->getDateTag($time_data->date)][2][0]["m3"][$ds_rand->name] = $ds_rand->id;
//									$duty_counter++;
//									$m3_ds_count[$mr_counter]--;
//									$m3_flag=false;
//									$ds_total_duty++;
//									$allocation++;
//									$mr_share--;
//									if(!array_key_exists($ds_rand->id,$ds_last))
//										$ds_last[$ds_rand->id] = $tdKey;
//
//								}
//							}
//
//							if($duty_counter != $ds_max_duty && $aft_share!=0){
//
//
//									if($a3_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty){
//										$master[$this->getDateTag($time_data->date)][2][1]["a3"][$ds_rand->name] = $ds_rand->id;
//										$duty_counter++;
//										$a3_ds_count[$aft_counter]--;
//										$a3_flag=false;
//										$ds_total_duty++;
//										$allocation++;
//										$aft_share--;
//										if(!array_key_exists($ds_rand->id,$ds_last))
//											$ds_last[$ds_rand->id] = $tdKey;
//
//									}
//
//							}

                        if ($duty_counter != $ds_max_duty && $m3_flag && !in_array($time_data->db_date, $ex_dates[$ds_rand->id])) {
                            if ($m3_ds_count[$mr_counter] != 0 && $duty_counter != $ds_max_duty) {
                                $master[$this->getDateTag($time_data->date)][2][0]["m3"][$ds_rand->name] = $ds_rand->id;
                                $duty_counter++;
                                $m3_ds_count[$mr_counter]--;
                                $ds_total_duty++;
                                $allocation++;
                                $mr_share--;
                                if (!array_key_exists($ds_rand->id, $ds_last))
                                    $ds_last[$ds_rand->id] = $tdKey;

                            }
                        }

                        if ($duty_counter != $ds_max_duty && $a3_flag && !in_array($time_data->db_date, $ex_dates[$ds_rand->id])) {
                            if ($a3_ds_count[$aft_counter] != 0 && $duty_counter != $ds_max_duty) {
                                $master[$this->getDateTag($time_data->date)][2][1]["a3"][$ds_rand->name] = $ds_rand->id;
                                $duty_counter++;
                                $a3_ds_count[$aft_counter]--;
                                $ds_total_duty++;
                                $allocation++;
                                $aft_share--;
                                if (!array_key_exists($ds_rand->id, $ds_last))
                                    $ds_last[$ds_rand->id] = $tdKey;

                            }

                        }

                        $mr_counter++;
                        $aft_counter++;
                    }

                    $ds_shortage[$ds_rand->id] = $duty_counter;
                    if (!array_key_exists($ds_rand->id, $ds_last)) {
                        $ds_last[$ds_rand->id] = count($td);
                    }
                    if ($duty_counter <= $this->data["ds_max_duty"] - 1 || in_array($ds_rand, $DS_pri))
                        $ds_allowed[$ds_rand->id] = 0;

                }


                foreach ($a3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][2][0]["m3"], $master[$this->getDateTag($td[$j]->date)][2][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][2][1]["a3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $ds_shortage[$bval] <= $this->data["ds_max_duty"] && !array_key_exists($bval, $ds_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][2][1]["a3"][$bkey] = $bval;
                                            $ds_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $a3_ds_count[$key]--;
                                            $ds_allowed[$bval]++;

                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($m3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            for ($j = $key - 1; $j > 0; $j--) {
                                if (array_key_exists($j, $td)) {
                                    foreach (array_merge($master[$this->getDateTag($td[$j]->date)][2][0]["m3"], $master[$this->getDateTag($td[$j]->date)][2][1]["a3"]) as $bkey => $bval) {
                                        $bflag = false;
                                        foreach ($master[$this->getDateTag($td[$key]->date)][2][0]["m3"] as $ckey => $cval) {
                                            if ($bval == $cval) {
                                                $bflag = true;
                                            }
                                        }
                                        if (!$bflag && $i < $val && $ds_shortage[$bval] <= $this->data["ds_max_duty"] && !array_key_exists($bval, $ds_ex_fac)) {
                                            $master[$this->getDateTag($td[$key]->date)][2][0]["m3"][$bkey] = $bval;
                                            $ds_shortage[$bval]++;
                                            $i++;
                                            //echo $bkey."------------->Key-------->".$key."<br>";
                                            $m3_ds_count[$key]--;
                                            $ds_allowed[$bval]++;


                                        }
                                    }
                                }
                            }

                        }
                    }
                }


                foreach ($a3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][2][1]["a3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                foreach ($m3_ds_count as $key => $val) {
                    if ($val != 0) {
                        for ($i = 0; $i < $val; $i++) {
                            $master[$this->getDateTag($td[$key]->date)][2][0]["m3"]["TO BE ADDED {$i}"] = -1;
                        }
                    }
                }


                $to_test = "";
                $final_arr = array($master, $gap_str_ds, $duty_ctr_str_ds);
                $sum_min = PHP_INT_MAX;
                $master_copy = $master;
                $ds_shortage_copy = $ds_shortage;
                $ds_allowed_cpy = $ds_allowed;
                $duty_ctr_str_ds = "";
                $gap_str_ds = "";
                set_time_limit(0);

                foreach ($DS as $allowKey => $alloVal) {
                    if ($ds_shortage[$alloVal->id] != 0) {
                        if (($allowKey+1) % ($ds_four) != 0)
                            $ds_allowed[$alloVal->id] = $ds_allowed[$alloVal->id] + $ds_one;
                        else
                            $ds_allowed[$alloVal->id] = $ds_allowed[$alloVal->id] + $ds_two;
                    } else {
                        $ds_allowed[$alloVal->id] = 0;
                    }
                }


                foreach (array_reverse($DS) as $dskey => $dsp) {
                    if ($ds_shortage[$dsp->id] <= $this->data["ds_max_duty"] - $ds_three && !array_key_exists($dsp->id, $ds_ex_fac)) {
                        $pos = 1;

                        if (array_key_exists($dsp->id, $ds_pri_fac))
                            $req = $ds_pri_fac[$dsp->id] - $ds_shortage[$dsp->id];
                        else {
                            $req = $this->data["ds_max_duty"] - $ds_shortage[$dsp->id];
                            if ($req == $this->data["ds_max_duty"]) {
                                //$req = $this->data["ds_max_duty"] - 1;
                            }
                        }


                        $req_counter = 0;

                        while (array_key_exists($ds_last[$dsp->id] - $pos, $td) && $req_counter != $req) {
                            $got = 0;

                            $date_tag = $td[$ds_last[$dsp->id] - $pos]->date;


                            foreach (array_merge($master[$this->getDateTag($date_tag)][2][0]["m3"], $master[$this->getDateTag($date_tag)][2][1]["a3"]) as $pt => $idVal) {
                                if ($got == 0 && $ds_allowed[$idVal] != 0 && !isset($master[$this->getDateTag($date_tag)][2][0]["m3"][$dsp->name]) && !array_key_exists($idVal, $ds_ex_fac)) {

                                    for ($j = $this->data["ds_max_duty"] + 4; $j > 0; $j--) {
                                        if ($got == 0)
                                            if (array_key_exists($idVal, $ds_shortage) && !array_key_exists($dsp->name, $master[$this->getDateTag($date_tag)][2][0]["m3"])) {
                                                if ($ds_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $ds_allowed) && $ds_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][2][0]["m3"])) {
                                                        $master[$this->getDateTag($date_tag)][2][0]["m3"][$dsp->name] = $dsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][2][0]["m3"][$pt]);
                                                        $ds_shortage[$idVal]--;
                                                        $ds_shortage[$dsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt."---->".$dsp->name."------->".$date_tag."<br>";
                                                        $ds_allowed[$idVal]--;
                                                        $got++;
                                                    }

                                                }
                                            }

                                        if ($got == 0)
                                            if (array_key_exists($idVal, $ds_shortage) && !array_key_exists($dsp->name, $master[$this->getDateTag($date_tag)][2][1]["a3"])) {
                                                if ($ds_shortage[$idVal] == $j && $got == 0 && array_key_exists($idVal, $ds_allowed) && $ds_allowed[$idVal] != 0) {

                                                    if (array_key_exists($pt, $master[$this->getDateTag($date_tag)][2][1]["a3"])) {
                                                        $master[$this->getDateTag($date_tag)][2][1]["a3"][$dsp->name] = $dsp->id;
                                                        unset($master[$this->getDateTag($date_tag)][2][1]["a3"][$pt]);
                                                        $ds_shortage[$idVal]--;
                                                        $ds_shortage[$dsp->id]++;
                                                        $req_counter++;
                                                        //echo $pt . "---->" . $dsp->name . "------->" . $date_tag . "<br>";
                                                        $ds_allowed[$idVal]--;
                                                        $got++;
                                                    }
                                                }
                                            }
                                    }
                                }
                            }


                            if ($got == 0) {
                                //echo "<h3>Skipped {$date_tag}</h3><br>";
                            }
                            $pos++;
                        }
                    }

                }


                $max_arr = array();
                $diff_array_ds = array();
                $counter = 1;
                $gap_str_ds = "";
                $duty_arr_ds = array();
                foreach ($DS as $dskey => $dsval) {

                    if (!array_key_exists($dsval->id, $diff_array_ds))
                        $diff_array_ds[$dsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][0]["m3"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][0]["m4"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][1]["a3"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][1]["a4"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_ds[$dsval->id]);
                    $diff_array_ds[$dsval->id] = array_values($diff_array_ds[$dsval->id]);
                    for ($i = 0; $i < count($diff_array_ds[$dsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_ds[$dsval->id][$i] - $diff_array_ds[$dsval->id][$i + 1]);
                        if ($max < $dif) {
                            $max = $dif;
                        }
                    }

                    if (!array_key_exists($dsval->id, $ds_ex_fac))
                        $max_arr[$dsval->id] = $max;
                    else
                        $max_arr[$dsval->id] = 0;

                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_ds .= "<tr><td>{$counter}</td><td>{$dsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }


                }

                $check_fg = "";
                foreach ($DS as $dskey => $dsval) {
                    $last = 0;
                    $max = $max_arr[$dsval->id];
                    if ($max - 1 >= 3)
                        for ($i = 0; $i < count($diff_array_ds[$dsval->id]) - 1; $i++) {
                            if (array_key_exists($i, $diff_array_ds[$dsval->id]) && array_key_exists($i + 1, $diff_array_ds[$dsval->id]))
                                $dif = abs($diff_array_ds[$dsval->id][$i] - $diff_array_ds[$dsval->id][$i + 1]);
                            else
                                $dif = 0;

                            if ($max == $dif) {
                                if ($i + 1 < ceil(count($diff_array_ds[$dsval->id]) / 2)) {
                                    $last = $i + 1;
                                    for ($j = $i; $j >= 0; $j--) {
                                        if (array_key_exists($j, $diff_array_ds[$dsval->id]))
                                            if (array_key_exists($diff_array_ds[$dsval->id][$j], $td)) {
                                                if (array_key_exists($j, $diff_array_ds[$dsval->id])) {
                                                    if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                        //														$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"]["TO BE ADDED ".$dsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$dsval->name]);
                                                        $ds_shortage[$dsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }


                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"]["TO BE ADDED " . $dsval->name] = -1;
                                                        }
                                                        unset($diff_array_ds[$dsval->id][$j]);
//

                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_ds[$dsval->id])) {
                                                    if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"]["TO BE ADDED ".$dsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$dsval->name]);
                                                        $ds_shortage[$dsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"]["TO BE ADDED " . $dsval->name] = -1;
                                                        }
                                                        unset($diff_array_ds[$dsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_ds[$dsval->id])) {
                                                    if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"]["TO BE ADDED ".$dsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$dsval->name]);
                                                        $ds_shortage[$dsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"]["TO BE ADDED " . $dsval->name] = -1;
                                                        }
                                                        unset($diff_array_ds[$dsval->id][$j]);
                                                    }
                                                }
                                                if (array_key_exists($j, $diff_array_ds[$dsval->id])) {
                                                    if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                        //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"]["TO BE ADDED ".$dsval->name]=-1;
                                                        unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$dsval->name]);
                                                        $ds_shortage[$dsval->id]--;
                                                        $gt = 0;
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        if ($gt == 0) {
                                                            for ($m = 0; $m <= 2; $m++) {
                                                                if ($gt == 0) {
                                                                    if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }

                                                                        if ($gt == 0) {
                                                                            foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                                if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                    if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                        for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                            if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                                $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                                $ds_shortage[$fVal]++;
                                                                                                $gt++;
                                                                                                if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                    $diff_array_ds[$fVal] = array();
                                                                                                $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }


                                                        if ($gt == 0) {
                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"]["TO BE ADDED " . $dsval->name] = -1;
                                                        }
                                                        unset($diff_array_ds[$dsval->id][$j]);
                                                    }
                                                }
                                            }
                                    }
                                } else {
                                    for ($j = $i + 1; $j < count($diff_array_ds[$dsval->id]); $j++) {
                                        if (array_key_exists($diff_array_ds[$dsval->id][$j], $td)) {
                                            if (array_key_exists($j, $diff_array_ds[$dsval->id]))
                                                if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
//														$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"]["TO BE ADDED ".$dsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$dsval->name]);
                                                    $ds_shortage[$dsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }


                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }


                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m3"]["TO BE ADDED " . $dsval->name] = -1;
                                                    }
                                                    unset($diff_array_ds[$dsval->id][$j]);

                                                }
                                            if (array_key_exists($j, $diff_array_ds[$dsval->id]))
                                                if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"]["TO BE ADDED ".$dsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$dsval->name]);
                                                    $ds_shortage[$dsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][0]["m4"]["TO BE ADDED " . $dsval->name] = -1;
                                                    }
                                                    unset($diff_array_ds[$dsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_ds[$dsval->id]))
                                                if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"]["TO BE ADDED ".$dsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$dsval->name]);
                                                    $ds_shortage[$dsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a3"]["TO BE ADDED " . $dsval->name] = -1;
                                                    }
                                                    unset($diff_array_ds[$dsval->id][$j]);
                                                }
                                            if (array_key_exists($j, $diff_array_ds[$dsval->id]))
                                                if (array_key_exists($dsval->name, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                    //$master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"]["TO BE ADDED ".$dsval->name]=-1;
                                                    unset($master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$dsval->name]);
                                                    $ds_shortage[$dsval->id]--;
                                                    $gt = 0;
                                                    for ($m = 0; $m <= 2; $m++) {
                                                        if ($gt == 0) {
                                                            if (array_key_exists(($diff_array_ds[$dsval->id][$j]) - $m, $td)) {
                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }

                                                                if ($gt == 0) {
                                                                    foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) - $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                        if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                            if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                    if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                        $ds_shortage[$fVal]++;
                                                                                        $gt++;
                                                                                        if (!array_key_exists($fVal, $diff_array_ds))
                                                                                            $diff_array_ds[$fVal] = array();
                                                                                        $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if ($gt == 0) {
                                                        for ($m = 0; $m <= 2; $m++) {
                                                            if ($gt == 0) {
                                                                if (array_key_exists(($diff_array_ds[$dsval->id][$j]) + $m, $td)) {
                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][0]["m4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a3"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }

                                                                    if ($gt == 0) {
                                                                        foreach ($master[$this->getDateTag($td[($diff_array_ds[$dsval->id][$j]) + $m]->date)][2][1]["a4"] as $fKey => $fVal)
                                                                            if (array_key_exists($fVal, $ds_shortage) && !array_key_exists($fVal, $ds_ex_fac))
                                                                                if (true || array_key_exists($fVal, $diff_array_ds))
                                                                                    for ($x = 0; $x <= $this->data["ds_max_duty"] + 1; $x++)
                                                                                        if ($gt == 0 && $ds_shortage[$fVal] == $x && !array_key_exists($fKey, $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"])) {
                                                                                            $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"][$fKey] = $fVal;
                                                                                            $ds_shortage[$fVal]++;
                                                                                            $gt++;
                                                                                            if (!array_key_exists($fVal, $diff_array_ds))
                                                                                                $diff_array_ds[$fVal] = array();
                                                                                            $diff_array_ds[$fVal][] = $diff_array_ds[$dsval->id][$j];
                                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }


                                                    if ($gt == 0) {
                                                        $master[$this->getDateTag($td[$diff_array_ds[$dsval->id][$j]]->date)][2][1]["a4"]["TO BE ADDED " . $dsval->name] = -1;
                                                    }
                                                    unset($diff_array_ds[$dsval->id][$j]);
                                                }
                                        }
                                    }
                                }


                            }

                        }
                }

                $sh_cnt = 0;
                $ds_id_name_pair = array();
                foreach ($DS as $dsval) {
                    $ds_id_name_pair[$dsval->id] = $dsval->name;
                    asort($diff_array_ds[$dsval->id]);
                    $diff_array_ds[$dsval->id] = array_values($diff_array_ds[$dsval->id]);
                    if (!array_key_exists(count($diff_array_ds[$dsval->id]), $duty_arr_ds)) {
                        $duty_arr_ds[count($diff_array_ds[$dsval->id])] = array();
                    }

                    $duty_arr_ds[count($diff_array_ds[$dsval->id])][] = $dsval->id;
                    $sh_cnt += $ds_shortage[$dsval->id];
                }

                $ds_fac_duty = array();
                foreach ($duty_arr_ds as $key => $val) {
                    $cnt = count($val);
                    $ds_fac_duty[$key] = $cnt;
                }
                ksort($ds_fac_duty);

                $txt = "";
                $txt_ctr = 0;
                foreach ($ds_fac_duty as $dty_cnt => $num_fac) {
                    foreach ($duty_arr_ds[$dty_cnt] as $fac_id) {
                        if (count($diff_array_ds[$fac_id]) < $this->data["ds_max_duty"] && !array_key_exists($fac_id, $ds_ex_fac)) {
                            $req = $this->data["ds_max_duty"] - count($diff_array_ds[$fac_id]) - 1;
                            $ds_flg = 0;
                            for ($b = 0; $b < $req; $b++) {
                                $ds_flg = 0;
                                if ($ds_flg == 0 && $req > 0) {
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$ds_flg=0;
                                        if ($req > 0 && $ds_flg == 0) {
                                            asort($diff_array_ds[$fac_id]);
                                            $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                            if (array_key_exists(0, $diff_array_ds[$fac_id])) {
                                                $fidst = $diff_array_ds[$fac_id][0];
                                                if (array_key_exists($fidst - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"]) && $ds_flg == 0) {
                                                            for ($x = $this->data["ds_max_duty"] + 2; $x >= $this->data["ds_max_duty"]; $x--) {
                                                                if ($ds_flg == 0 && count($diff_array_ds[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt .= $txt_ctr . ")(Fidst) Unset-->" . $asKey . "(" . count($diff_array_ds[$asVal]) . ") Set--->" . $ds_id_name_pair[$fac_id] . "(" . count($diff_array_ds[$fac_id]) . ")<br>";
                                                                    $master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"][$ds_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_ds[$fac_id][] = $fidst - $i;
                                                                    $ds_shortage[$fac_id]++;
                                                                    asort($diff_array_ds[$fac_id]);
                                                                    $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                                                    unset($diff_array_ds[$asVal][array_search($fidst - $i, $diff_array_ds[$asVal])]);
                                                                    asort($diff_array_ds[$asVal]);
                                                                    $diff_array_ds[$asVal] = array_values($diff_array_ds[$asVal]);
                                                                    $ds_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$fidst - $i]->date)][2][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $ds_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if ($ds_flg == 0 && $req > 0) {
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$ds_flg=0;
                                        if ($req > 0 && $ds_flg == 0) {
                                            asort($diff_array_ds[$fac_id]);
                                            if (array_key_exists(count($diff_array_ds[$fac_id]) - 1, $diff_array_ds[$fac_id])) {
                                                $last = $diff_array_ds[$fac_id][count($diff_array_ds[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"]) && $ds_flg == 0) {
                                                            for ($x = $this->data["ds_max_duty"] + 2; $x >= $this->data["ds_max_duty"]; $x--) {
                                                                if ($ds_flg == 0 && count($diff_array_ds[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"])) {
                                                                    $txt_ctr++;
                                                                    $txt .= $txt_ctr . ")(Last) Unset-->" . $asKey . "(" . count($diff_array_ds[$asVal]) . ") Set--->" . $ds_id_name_pair[$fac_id] . "(" . count($diff_array_ds[$fac_id]) . ")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"][$ds_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_ds[$fac_id][] = $last + $i;
                                                                    $ds_shortage[$fac_id]++;
                                                                    asort($diff_array_ds[$fac_id]);
                                                                    $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                                                    unset($diff_array_ds[$asVal][array_search($last + $i, $diff_array_ds[$asVal])]);
                                                                    $diff_array_ds[$asVal] = array_values($diff_array_ds[$asVal]);
                                                                    asort($diff_array_ds[$asVal]);
                                                                    $ds_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][2][0]["m3"][$asKey]);
                                                                    $req--;
                                                                    $ds_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if ($ds_flg == 0 && $req > 0) {
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$ds_flg=0;
                                        if ($req > 0 && $ds_flg == 0) {
                                            asort($diff_array_ds[$fac_id]);
                                            $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                            if (array_key_exists(0, $diff_array_ds[$fac_id])) {
                                                $fidst = $diff_array_ds[$fac_id][0];
                                                if (array_key_exists($fidst - $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"]) && $ds_flg == 0) {
                                                            for ($x = $this->data["ds_max_duty"] + 2; $x >= $this->data["ds_max_duty"]; $x--) {
                                                                if ($ds_flg == 0 && count($diff_array_ds[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt .= $txt_ctr . ")(Fidst) Unset-->" . $asKey . "(" . count($diff_array_ds[$asVal]) . ") Set--->" . $ds_id_name_pair[$fac_id] . "(" . count($diff_array_ds[$fac_id]) . ")<br>";
                                                                    $master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"][$ds_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_ds[$fac_id][] = $fidst - $i;
                                                                    $ds_shortage[$fac_id]++;
                                                                    asort($diff_array_ds[$fac_id]);
                                                                    $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                                                    unset($diff_array_ds[$asVal][array_search($fidst - $i, $diff_array_ds[$asVal])]);
                                                                    asort($diff_array_ds[$asVal]);
                                                                    $diff_array_ds[$asVal] = array_values($diff_array_ds[$asVal]);
                                                                    $ds_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$fidst - $i]->date)][2][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $ds_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if ($ds_flg == 0 && $req > 0) {
                                    for ($i = 0; $i <= 2; $i++) {
                                        //$ds_flg=0;
                                        if ($req > 0 && $ds_flg == 0) {
                                            asort($diff_array_ds[$fac_id]);
                                            if (array_key_exists(count($diff_array_ds[$fac_id]) - 1, $diff_array_ds[$fac_id])) {
                                                $last = $diff_array_ds[$fac_id][count($diff_array_ds[$fac_id]) - 1];
                                                if (array_key_exists($last + $i, $td)) {
                                                    foreach ($master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"] as $asKey => $asVal) {
                                                        if (!in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"]) && $ds_flg == 0) {
                                                            for ($x = $this->data["ds_max_duty"] + 2; $x >= $this->data["ds_max_duty"]; $x--) {
                                                                if ($ds_flg == 0 && count($diff_array_ds[$asVal]) == $x && $req > 0 && !in_array($fac_id, $master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"])) {
                                                                    $txt_ctr++;
                                                                    $txt .= $txt_ctr . ")(Last) Unset-->" . $asKey . "(" . count($diff_array_ds[$asVal]) . ") Set--->" . $ds_id_name_pair[$fac_id] . "(" . count($diff_array_ds[$fac_id]) . ")<br>";
                                                                    $master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"][$ds_id_name_pair[$fac_id]] = $fac_id;
                                                                    $diff_array_ds[$fac_id][] = $last + $i;
                                                                    $ds_shortage[$fac_id]++;
                                                                    asort($diff_array_ds[$fac_id]);
                                                                    $diff_array_ds[$fac_id] = array_values($diff_array_ds[$fac_id]);
                                                                    unset($diff_array_ds[$asVal][array_search($last + $i, $diff_array_ds[$asVal])]);
                                                                    $diff_array_ds[$asVal] = array_values($diff_array_ds[$asVal]);
                                                                    asort($diff_array_ds[$asVal]);
                                                                    $ds_shortage[$asVal]--;
                                                                    unset($master[$this->getDateTag($td[$last + $i]->date)][2][1]["a3"][$asKey]);
                                                                    $req--;
                                                                    $ds_flg++;


                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }


                            }
                        }
                    }
                }


                $max_arr = array();
                $diff_array_ds = array();
                $counter = 1;
                $gap_str_ds = "";
                $duty_arr_ds = array();
                foreach ($DS as $dskey => $dsval) {

                    if (!array_key_exists($dsval->id, $diff_array_ds))
                        $diff_array_ds[$dsval->id] = array();
                    foreach ($td as $tdKey => $tdVal) {
                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][0]["m3"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][0]["m4"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][1]["a3"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }

                        foreach ($master[$this->getDateTag($td[$tdKey]->date)][2][1]["a4"] as $asKey => $asVal) {
                            if ($dsval->id == $asVal) {
                                $diff_array_ds[$dsval->id][] = $tdKey;
                            }
                        }
                    }
                    $max = 0;
                    asort($diff_array_ds[$dsval->id]);
                    $diff_array_ds[$dsval->id] = array_values($diff_array_ds[$dsval->id]);
                    for ($i = 0; $i < count($diff_array_ds[$dsval->id]) - 1; $i++) {
                        $dif = abs($diff_array_ds[$dsval->id][$i] - $diff_array_ds[$dsval->id][$i + 1]);
                        if ($max < $dif) {
                            $max = $dif;
                        }
                    }

                    $max_arr[$dsval->id] = $max;


                    if ($max != 0)
                        $max--;
                    if ($max >= 3) {
                        $gap_str_ds .= "<tr><td>{$counter}</td><td>{$dsval->name}</td><td>{$max}</td></tr>";
                        $counter++;

                    }


                }


                $sh_cnt = 0;
                $duty_arr_ds = array();
                foreach ($DS as $dsval) {
                    $ds_id_name_pair[$dsval->id] = $dsval->name;
                    asort($diff_array_ds[$dsval->id]);
                    $diff_array_ds[$dsval->id] = array_values($diff_array_ds[$dsval->id]);
                    if (!array_key_exists(count($diff_array_ds[$dsval->id]), $duty_arr_ds)) {
                        $duty_arr_ds[count($diff_array_ds[$dsval->id])] = array();
                    }

                    $duty_arr_ds[count($diff_array_ds[$dsval->id])][] = $dsval->id;
                    $sh_cnt += $ds_shortage[$dsval->id];
                }

                $duty_ctr_str_ds = "";
                $ds_sum_duty = 0;
                foreach ($duty_arr_ds as $key => $val) {
                    $ct = count($val);
                    $duty_ctr_str_ds .= "<tr><td>{$ct}</td><td>{$key}</td></tr>";
                    $ds_sum_duty += $ct * $key;
                }
                $duty_ctr_str_ds .= "<tr><td>Total</td><td>{$ds_sum_duty}</td></tr>";
                if ($ds_sum_duty != $this->data["ds_count"]) {
                    $duty_ctr_str_ds .= "<tr  style='background:red;' class='blink' ><td>Difference</td><td>{($this->data['ds_count']-$ds_sum_duty)}</td></tr>";
                }

                if ($counter + count($duty_arr_ds) <= $sum_min) {
                    $sum_min = $counter + count($duty_arr_ds);
                    //$final_arr = array($master, $gap_str_ds, $duty_ctr_str_ds, count($duty_arr_ds), $counter, $sum_min,$c_arr[0],$c_arr[1],$c_arr[2]);
                    $to_test .= $ds_one . " " . $ds_two . " " . $ds_three . " " . $ds_four . " -> " . $sum_min . "<br>";
                }

                foreach ($a4_ds_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][2][1]["a3"] as $k => $v) {
                        if ($ctr != $this->data["a4_ds_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][2][1]["a4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][2][1]["a3"][$k]);
                            $ctr++;
                        }
                    }
                }

                foreach ($m4_ds_count as $key => $val) {
                    $ctr = 0;
                    foreach ($master[$this->getDateTag($td[$key]->date)][2][0]["m3"] as $k => $v) {
                        if ($ctr != $this->data["m4_ds_count"][$key]) {
                            $master[$this->getDateTag($td[$key]->date)][2][0]["m4"][$k] = $v;
                            unset($master[$this->getDateTag($td[$key]->date)][2][0]["m3"][$k]);
                            $ctr++;
                        }
                    }
                }


            }
            $this->data["populate"] = $master;

            $this->data["m3_str"] = $m3_str;
            $this->data["m4_str"] = $m4_str;
            $this->data["a3_str"] = $a3_str;
            $this->data["a4_str"] = $a4_str;
            
            if ($gen_flag) {
                $str = $this->load->view("assign_duty_ajax", $this->data, true);
            }
            //echo "<pre>".print_r($master,true)."</pre>";
            echo json_encode(array($gap_str_rs, $duty_ctr_str_rs, $gap_str_rls, $duty_ctr_str_rls, $gap_str_ds, $duty_ctr_str_ds, $str));
        }

    }

    public function att_save(){
        $db_name = date("M_jS_Y");
        $this->master_db->runSQL("DROP TABLE IF EXISTS {$db_name}");
        $sql = "CREATE TABLE IF NOT EXISTS `{$db_name}` ( `id` INT NOT NULL AUTO_INCREMENT , `std_id` INT NOT NULL , `fac_id` INT NOT NULL , PRIMARY KEY (`id`))";
        $this->master_db->runSQL($sql);
        $attended = array();

        if(is_array($this->input->post("checked_list")) && count($this->input->post("checked_list"))>=1){
            foreach ($this->input->post("checked_list") as $val) {
                $this->master_db->insertRecord($db_name, array("std_id" => $val, "fac_id" => $this->data['detail'][0]->id));
                $name_res = $this->master_db->getRecords("student",array("id"=>$val));
                $attended[] = $name_res[0]->name;
            }

            $this->data["names"] = $attended;
            $this->session->set_flashdata('message', "<div class='alert alert-success alert-dismissable'><button class='close' aria-hidden='true' data-dismiss='alert' type='button'>&times;</button>Success..!!</div>");
            $this->load->view("attended_stds",$this->data);

        } else {
            $this->session->set_flashdata('message', "<div class='alert alert-danger alert-dismissable'><button class='close' aria-hidden='true' data-dismiss='alert' type='button'>&times;</button>No data to save..!!</div>");
            redirect("master/attendance");
        }

    }






}
